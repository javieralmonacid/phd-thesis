%   DOCUMENT CLASS  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Use the `sfuthesis` class to format your thesis.
%
%   For more information about thesis formatting requirements, go to
%   http://www.lib.sfu.ca/help/publish/thesis or ask a thesis advisor at the
%   SFU Research Commons.


\documentclass{sfuthesis}



%   DOCUMENT METADATA  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Fill in the following information for the title page and declaration of
%   committee page. Please review the Declaration of Committee page
%   instructions on the library's thesis website before completing this page:
%   https://www.lib.sfu.ca/help/publish/thesis/format/declaration-committee

%   Choose the \faculty entry below from the following list:
%
%       - Faculty of Applied Sciences
%       - Faculty of Arts and Social Sciences
%       - Beedie School of Business
%       - Faculty of Communication, Art and Technology
%       - Faculty of Education
%       - Faculty of Environment
%       - Faculty of Health Sciences
%       - Faculty of Science

\title{Computational strategies for the nonlinear elastodynamics of skeletal muscle tissue}
\thesistype{Thesis}
\author{Javier Alejandro Almonacid Paredes}
\previousdegrees{%
    M.Sc., Simon Fraser University, 2020\\
    B.Sc., Universidad de Concepci\'{o}n, 2015}
\degree{Doctor of Philosophy}
\department{Department of Mathematics}
\faculty{Faculty of Science}
\copyrightyear{2025}
\semester{Spring 2025}


%   You may include up to six keywords or phrases. Keywords should be separated
%   with semicolons. No punctuation at the end.
\keywords{thesis template; Simon Fraser University; \LaTeX; time travel paradoxes}

\committee{
    \chair{TBD}{Professor \\ Department of Mathematics}
    \member{Nilima Nigam}{Supervisor \\ Professor \\ Department of Mathematics}
    \member{James Wakeling}{Co-Supervisor\\ Professor \\ Department of Biomedical Physiology and Kinesiology}
    \member{TBD}{Internal Examiner \\ Professor \\ Department of Mathematics}
    \member{TBD}{External Examiner \\ Professor \\ Department of Quantum Fields \\ Mars University}
}



%   PACKAGES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Add any packages you need for your thesis here.
%   You don't need to call the following packages, which are already called in
%   the sfuthesis class file:
%
%   - appendix
%   - etoolbox
%   - fontenc
%   - geometry
%   - lmodern
%   - nowidow
%   - setspace
%   - tocloft
%
%   If you call one of the above packages (or one of their dependencies) with
%   options, you may get a "Option clash" LaTeX error. If you get this error,
%   you can fix it by removing your copy of \usepackage and passing the options
%   you need by adding
%
%       \PassOptionsToPackage{<options>}{<package>}
%
%   before \documentclass{sfuthesis}.
%
%   The following packages are a few suggestions you might find useful.
%
%   (1) amsmath and amssymb are essential if you have math in your thesis;
%       they provide useful commands like ``blackboard bold'' symbols and
%       environments for aligning equations.
%   (2) amsthm includes allows you to easily change the style and numbering of
%       theorems. It also provides an environment for proofs.
%   (3) graphicx allows you to add images with \includegraphics{filename}.
%   (4) hyperref turns your citations and cross-references into clickable
%       links, and adds metadata to the compiled PDF.
%   (5) pdfpages lets you import pages of external PDFs using the command
%       \includepdf{filename}. You will need to do this if your research
%       requires an Ethics Statement.
%

\usepackage{amsmath}                            % (1)
\usepackage{amssymb}                            % (1)
\usepackage{amsthm}                             % (2)
\usepackage{graphicx}                           % (3)
\graphicspath{{figs/}}
\usepackage{epstopdf}
\usepackage[pdfborder={0 0 0}]{hyperref}        % (4)
% \usepackage{pdfpages}                         % (5)
% ...
% ...
% ...
% ... add your own packages here!

\usepackage{background}
\backgroundsetup{
  position=current page.north,
  angle=0,
  nodeanchor=north,
  vshift=-10mm,
  opacity=1,
  scale=1.5,
  contents=Submitted for revision on \today
}

\usepackage{circuitikz}
\usetikzlibrary{patterns,
                hobby,
                decorations.pathmorphing,
                shapes.geometric}

\usepackage{makecell}
\usepackage[percent]{overpic}
\usepackage{comment}
\usepackage{scalerel}
\usepackage{siunitx}
\usepackage{bibentry}
\nobibliography*


%   OTHER CUSTOMIZATIONS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Add any packages you need for your thesis here. We've started you off with
%   a few suggestions.
%
%   (1) Use a single word space between sentences. If you disable this, you
%       will have to manually control spacing around abbreviations.
%   (2) Correct the capitalization of "Chapter" and "Section" if you use the
%       \autoref macro from the `hyperref` package.
%   (3) The LaTeX thesis template defaults to one-and-a-half line spacing. If
%       your supervisor prefers double-spacing, you can redefine the
%       \defaultspacing command.
%

\frenchspacing                                    % (1)
\renewcommand*{\chapterautorefname}{Chapter}      % (2)
\renewcommand*{\sectionautorefname}{Section}      % (2)
\renewcommand*{\subsectionautorefname}{Section}   % (2)
% \renewcommand{\defaultspacing}{\doublespacing}  % (3)
% ...
% ...
% ...
% ... add your own customizations here!

\usepackage{bm,bbm}
\usepackage{empheq}

%-----------------------------------------------
% Eliminate ugly boxes around references.
\usepackage{xcolor}
\hypersetup{
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}
%------------------------------------------------

\numberwithin{equation}{chapter}
\numberwithin{figure}{chapter}
\numberwithin{table}{chapter}


\newtheorem{objective}{Objective}
\renewcommand*{\theobjective}{\Alph{objective}}
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{remark}[theorem]{Remark}
\newtheorem{claim}[theorem]{Claim}

\theoremstyle{definition}
\newtheorem{definition}{Definition}[chapter]
\newtheorem{lemma}[definition]{Lemma}
\newtheorem{example}[definition]{Example}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  DEFINITIONS 
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\*#1{{\mathbf{#1}}} % bold letters!
\newcommand{\pder}[2]{\dfrac{\partial #1}{\partial #2}}
\newcommand{\Dder}[2]{\dfrac{\mathrm{D} #1}{\mathrm{D} #2}}
\newcommand{\der}[2]{\dfrac{d #1}{d #2}}
\newcommand{\dder}[2]{\dfrac{\mathrm{d} #1}{\mathrm{d} #2}}
\newcommand{\divs}[1]{{\mathrm{div} \, #1}}
\newcommand{\Divs}[1]{{\mathrm{Div} \, #1}}
\newcommand{\divt}[1]{{\bm{\mathrm{div}} \, #1}}
\newcommand{\Divt}[1]{{\bm{\mathrm{Div}} \, #1}}

\newcommand{\depsilon}{\dot{\varepsilon}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\B}{\mathcal{B}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\I}{{\bar{I}}}
\newcommand{\FF}{{\bm{\mathcal{F}}}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\T}{\top}
\renewcommand{\c}{\mathbbm{c}}
\renewcommand{\P}{\mathbb{P}}
\newcommand{\p}{\mathbbm{p}}
\newcommand{\vphi}{\varphi}
\newcommand{\matlab}{MATLAB\textsuperscript{\textcopyright} }

\def\bsigma{{\bm{\sigma}}}
\def\btau{{\bm{\tau}}}
\def\bchi{{\bm{\chi}}}
\def\bxi{{\bm{\xi}}}
\def\bphi{{\bm{\varphi}}}

\newcommand{\javicomment}[1]{\noindent {\color{red}\textbf{Comment by Javi: #1}}}
\DeclareMathOperator*{\assembly}{\scalerel*{\mathsf{A}}{\sum}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% END OF DEFINITIONS
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%   FRONTMATTER  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Title page, committee page, abstract, dedication, acknowledgements, table
%   of contents, etc.
%
%   If your research requires an Ethics Statement, download the pdf from
%   https://www.lib.sfu.ca/help/publish/thesis/regulations#ethics-statement
%   to your thesis folder, then uncomment the appropriate lines below.

\begin{document}

\frontmatter
\maketitle{}
\makecommittee{}

%\addtoToC{Ethics Statement}%
%\includepdf[pagecommand={\thispagestyle{plain}}]{ethics_statement_piii.pdf}%
%\clearpage

\begin{abstract}
    %Skeletal muscle is a highly complex biological tissue capable of generating work and power for different tasks, such as postural control, locomotion, stabilization of bones and joints, and heat generation. Its mechanics involve several length scales, from cellular units in micrometres to the size of, for example, the sartorius muscle in larger mammals (in the scale of metres). Despite this intricacy, computational models of skeletal muscle typically neglect important features of whole muscles, such as size, shape, architecture, and mass, leading to models that are static or quasi-static. Perhaps surprisingly, many times this simplification is valid and incredibly helpful in predicting muscle function. However, in scenarios such as faster dynamics or whole-muscle dynamics, these often neglected characteristics have a heavy influence on the biomechanical output of computational models. The latter leads to fully dynamic models which are challenging to solve, making this a rather unexplored area in computational biomechanics.

    %In this thesis, we study the nonlinear elastodynamics of skeletal muscle tissue. The first part of this dissertation pertains to one-dimensional models. First, we study the inertial effects in a multi-body model of the muscle-tendon unit using experimentally obtained data. Then, we study the lack of stability in these multi-body models (a non-physical phenomenon) and propose a new continuum model that provides stability throughout the range of motion of a muscle. Next, as a preamble for the next part, we study time discretization options for Neo-Hookean deformation in the presence of a highly stiff material. The second part of this work corresponds to three-dimensional models. Here, we begin with a a new Lagrangian framework for a 3D model of skeletal muscle tissue which simplifies a previously-developed Eulerian model. Moreover, we introduce a new fully implicit time discretization. Then, we introduce Flexodeal, a new finite-element tool for studying musculoskeletal dynamics, completely open source and available to the public. Finally, using this newly developed software, we study gearing in muscle tissues. We show that Flexodeal not only provides results that are in line with literature findings but also provides a framework to study this phenomenon in a variety of muscle architectures and activation levels.
\end{abstract}


\begin{dedication}
This is an optional page. Use your choice of paragraph style for text on this page.
\end{dedication}


\begin{acknowledgements}
This is an optional page. Use your choice of paragraph style for text on this page.
\end{acknowledgements}

\addtoToC{Table of Contents}%
\hypersetup{linkbordercolor=black,hidelinks}
\tableofcontents%
\clearpage

%   This is an optional page. Remove the following lines if you don't have any tables.
\addtoToC{List of Tables}%
\listoftables%
\clearpage

%   This is an optional page. Remove the following lines if you don't have any figures.
\addtoToC{List of Figures}%
\listoffigures%
\clearpage





%   MAIN MATTER  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Start writing your thesis --- or start \include ing chapters --- here.
%

\mainmatter%

\chapter{Introduction}

Start writing or pasting in your text here. By default, only works cited in the text will be added to the bibliography~\cite{HolzapfelBook}.

\section{Physiology of skeletal muscle}

\section{State of the art in muscle modelling}

\section{Continuum mechanics of deformable solids}

This might be a long section, maybe could be a chapter at the beginning of part 2? Should include some comments on generic deformation $\rho_0 \*u_{tt} = \Divt{\*P} + \*f$ and reduction to 1D if this is left as a section in the Introduction.

\part{One-dimensional elastodynamics}

\chapter{Inertial effects in a multi-body mass-spring model of the muscle-tendon unit} \label{ch:mass_enhanced_model}

%Work with Evan on mass enhanced muscle models. We need to discuss what would be appropriate to show here, besides the model and the numerical strategy (dynamic/mass effects? Focus on one cycle? Effects of different muscles and activities?).
%Github repository: mass-enhanced-muscle-models.

%\medskip

%Things that are not in Evan's thesis:
%\begin{enumerate}
%    \item tendon dynamics
%    \item what happens as the number of masses increases (homogenization study)
%\end{enumerate}

%Understanding the elastodynamics of skeletal muscle requires us to have an idea on the expected behaviour of muscle models. As a first approach to this task, we consider one-dimensional actuators. These are models that are well-established in the literature and that are part of major biomechanics software, such as OpenSim and FEBio [REFS]. Despite their apparent simplicity, however, these models are typically made of one or more highly-nonlinear ODEs whose stiff character cannot be overlooked.

%\hrulefill

In this chapter, we study the inertial effects due to added mass in a particular set of forward dynamics simulations of muscle-tendon units (MTUs). More precisely, using locomotion data collected in studies by Chen \cite{EvanThesis} and Dick et al. \cite{Dick2016}, we compare the predictions of a multibody mass-spring model of the MTU against those of a simpler model widely used in biomechanical simulations. In addition, we investigate the influence of the input data in the numerical aspects of the problem. We show that they are not only are influenced by the stiffness of the system, but also by the muscle in consideration and the task is asked to perform.

First, we mathematically describe the ordinary differential equations (ODEs) and the different concepts behind MTU models. Next, we describe the data and parameters in use for this study. Then, we describe the computational implementation of the different solvers required to perform these simulations. Here, we aim to compute lengths and velocities for muscle and tendon, as well as muscle force. Finally, we present a series of tests which show that both models (with and without added mass) show different dynamics, reiterating the importance of considering mass in muscle models for certain experimental scenarios.

\section{Background}

One-dimensional models of skeletal muscle are effective in capturing the overall dynamics of skeletal muscle. Their relative simplicity allows physiologists to perform cheap forward dynamics simulations on a range of subjects, muscles, and tasks.

Consider, for instance, the protocol developed by Chen \cite{EvanThesis} to record data from a human subject during locomotion tasks. Here, 24 LED motion-capture markers are secured to the skin over the pelvis and lower extremities of each participant to capture kinematic and kinetic data. Furthermore, bipolar Ag/AgCl surface electromyography (EMG) electrodes are positioned over the bellies of 10 different muscles to capture EMG data. After this setup is complete, subjects asked to perform 4 different tasks (walking and running on a treadmill, hopping, and sit-to-stand from a chair) with appropriate breaks in between. Data is recorded for about 30 seconds per task and each task is repeated twice. This means that if data is collected for 20 subjects, up to $20 \times 10 \times 8 = 1600$ different simulations could be performed. Thus, accurate and efficient models and numerical algorithms are required to analyze the data in a feasible timeframe.

%In this project, we implement a set of MATLAB routines for a multi-body model of the muscle-tendon unit (MTU) developed by Chen in \cite{EvanThesis}, which has its origins on the work by G\"{u}nther et al. \cite{Gunther2012}, Ross \& Wakeling \cite{RossWakeling2016Multibody}, and Ross et al. \cite{Ross2018}. Moreover, we study the inertial (mass) effects in a particular subset of forward dynamics simulations using previously collected data \cite{EvanThesis,Dick2016}. These effects are typically neglected in the literature (e.g. in the popular biomechanics software OpenSim \cite{Delp2007OpenSim}), but several studies have consistently shown that there are certain scenarios where inertia is not negligible \cite{EvanThesis,RossWakeling2016Multibody}. First, we mathematically describe the ordinary differential equations (ODEs) describing these MTU models. Next, we describe the data and parameters in use for this study. Then, we describe the computational implementation of the solvers required for this study, which will compute important quantities, such as lengths and velocities for muscle and tendon, as well of muscle force. Finally, we describe the inertial effects observed in the simulations and compare these to the output of a typical model that does not take into account the mass of the muscle.

%Using the data collected in \cite{EvanThesis}, we consider two subjects\footnote{One subject performed walking and running tasks, while a different one performed the cycling task. Given that morphological differences are not considered in this study, we will treat these two subjects as a single one.} and select a set of three muscles: medial gastrocnemius (MG), vastus medialis (VM), and semitendinosus (ST); and a set of three tasks: walking, cycling, and running. 

\section{Mathematical models}

\begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{mtu_sketch.jpeg}
    \caption{Sketch of an MTU (nicer version to come).}
    \label{fig:mtu_sketch}
\end{figure}

Let us develop a mathematical model of a dynamically contracting one-dimensional muscle tendon unit, such as the one depicted in Figure \ref{fig:mtu_sketch}. Denote by $L_M = L_M(t)$ and $L_T= L_T(t)$ the muscle and tendon lengths, respectively, at time $t \geq 0$. Moreover, denote by $L = L(t)$ the total length of the MTU which satisfies $L_M(t) + L_T(t) = L(t)$ for any time $t \geq 0$.

\subsection{Main concepts}

We define the \textit{muscle stretch} $\lambda_M$, the \textit{muscle strain} $\varepsilon_M$, and the \textit{muscle strain rate} $\depsilon_M$ as
\begin{equation} \label{eq:def_stretch_strain_rate_muscle}
    \lambda_M := \dfrac{L_M}{l_{mus}^{opt}}, \qquad \varepsilon_M := \lambda_M - 1, \qquad \depsilon_M = \dfrac{1}{\depsilon_0} \der{\lambda_M}{t} = \dfrac{1}{l_{mus}^{opt} \, \depsilon_0} \der{L_M}{t},
\end{equation}
where $l_{mus}^{opt}$ is the \textit{optimal muscle length} and $\depsilon_0$ is the maximum unloaded shortening strain rate. Similarly, we can define the \textit{tendon stretch} $\lambda_T$ and \textit{tendon strain} $\varepsilon_T$ as
\begin{equation}
    \lambda_T := \dfrac{L_T}{l^{opt}_{ten}}, \qquad \varepsilon_T := \lambda_T - 1.
\end{equation} 
The \textit{optimal tendon length} $l_{ten}^{opt}$ can be computed from the \textit{optimal MTU length} $l_{MTU}^{ten}$ as  $l_{ten}^{opt} = l_{MTU}^{opt} - l_{mus}^{opt}$. For now, the reader can consider these quantities as given, however, they will be discussed more in detail in Section \ref{sec:optimal_muscle_length}.



\subsection{Hill's muscle model}

In a simple model, such as the one shown in Figure \ref{fig:muscle_models_1D}A, muscle can be thought as a one-dimensional spring containing a contractile element (CE) and a parallel elastic element (PEE). The first one is related to the force produced by actin-myosin interactions during activation, whereas the latter is related to passive components of the muscle fibre (such as titin), which act to prevent overstretching of the sarcomeres that form the muscle fibre. The muscle force $F_M$ in this case is given by Hill's equation \cite{Zajac1989},
\begin{equation} \label{eq:Hill_force}
    F_{Hill}(\lambda_M, \depsilon_M) = F_0 \Big\{ a(t) \widehat{F}_A(\lambda_M) \widehat{F}_V(\depsilon_M) + \widehat{F}_P(\lambda_M) \Big\}.
\end{equation}
In this expression, known as the standard \textit{Hill's muscle model}:
\begin{enumerate}
    \item The maximum isometric force, $F_0$, is the maximum force that a muscle can produce during an isometric contraction (that is, a \textit{fixed}-length contraction). This force is achieved when the length of the muscle $L_M$ is exactly the optimal muscle length $l_{mus}^{opt}$. Therefore, it can be computed as:
    \begin{equation}
        F_0 = \sigma_0 \cdot PCSA_0 = \sigma_0 \cdot \dfrac{V_{0,mus}}{l_{mus}^{opt}},
    \end{equation}
    where $\sigma_0$ is the maximum isometric stress of muscle tissue, $PCSA_0$ is the optimal physiological cross-sectional area (PCSA), and $V_{0,mus}$ is the muscle volume.
    \item The time-dependent activation function, $a = a(t)$, characterizes the influx of $\mathrm{Ca}_2^+$ ions that trigger the formation of cross-bridges between actins and myosins within sarcomeres. This function can be computed given an excitation $u(t)$ using Zajac's equation \cite{Zajac1989}:
    \begin{equation} \label{eq:zajac}
        \dfrac{da}{dt} + \dfrac{a(t)}{\tau_{act}} \left( \beta + (1-\beta)u(t) \right) = \dfrac{u(t)}{\tau_{act}}.
    \end{equation}
    \item The functions $\widehat{F}_A = \widehat{F}_A(\lambda_M)$ and $\widehat{F}_V = \widehat{F}_V(\depsilon)$ are known respectively as the active \textit{force-length} (FL) and \textit{force-velocity} (FV) relationships. They are related to the CE of the model and describe the force produced due to actin-myosin interactions during activation. These are normalized functions, meaning that $\widehat{F}_A(1) = 1$ and $\widehat{F}_V(0) = 1$.
    \item The function $\widehat{F}_P = \widehat{F}_P(\lambda_M)$ is known as the passive FL relationship. It is related to the PEE and describes the force produced by passive components of the muscle fibre (such as titin), which act to prevent overstretching of the sarcomeres.
\end{enumerate} 

\begin{figure}
    \centering
    \begin{tikzpicture}[square/.style={regular polygon,regular polygon sides=4}]
        \node[inner sep=0pt] at (0,0)
            {\hspace{-3.5em}\includegraphics[width=1.18\textwidth]{force-curves-1D.png}};
        \node at (1.8,-1) [square,draw] {\large \phantom{A}};
        \draw[->] (2.2, -1) -- (3.8,-0.8);
    \end{tikzpicture}
    \caption{Force-relationships in use.}
    \label{fig:force_curves_1D}
\end{figure}

The force relationships $\widehat{F}_A$, $\widehat{F}_V$, and $\widehat{F}_P$ are typically fit from experimental data obtained through tensile experiments, and therefore do not have a standard expression. For this particular set of experiments, we use least-squares fits of the B\'{e}zier curves used by Ross et al. \cite{RossWakeling2016Multibody}. This allows us to evaluate the force directly given a stretch $\lambda_M$ without the need for solving a nonlinear equation, as is the case for B\'{e}zier curves (albeit with a minor loss of accuracy since the B\'{e}zier curves are already fit from experimental data). 
We portray these curves in Figure \ref{fig:force_curves_1D} and give their exact definitions in Appendix \ref{app:force_relationships}.

\begin{figure}
    \centering
    \begin{tikzpicture}
        \centering
        \node at (-2.8,1) {\huge \textbf{A}};
        \node[inner sep=0pt] at (0,0)
            {\includegraphics[width=0.3\textwidth]{hill-massless.eps}};
        \node at (-0.92,0.5) {\footnotesize CE};
        \node at (-0.92, -0.47) {\footnotesize PEE};
        \node at (1.33,-0.2) {SEE};
        \node at (-0.92, -1.25) {\footnotesize $L_M$};
        \node at (1.33, -1.25) {\footnotesize $L_T$};
        \node at (0.1, 1.45) {\footnotesize $\vec{F}_M$};
        \node at (0.7, 1.45) {\footnotesize $\vec{F}_T$};
    \end{tikzpicture}
    \hspace{0.5em}
    \begin{tikzpicture}
        \centering
        \node at (-4.5,1) {\huge \textbf{B}};
        \node[inner sep=0pt] at (0,0)
            {\includegraphics[width=0.525\textwidth]{hill-mass-enhanced.eps}};
        \node at (-2.31, 0.1) {\tiny $m_1$};
        \node at (-0.56, 0.1) {\tiny $m_2$};
        \node at (1.94, 0.1) {\tiny $m_{\hspace{-0.15em}N}$};
        \node at (-3.2, 0.5) {\tiny CE$_1$};
        \node at (-3.2, -0.5) {\tiny PEE$_1$};
        \node at (-3.2, -1.26) {\footnotesize $l_1$};
        \node at (-1.45, 0.5) {\tiny CE$_2$};
        \node at (-1.45, -0.5) {\tiny PEE$_2$};
        \node at (-1.45, -1.26) {\footnotesize $l_2$};
        \node at (1.08, 0.5) {\tiny CE$_{\hspace{-0.15em}N}$};
        \node at (1.08, -0.5) {\tiny PEE$_{\hspace{-0.15em}N}$};
        \node at (1.08, -1.26) {\footnotesize $l_N$};
        \node at (3.05, -0.2) {\tiny SEE};
        \node at (3.05, -1.26) {\footnotesize $L_T$};
        \node at (-2.6, 1.45) {\footnotesize $\vec{F}_1$};
        \node at (-2.0, 1.45) {\footnotesize $\vec{F}_2$};
        \node at (-0.9, 1.45) {\footnotesize $\vec{F}_2$};
        \node at (-0.3, 1.45) {\footnotesize $\vec{F}_3$};
        \node at (1.65, 1.45) {\footnotesize $\vec{F}_N$};
        \node at (2.25, 1.45) {\footnotesize $\vec{F}_T$};
        \node at (0.1,0.14) {\footnotesize $\dots$};
        \node at (-0.1,-1.0) {\footnotesize $\dots$};
    \end{tikzpicture}
    \caption{(A) A simple Hill-type model of the MTU (muscle region in pink, tendon region in grey) using massless springs. Depicted here are the (active) contractile element (CE), the passive elastic element (PEE), and the series elastic element (SEE) representing the tendon. (B) A multi-body model of the MTU that does not neglect the mass of the muscle, which is equally distributed throughout the muscle segment.}
    \label{fig:muscle_models_1D}
\end{figure}

%\begin{circuitikz}
    %ground
    %\pattern[pattern=north east lines] (0,0) rectangle (7,.25);
    %\draw[thick] (0,.25) -- (7,.25);
    
    %\draw (3,.25) to[spring, l=$k$] (3,2);
    %\draw (4,.25) to[damper, l_=$b$] (4,2);
    %\draw[fill=gray!40] (2.5,2) rectangle (4.5,3);
    %\node at (3.5,2.5) {$m$};
    
    %\draw[thick, ->] (3.5,4) -- (3.5,3);
    %\node at (3.75,3.75) {$F$};   
%\end{circuitikz}

%\begin{circuitikz}
    
    %\pattern[pattern=north east lines] (0,0) rectangle (0.2, 2);
    %\draw[thick] (0.2, 0) -- (0.2, 2);
    %\draw (0.2, 1) -- (0.8, 1);
    %\draw (0.8, 1) -- (0.8, 1.5) -- (1.3, 1.5);
    %\draw (1.9, 1.5) ellipse (6mm and 3mm);
    %\draw (2.5, 1.5) -- (3.0, 1.5);
    %\draw (0.8, 1) -- (0.8, 0.5) -- (1.0, 0.5);
    %\draw (1.0, 0.5) to[R] ++(1.8, 0) -- (3.0, 0.5);
    %\draw (3.0, 0.5) -- (3.0, 1.5);
    %\draw (3.0, 1.0) -- (3.6, 1.0);

%\end{circuitikz}

\subsection{Massless and mass-enhanced models of the MTU}

For the model in Figure \ref{fig:muscle_models_1D}A, the muscle force $F_M \equiv F_{Hill}$ is balanced by the tendon force $F_T$ at all times, that is
\begin{equation} \label{eq:massless_model}
    F_M(\lambda_M, \depsilon_M) = F_T(\lambda_T), \quad t > 0.
\end{equation}
This first-order implicit ODE, which we refer to as the \textit{massless} model, represents a model of the MTU in which the mass of the muscle is not taken into consideration. While this may seem like an outrageous simplification of the problem, it is actually what is being solved in the backend of many popular biomechanics software, such as OpenSim \cite{Delp2007OpenSim}. Hence, \textbf{this model's absence of mass raises the question of whether including mass has any effect in the prediction of the dynamics of the system}. 

In an attempt to answer the previous question, based on the work by G\"{u}nther et al. \cite{Gunther2012}, Ross et al. \cite{Ross2018}, and Ross \& Wakeling \cite{RossWakeling2016Multibody, RossPaper4}, Chen \cite{EvanThesis} has put forward a muscle model in which the mass of the muscle is equally distributed into $N$ segments (see Figure \ref{fig:muscle_models_1D}B), forming a multi-body system with $N$ bodies. The dynamics in this model, which we refer to as the \textit{mass-enhanced} model, are given by the set of second-order ODEs:
\begin{subequations} \label{eq:massenhanced_model}
    \begin{align}
        m_1 \ddot{u}_1 &= F_2(\lambda_2, \depsilon_2) - F_1(\lambda_1, \depsilon_1), \\
        m_2 \ddot{u}_2 &= F_3(\lambda_3, \depsilon_3) - F_2(\lambda_2, \depsilon_2), \\
        &\hspace{0.6em} \vdots \notag \\
        m_N \ddot{u}_N &= F_T(\lambda_T) - F_N(\lambda_N, \depsilon_N).
    \end{align}
\end{subequations}
Here, $m_1 = m_2 = \dots = m_N = m_{mus}/N$, where the mass of the muscle $m_{mus}$ depends on its (initial) volume $V_{0,mus}$ through the (initial) density of muscle tissue $\rho_0$, which is constant across mammalian species \cite{MendezKeys1960}:
\begin{equation}
    \rho_0 = \dfrac{m_{mus}}{V_{0,mus}} = 1,060 \ \dfrac{\text{kg}}{\text{m}^3}.
\end{equation}
Moreover, the muscle volume $V_{0,mus}$ is estimated using a formula depending on the subject's height $H$ and mass $W$ \cite{Hansfield2014}:
\begin{equation}
    V_{0,mus} = V_0 \cdot \chi_{mus}, \quad V_0 = (47WH + 1285) \cdot 10^{-6},
\end{equation}
where $\chi_{mus}$ is the fraction of individual muscle relative to the volume of one lower leg $V_0$ (see Table \ref{tab:1d-parameters}).

In turn, $u_i$ denotes the displacement of the $i$-th segment, that is,
\begin{equation}
    u_i = x_i - x_i^0, \quad i=1,\dots,N,
\end{equation}
where $x_i$ is the position of the $i$-th segment and $x_i^0$ denotes its initial position. Furthermore, $\lambda_i$ and $\depsilon_i$ denote the segment stretch and strain rate of the $i$-th segment, respectively
\[
\lambda_i = \dfrac{l_i}{l_s^{opt}} = \dfrac{l_i}{l_{mus}^{opt}/N}, \quad \depsilon_i = \dfrac{\dot{\lambda_i}}{\depsilon_0}, \quad i = 1,\dots,N.
\]
These stretches and strain rates can be written in terms of the displacements $u_i$ as:
\begin{equation}
    \lambda_1 = \dfrac{u_1 + l_s^0}{l_s^{opt}}, \quad \lambda_2 = \dfrac{u_2-u_1 + l_s^0}{l_s^{opt}}, \quad \dots \quad, \lambda_N = \dfrac{u_N-u_{N-1} + l_s^0}{l_s^{opt}},
\end{equation}
and
\begin{equation}
    \depsilon_1 = \dfrac{\dot{u}_1}{l_s^{opt} \depsilon_0}, \quad \depsilon_2 = \dfrac{\dot{u}_2-\dot{u}_1}{l_s^{opt} \depsilon_0}, \quad \dots \quad, \depsilon_N = \dfrac{\dot{u}_N - \dot{x}_{N-1}}{l_s^{opt} \depsilon_0},
\end{equation}
with $l_s^0 := L_M(0)/N$ is the initial length of each segment and $l_s^{opt} = l_{mus}^{opt}/N$. In particular, the muscle length can be computed directly from the position of the last mass, i.e. $L_M = x_N$.

To complete the description of the massless and mass-enhanced models (equations \eqref{eq:massless_model} and \eqref{eq:massenhanced_model}, respectively), we have to provide the optimal muscle length $l_{mus}^{opt}$, as well as the initial muscle length $L_M(0)$. The latter is sufficient to provide initial conditions for the system \eqref{eq:massenhanced_model} (assuming that the system of $N$ bodies is initially at rest, i.e. $\dot{u}_i(0) = 0$). Because we will be working with experimentally-obtained data and force relationships that are particular to this study, $l_{mus}^{opt}$ and $L_M(0)$ can only be \textit{estimated} from the literature, so the true value must be computed to ensure simulations start from static equilibrium. This topic will be discussed in the next section.

\begin{table}
    \centering
    \begin{tabular}{|lp{5cm}|l|l|}\hline
         & Description & Value & References \\\hline
        $\sigma_0$ & Muscle maximum isometric stress & 225 kPa & \cite{Medler2002, Powell1984}\\\hline
        $\depsilon_0$ & Muscle maximum unloaded shortening strain rate & \makecell[l]{5 s$^{-1}$ (walking, running) \\ 10 s$^{-1}$ (cycling)} & \cite{WakeingLee2012} \\\hline
        $\tau_{act}$ & Time constant for activation & \makecell[l]{0.045 s (walking, running) \\ 0.025 s (cycling)} & \cite{Dick2017} \\\hline
        $\beta$ & Ratio of $\tau_{act}$ to deactivation time constant & 0.6 &\cite{Dick2017} \\\hline
        $\chi_{mus}$ & Volume fraction of muscle with respect to that of one lower leg & \makecell[l]{MG: 0.0362 \\ VM: 0.0606 \\ ST: 0.026} & \cite{Hansfield2014} \\\hline
        $r_{mus}$ & Muscle-to-MTU length ratio & \makecell[l]{MG: 0.54 \\ VM: 0.84 \\ ST: 0.70 } & \cite{Kovacz2020,OBrien2010}\\\hline
        $l_{MTU}^{opt}$ & Optimal MTU length & \makecell[l]{Subject 1 (walking, running):\\ \hspace{1em} MG: 0.3910 m \\ \hspace{1em} VM: 0.2770 m \\ \hspace{1em} ST: 0.4122 m \\ Subject 2 (cycling):\\ \hspace{1em} MG: 0.3952 m \\ \hspace{1em} VM: 0.2171 m \\ \hspace{1em} ST: 0.4381 m} & \cite{EvanThesis} \\\hline
    \end{tabular}
    \caption{List of parameters for the mass-enhanced and massless models. The muscles listed in the table are the \textit{medial gastrocnemius} (MG), \textit{semitendinosus} (ST), and \textit{vastus medialis} (VM).}
    \label{tab:1d-parameters}
\end{table}

\subsection{Optimal muscle and tendon length} \label{sec:optimal_muscle_length}

The optimal muscle length, $l_{mus}^{opt}$, is the length at which myofilament overlap is optimal\footnote{This happens at sarcomere lengths of about 2.6-2.8 $\mu$m in human muscle and 2.0-2.2 $\mu$m in frog muscle \cite{FridenLieber1998}.} and force production is maximal \cite{FridenLieber1998}, that is, when $F_M = F_0$ at $L_M = l_{mus}^{opt}$. When the MTU is fixed at this length (that is, $L = l_{MTU}^{opt}$), muscle and tendon forces balance:
$F_M(1) = F_0 = F_T(1)$. This means that the definition of $l_{mus}^{opt}$ depends on the FL relationship, which is particular to the muscle in study. Therefore, any quantity obtained from the literature can only be considered an \textit{estimate}. Denote the estimated optimal muscle and tendon lengths respectively by $\widetilde{l_{mus}^{opt}}$ and $\widetilde{l_{mus}^{opt}}$, which are given by:
\begin{equation}
	\widetilde{l_{mus}^{opt}} := l_{MTU}^{opt} r_{mus}, \qquad \widetilde{l_{ten}^{opt}} := l_{MTU}^{opt}(1-r_{mus}).
\end{equation}
Here, $l_{MTU}^{opt}$ is the optimal MTU length (given) and $r_{mus}$ is the muscle-to-MTU-length ratio (see Table \ref{tab:1d-parameters}). Furthermore, assume that this estimate as a deviation $\Delta l_{mus}^{opt}$ from the true value $l_{mus}^{opt}$, i.e.
\begin{equation}
    l_{mus}^{opt} = \widetilde{l_{mus}^{opt}} + \Delta l^{opt}_{mus}, \qquad l_{ten}^{opt} = \widetilde{l_{ten}^{opt}} - \Delta l^{opt}_{mus}.
\end{equation}
Since muscle and tendon force balance at optimal MTU length, and assuming that the muscle is inactive ($a=0$) and $F_T = F_0 \widehat{F}_T$, the true values $l_{mus}^{opt}$ and $l_{ten}^{opt}$ can be obtained by solving the following equation for the error $\Delta l_{mus}^{opt}$:
\begin{equation} \label{eq:calibration_1}
    \widehat{F}_P\left( \dfrac{\widetilde{l_{mus}^{opt}}}{\widetilde{l_{mus}^{opt}} + \Delta l^{opt}} \right) = \widehat{F}_T \left( \dfrac{\widetilde{l_{ten}^{opt}}}{\widetilde{l_{ten}^{opt}} - \Delta l^{opt}} \right).
\end{equation}

\subsection{Initial muscle length}

Similar to the computation of optimal muscle and tendon lengths, to ensure the simulation begins from static equilibrium, we assume that the given initial MTU length $L(0)$ only provides estimates for the initial muscle and tendon lengths, that is:
\begin{equation}
    \widetilde{L_M(0)} = L(0) \cdot r_{mus}, \quad \widetilde{L_T(0)} = L(0) \cdot (1-r_{mus}).
\end{equation}
Furthermore, we assume that the true values for $L_M(0)$ and $L_T(0)$ are off by a factor of $\Delta L_M(0)$, that is, 
\begin{equation}
    L_M(0) =  \widetilde{L_M(0)} + \Delta L_M(0), \quad L_T(0) = \widetilde{L_T(0)} - \Delta L_M(0).
\end{equation}
Then, we can find the value of this correction by solving the equation
\begin{equation} \label{eq:calibration_2}
    F_P \left( \dfrac{\widetilde{L_M(0)} - \Delta L_M(0)}{l_{mus}^{opt}}\right) = F_T \left( \dfrac{\widetilde{L_T(0)} + \Delta L_M(0)}{l_{ten}^{opt}}\right).
\end{equation}
The corrections $\Delta l_{mus}^{opt}$ and $\Delta L_M(0)$ are typically small and represent the correct setup of the locomotion experiment at the time of data collection.

\subsection{Scaling}

As mentioned in the introduction to this thesis, most of our knowledge in human biomechanics comes from experiments performed in small animals, such as frogs, rats, and cats. 
However, it is known that larger (thus heavier) muscles will yield more inertial effects than smaller ones, so the size difference should not always be neglected \cite{EvanThesis,Ross2018}. This motivates the consideration of scaled up versions of the muscles in study. In this way, a scaling factor of $s$ means that the MTU length will be scaled up by a factor of $s$, the physiological cross sectional area of muscle by a factor of $s^2$, the muscle volume by a factor of $s^3$, and so on. For example, in studies of gearing, the MG from young rats considered by Holt et al. \cite{Holt2016} had an average volume of $8.4906 \cdot 10^{-7} \ m^3$. In turn, the subject used in this study for walking and running tasks had a MG volume of about $2.3348 \cdot 10^{-4} \ m^3$. That is about 275 times the volume of the rat MG, equivalent to a scaling factor of about 6.5. In this study, we will use scales of 1 and 10.

\section{Experimental data: muscles and tasks in consideration} \label{sec:experimental_data}

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{example-traces-activation-mtulength.png}
    \caption{Example traces of the data (muscle: ST, task: running) used as input for the one-dimensional massless and mass-enhanced models. In this case, the activation $\widehat{a}$ has been computed from the excitation $\widehat{u}$ using Zajac's ODE \eqref{eq:zajac}.}
    \label{fig:traces_act_mtu_length}
\end{figure}

We consider two subjects of equal mass (68 kg) and height (1.67 m) who were asked to perform a set of locomotion tasks: walking and running at their own pace \cite{EvanThesis}, and cycling at a cadence of 80 rpm and a crank load of 26 Nm \cite{Dick2016}. Moreover, we consider the muscle excitation $\widehat{u}(t)$ and MTU length $L(t)$ from three different muscles: medial gastrocnemius (MG), vastus medialis (VM), and semitendinosus (ST). Thus, nine different muscle-task combinations can be formed. An example of this data is shown in Figure \ref{fig:traces_act_mtu_length} for the ST during running. All data was recorded for a time span of 25 seconds. For more precise details on the experiment setup and data collection, we refer the reader to \cite{EvanThesis}.

%\begin{enumerate}
%    \item matlab solvers in use, tolerances
%    \item computational architectures
%\end{enumerate}

\section{Computational implementation}

Solvers for the massless \eqref{eq:massless_model} and mass-enhanced model \eqref{eq:massenhanced_model}, as well as for the Zajac ODE \eqref{eq:zajac} and the calibration steps \eqref{eq:calibration_1} and \eqref{eq:calibration_2} have been implemented in \matlab using built-in routines. See Table \ref{tab:matlab_solvers} for a list of these solvers and the default parameters that have been used. Moreover, the complete set of codes written for this study is available at \url{www.github.com/javieralmonacid/multibody-muscle-1d}. The ODE solvers are \textit{adaptive}, meaning that the time step size is controlled by absolute and relative tolerance requirements \cite{ShampineReichelt1997}. First, \texttt{ode45} is a single-step solver based on an explicit Runge-Kutta (4,5) formula (the Dormand-Prince pair \cite{DormandPrince1980}). It is typically used for non-stiff ODEs, such as Zajac's ODE \eqref{eq:zajac}. Next, \texttt{ode15s} is a variable-order, variable-step solver based on differentiation formulas of order 1 to 5 \cite{ShampineReichelt1997}. It is a multistep solver used for solving stiff ODEs, such as the mass-enhanced model \eqref{eq:massenhanced_model}. Finally, \texttt{ode15i} is similar to \texttt{ode15s}, but it is designed to solve fully implicit differential equations \cite{Shampine2002}, such as the massless model \eqref{eq:massless_model}.

\begin{table}
    \centering
    \begin{tabular}{|l|c|c|c|c|}\hline
        Description & \matlab solver & AbsTol & RelTol & N \\\hline
        Zajac ODE \eqref{eq:zajac} & \texttt{ode45} & 1e-6 & 1e-3 & - \\\hline
        Parameter calibration \eqref{eq:calibration_1}, \eqref{eq:calibration_2} & \texttt{fzero} & - & - & - \\\hline
        Massless model \eqref{eq:massless_model} & \texttt{ode15i} & 1e-6 & 1e-6 & - \\\hline
        Mass-enhanced model \eqref{eq:massenhanced_model} & \texttt{ode15s} & 1e-10 & 1e-6 & 64 \\\hline
    \end{tabular}
    \caption{List of \matlab built-in solvers in use.}
    \label{tab:matlab_solvers}
\end{table}


\subsection*{A convergence test}

To have an idea on what to expect for the general results, and to evaluate the convergence of the solvers, let us perform an experiment using the MTU length and activation data from the ST muscle during running. Here, we fix the scale to $s=10$, the number of masses to $N=16$ (as used in \cite{EvanThesis,RossWakeling2016Multibody,RossPaper4}), the absolute tolerance to $10^{-10}$, and vary the relative tolerance from $10^{-2}$, $10^{-4}$, \dots down to $10^{-10}$. We show the results in Figure \ref{fig:multibody-reltol} for three representative seconds of output. Recall that no exact solution is available for this problem.

First, we observe that the muscle stretch $\lambda_M$ and the muscle strain rate $\depsilon_M$ are within the (generally accepted) operating ranges of human muscle, that is $\lambda_M \in [0.85, 1.15]$ and $\depsilon_M \in [-0.3, 0.3]$. Next, we notice that the muscle stretch contains minor oscillations when $\lambda_M < 1$. These are then amplified in the muscle strain rate as it varies from $\depsilon_M < 0$ to $\depsilon_M > 0$. Moreover, reducing the relative tolerance does not yield a better approximation (qualitatively speaking), even though the average time step size is indeed decreasing (see Figure \ref{fig:multibody-reltol-avg-deltat}). This is a sign that the solver is correctly resolving the primary unknowns, and that the apparent stiffness in the system is not tied to the time discretization, as we will see in the next section.

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{multibody-reltol-effect.png}
    \caption{Traces of muscle strains ($\lambda_M$) and strain rates ($\depsilon_M$) as the relative tolerance in the ODE solver is varied while the absolute tolerance is fixed to $10^{-10}$.}
    \label{fig:multibody-reltol}
\end{figure}

\begin{figure}
    \centering
    %\begin{tabular}{|l|c|c|c|c|c|}\hline
    %    RelTol & 1e-2 & 1e-4 & 1e-6 & 1e-8 & 1e-10 \\\hline
    %    Avg. $\Delta t$ (ms) & 2.9145 & 0.7197 & 0.2106 & 0.0791 & 0.0352 \\\hline
    %\end{tabular}
    \includegraphics[width=\textwidth]{convergence_dt.png}
    \caption{Average time step size $\Delta t$ in the mass-enhanced model as the relative tolerance decreases while the absolute tolerance is fixed to $10^{-10}$.}
    \label{fig:multibody-reltol-avg-deltat}
\end{figure}


\section{Main results}

We perform simulations for all 9 muscle-task pairs at scales $s=1$ and $s=10$ using the solvers described in the previous section. Moreover, we focus on the behaviour of the ST during running. Finally, we analyze the impact of the number of the masses on the system in the quality of the output.

\subsection{Overall behaviour for different muscles and tasks}

In Figure \ref{fig:multibody_predicted_forces_1_10} we show the predicted normalized muscle force (i.e. $F_M/F_0$, see \eqref{eq:Hill_force}) using the massless and mass-enhanced ($N = 64$) models for three representative seconds of data. The input data in this case are MTU lengths and activation patterns from the three different muscles and the three different tasks specified in Section \ref{sec:experimental_data}. In line with the findings by Chen \cite{EvanThesis}, we observe negligible differences when $s=1$ (see Figure \ref{fig:multibody_predicted_forces_1_10}A) and significant differences when $s=10$ (up to 14\% RMSE difference for ST-running, see Figure \ref{fig:multibody_predicted_forces_1_10}B).

In general, when we scale the muscle 10 times its size (i.e. $s=10$), the mass-enhanced model can capture much sharper dynamics than the massless model. Moreover, the inertial effects can cause faster variations of muscle force (ST-walking), shifts in phase (VM-cycling), and differences of peak (local) force of above 100\% (ST-running). 

Computationally speaking, even though the dynamics of the MTU are, in general, smooth for all muscle-task pairs (see, for instance, Figure \ref{fig:traces_act_mtu_length}), the time that it takes to simulate the full 25 seconds of data varies significantly, not only depending on the model but also on the muscle and the task of choice. While the massless model finishes computation in about 1 to 5 seconds, the mass-enhanced model can easily take hours to compute a result (up to 5 hours for the ST muscle during running, see Table \ref{tab:multibody_computational_time}).

\begin{figure} 
    \centering
    \begin{tikzpicture}
        \node[inner sep=0pt] at (0,0)
            {\includegraphics[width=\textwidth]{multibody-force-scale-1.png}};
        \node[inner sep=0pt] at (0,-9.5)
            {\includegraphics[width=\textwidth]{multibody-force-scale-10.png}};
        \node at (-7.5,4.5) {\huge \textbf{A}};
        \node at (-7.5,-5) {\huge \textbf{B}};
    \end{tikzpicture}
    \caption{Predicted (normalized) forces when the scaling parameter is unchanged (i.e. $s=1$; A) and when $s=10$ (B) for 9 different muscle-task combinations. RMSE computed using the data range shown in the figures.}
    \label{fig:multibody_predicted_forces_1_10}
\end{figure}

\begin{table} 
    \centering
    \begin{tabular}{|c|c|c|c|}\hline
        \multicolumn{4}{|c|}{scale = 1} \\\hline
        Muscle $\backslash$ Task & Walking & Cycling & Running \\\hline
        MG & 1.01 & 0.80 & 1.19 \\\hline
        VM & 2.28 & 1.33 & 2.79 \\\hline
        ST & 1.28 & 0.83 & 1.54 \\\hline\hline
        \multicolumn{4}{|c|}{scale = 10} \\\hline
        Muscle $\backslash$ Task & Walking & Cycling & Running \\\hline
        MG & 1.15 & 0.99 & 1.79 \\\hline
        VM & 2.07 & 3.29 & 3.70 \\\hline
        ST & 2.54 & 0.90 & 5.10 \\\hline
    \end{tabular}
    \caption{Computation times (in hours) for each muscle-task combination at scales 1 and 10 for the full 25 seconds of available data.}
    \label{tab:multibody_computational_time}
\end{table}

\subsection{Dynamics of the ST during running}

In view of the previous results, we decide to have a closer look at the behaviour of the ST muscle during running. In particular, we show traces of excitation, activation, muscle length, tendon length, muscle strain rate, and normalized muscle force for $s=1$ and $s=10$ in Figure \ref{fig:multibody_traces_ST_running}. Here, the excitation is given from the experimental data, the activation is computed based on this excitation using \eqref{eq:zajac}, and the rest of the variables are computed by the solver. In particular, the muscle force is equal to the computed tendon force, since we are assuming that the tendon transmits the entirety of the force generated by muscle. 

These results show that the tendon acts as a strut when $s=1$, but it is no longer the case for $s=10$. Indeed, tendon strains of up to 20\% are observed, and they produce sharp variations of strain rate (and ultimately force) that the massless model cannot capture. Another important feature is that, when $s=10$, we observe a development of impulsive forces when transitioning from $\depsilon_M < 0$ to $\depsilon_M > 0$. This is something that has not been described previously (cf. \cite{EvanThesis,Ross2018}) because the dynamics in these works are much smoother. We also note that the results in Figure \ref{fig:multibody_traces_ST_running} were computed using $N=64$ masses (see Table \ref{tab:matlab_solvers}) because the simulation was not fully resolved when $N=16$ masses were used. 

\begin{figure} 
    \centering
    \hspace*{-5.5em}\includegraphics[width=1.25\textwidth]{st-running-strains-strain-rates-forces.png}
    \caption{Predicted dynamics using the massless (dashed black lines) and mass-enhanced (solid blue line) models for the ST muscle during running. From top to bottom, the first row shows the (given) muscle excitation and (computed) activation, then the (computed) muscle strain $\varepsilon_M$, muscle strain rate $\depsilon_M$, tendon strain $\varepsilon_T$, and normalized muscle force $\widehat{F}_M = F_M/F_0$.}
    \label{fig:multibody_traces_ST_running}
\end{figure}

\subsection{Influence of the number of masses in the computation}

The phenomenon in the previous subsection is a strong indication that, in certain scenarios, the number of masses in the model might need to be modified from the standard $N=16$ suggested by Ross et al. \cite{Ross2018-1D}. To view this in more detail, we performed a homogenization study by varying the number of masses from 0 (i.e., a simulation using the massless model) to 128 masses. We portray these results in Figure \ref{fig:multibody-homog-study}. Here, we observe how it is only when using $N=128$ masses that we do not observe any unphysical oscillations. However, simulating 18 seconds of data took about 42 hours of computational time and a significant amount of memory, so this is not a feasible approach for studying multiple muscle-task combinations. This also suggests that the problem could be better approached using a one-dimensional \textit{continuum} model (see next chapter), that is, a model derived from an infinitely large number of masses (i.e. $N \to \infty$).

\begin{figure}
    \centering
    \hspace*{-3.5em}\includegraphics[width=1.2\textwidth]{multibody-homog-study.png}
    \caption{Traces of muscle strains ($\lambda_M$), strain rates ($\depsilon_M$), and (normalized) muscle force $\widehat{F}_M$ as the number of masses vary in the mass-enhanced model: from $N=0$ (second row, i.e. massless model), $N=2$ (third row), up to $N=128$ (last row). For reference we have added the computed activation in the first row.}
    \label{fig:multibody-homog-study}
\end{figure}


\chapter{Dynamical stability and the continuum limit of multibody models}

We now turn our attention to the issue of stability in muscle models. In particular, we refer to a dynamical system (such as the mass-enhanced model \eqref{eq:massenhanced_model}) being \textit{dynamically} stable if small perturbations or deviations from an equilibrium state result in the system eventually remaining near or returning to that equilibrium state over time (see, e.g., \cite{strogratz}). This is in contrast to the concept of \textit{numerical} stability, which is tied to the numerical scheme used to approximate the solution to a dynamical system. We remark that these terms are \textit{not} interchangeable and that the present chapter will focus entirely on the dynamical stability of models such as \eqref{eq:massenhanced_model}.

First, we introduce the context in which multibody models are unstable and the mathematical reasons behind. We present some numerical experiments to visualize the effects of this instability. Next, we propose a simple method to stabilize the system based on previously-validated three-dimensional models. This will require us to explore the continuum limit of the mass-enhanced model, that is, as the number of masses in the system grows infinitely. Finally, we visualize the dynamics on this updated system and the implications when analyzing the mass effects in a one-dimensional context.

%In this chapter, we focus on the \textit{dynamical} stability of the mass-enhanced model introduced in the previous chapter. More precisely, we study the instability of the system \eqref{eq:massenhanced_model} during isomeric contractions along a region of the total FL relationship known as the \textit{descending limb}, a phenomenon known as the \textit{descending limb instability} (DLI). Given that this is only a computational phenomenon and not a physiological one, it is clear that models such as \eqref{eq:massenhanced_model} lack an important feature describing skeletal muscle tissue. 

%First, we describe the DLI and an experiment that replicates it based on the mass-enhanced model introduced in the previous chapter. Next, we show that this model can be viewed as a particular discretization of a one-dimensional \textit{partial} differential equation (PDE). Then, we introduce an additional term to this PDE that can be seen as a passive element not captured by the PEE in Hill's equation \eqref{eq:Hill_force} (that is, the passive force-length relationship $f_P$). Finally, from this PDE, we retrieve a new version of the mass-enhanced model for which we repeat the stability tests that describe the DLI. We will see that this new model is indeed stable at all regions of the total FL relationship.

\section{Background}

The force-length (FL) relationship, which was described for the first time in 1966 for the semitendinosus muscle in frogs \cite{GordonHuxleyJulian1966}, is an important component of Hill-type muscle models. It describes the contractile forces generated by the active and passive elements in a muscle fibre. 

The active force-length curve is a ``bell''-shaped curve that characterizes the actin-myosin interactions formed upon activation. At a sarcomere level, an increasing level of activation leads to a greater overlap between actins and myosins, but only until the sarcomere has reached its optimal length. Beyond this, the overlap between actin and myosin decreases. This reduction means fewer cross-bridges can form, thereby decreasing the ability of the sarcomere to generate active force. Because a muscle fibre can be seen as a bundle of serially-connected sarcomeres, the active force that a muscle fibre generates is assumed to follow this same logic (see Figure \ref{fig:ascending_descending_limbs}A). In turn, the passive force combines the force-generating effects of extracellular components (such as the endomysium, perimysium, epimysium, and sarcolemma) and intracellular components (such as titin) that act to prevent overstretching.

%The active component is generally measured using isometric contractions, that is, the muscle is stretched to a desired length \textit{and then} activated to 100\%. This experiment yields a bell-like curve in which the muscle force increases for increasing muscle lengths below optimal length (i.e. $\lambda_M < 1$), but decreases once the muscle is stretched past optimal length (i.e. $\lambda_M > 1$). The former region is known as the \textit{ascending} limb of the active FL relationship, while the latter is known as the \textit{descending} limb (see Figure \ref{fig:ascending_descending_limbs}A). In turn, the passive force only acts (non-negligibly) for muscle lengths above optimal length, primarily to prevent overstretching.

\begin{figure}
    \centering
    \begin{overpic}[width=\textwidth]{FL_ascending_descending.png}
        \put (4,33) {{\huge \textbf{A}}}
        \put (50,33) {{\huge \textbf{B}}}
    \end{overpic}
    \caption{(A) Active and passive FL relationships. The region $\lambda_M < 1$ corresponds to the ascending limb (in blue) since the curve has a positive slope. In turn, the region $\lambda_M > 1$ corresponds to the descending limb (in ochre) which has a distinctive negative slope. (B) When active and passive forces are added, they form the \textit{total} FL relationship, which typically has a dip region (i.e. a region with negative slope) around $1 < \lambda_M < 1.35$.}
    \label{fig:ascending_descending_limbs}    
\end{figure}

The region on which the active force is increasing (that is, $\lambda_M < 1$) is known as the \textit{ascending} limb, whereas the region where the force is decreasing (that is, $\lambda_M > 1$) is known as the \textit{descending} limb. 
When active and passive forces are combined, the resulting curve may have a ``dip'' region because the passive curve has a slope that is not positive enough to overtake the negative slope of the active curve (see Figure \ref{fig:ascending_descending_limbs}B). This is particularly problematic if the goal is to simulate isometric contractions in this dip region using a multibody model such as the mass-enhanced model \eqref{eq:massenhanced_model}. A small perturbation of the system in this region can generate dynamics that do not reflect the behaviour of skeletal muscle. This phenomenon is known as the \textit{descending limb instability} and has been a subject of discussion for almost 20 years \cite{AllingerEpsteinHerzog1996,YeoEtAl2023NumericalInstability,Zahalak1997}. We remark that this is an instability of \textit{dynamical} type, not numerical (as sometimes is referred to, see \cite{YeoEtAl2023NumericalInstability}). A more precise description of this phenomenon can be made using tools from dynamical systems, which will be the goal of the next section.

\section{Mathematical description of the descending limb instability}

Let us dive into the reasons behind the descending limb instability (DLI) in the context of the mass-enhanced model \eqref{eq:massenhanced_model}. This will be useful to understand what originates this instability and what can be done to remediate it. We begin this section by establishing what an isometric contraction means for our purposes.

\begin{definition}[Isometric contraction]
    Consider a muscle modelled as a series of one-dimensional elastic elements (i.e. as in the mass-enhanced model). We say that a muscle is contracted \textit{isometrically} if the total muscle length $L_M$ remains constant at all times, independent of the activation level. For the case of a muscle-tendon unit (MTU), we say the MTU is contracted isometrically if the combined length of muscle and tendon remains constant throughout the experiment, 
\end{definition}

The definition above implies that, although the length of the muscle (or an MTU) remains fixed during an isometric contraction, the length of its constitutive elements (i.e., each segment in the mass-enhanced model, or the muscle and tendon lengths in an MTU) may experience individual variations.

\subsection{The model for an isometric contraction}

Consider a muscle modelled as a series of $N$ contractile elements with $N-1$ masses distributed in the same fashion as the mass-enhanced model \eqref{eq:massenhanced_model} (see Figure \ref{fig:model_isometric_contraction}). Moreover, assume that the length is given by $\lambda_M L_M$, where $L_M$ is the optimal muscle length and $\lambda_M$ is a given stretch. Then, the system \eqref{eq:massenhanced_model} now reads:
\begin{subequations} \label{eq:odes_hill_only}
    \begin{align}
        m_1 \ddot{u}_1 &= F_2(\lambda_2, \depsilon_2) - F_1(\lambda_1, \depsilon_1), \\
        m_2 \ddot{u}_2 &= F_3(\lambda_3,\depsilon_3) - F_2(\lambda_2,\depsilon_2), \\
        &\hspace{0.6em} \vdots \notag \\
        m_{N-1} \ddot{u}_{N-1} &= F_N(\lambda_N, \depsilon_N) - F_{N-1}(\lambda_{N-1}, \depsilon_{N-1}).
    \end{align}
\end{subequations}
Here, for $i=1,\dots,N-1$, $u_i$ is the displacement of the $i$-th segment, $m_i = m_{mus} / (N-1)$ with $m_{mus}$ being the mass of the muscle, and the forces $F_i$ are given by Hill's force:
\begin{equation} \label{eq:Hill_force_stability}
    F_i(\lambda_i, \depsilon_i) = F_{Hill}(\lambda_i,\depsilon_i) = F_0 \left\{ F_A(\lambda_i) F_V(\depsilon_i) + F_P(\lambda_i) \right\}.    
\end{equation}
Note that, unlike the expression in \eqref{eq:Hill_force}, we are assuming a fully active muscle (i.e. $a(t) = 1$). As before, the segment stretches $\lambda_i$ are given by:
\begin{subequations} \label{eq:def_stretches_stability}
   \begin{align}
        \lambda_1 &= \dfrac{u_1}{l_s^{opt}} + \lambda_M, \\
        \lambda_i &= \dfrac{u_i-u_{i-1}}{l_s^{opt}} + \lambda_M, \quad i=2,\dots,N-1, \\
        \lambda_N &= \dfrac{-u_{N-1}}{l_s^{opt}} + \lambda_M,
   \end{align}
\end{subequations}
with $l_s^{opt} = L_M / N$, whereas the strain rates $\depsilon_i$ are just:
\begin{equation} \label{eq:def_strain_rates_stability}
    \depsilon_i = \dfrac{1}{\depsilon_0} \dfrac{d\dot\lambda_i}{dt}, \quad i=1,\dots,N.
\end{equation}
We remark that, because we are modelling an isometric contraction, these strain rates will be near zero, and thus the contribution from the FV relationship is negligible since $F_V(0) = 1$. However, we decide to leave this dependence in the definition of Hill's force \eqref{eq:Hill_force_stability} and in the right-hand side of \eqref{eq:odes_hill_only} not only to preserve the structure of the muscle model but also to reuse the computational tools developed in the previous chapter.

\begin{figure}
    \centering
    \begin{tikzpicture}
        \centering
        %\node at (-4.5,1) {\huge \textbf{B}};
        \node[inner sep=0pt] at (0,0)
            {\includegraphics[width=0.525\textwidth]{hill-mass-enhanced-isometric.eps}};
        \node at (-2.31, 0.1) {\tiny $m_1$};
        \node at (-0.56, 0.1) {\tiny $m_2$};
        \node at (1.94, 0.1) {\tiny $m_{\hspace{-0.15em}{N-1}}$};
        \node at (-3.2, 0.5) {\tiny CE$_1$};
        \node at (-3.2, -0.5) {\tiny PEE$_1$};
        \node at (-3.2, -1.26) {\footnotesize $l_1$};
        \node at (-1.45, 0.5) {\tiny CE$_2$};
        \node at (-1.45, -0.5) {\tiny PEE$_2$};
        \node at (-1.45, -1.26) {\footnotesize $l_2$};
        \node at (1.08, 0.15) {\tiny CE$_{{N-1}}$};
        \node at (1.08, -0.5) {\tiny PEE$_{{N-1}}$};
        \node at (2.85, 0.15) {\tiny CE$_{N}$};
        \node at (2.85, -0.5) {\tiny PEE$_{N}$};
        \node at (1.08, -1.26) {\footnotesize $l_{N-1}$};
        \node at (2.85, -1.26) {\footnotesize $l_{N}$};
        \node at (-2.6, 1.45) {\footnotesize $\vec{F}_1$};
        \node at (-2.0, 1.45) {\footnotesize $\vec{F}_2$};
        \node at (-0.9, 1.45) {\footnotesize $\vec{F}_2$};
        \node at (-0.3, 1.45) {\footnotesize $\vec{F}_3$};
        \node at (1.5, 1.45) {\footnotesize $\vec{F}_{N-1}$};
        \node at (2.25, 1.45) {\footnotesize $\vec{F}_N$};
        \node at (0.1,0.14) {\footnotesize $\dots$};
        \node at (-0.1,-1.0) {\footnotesize $\dots$};
    \end{tikzpicture}
    \caption{Mass-enhanced muscle model adapted for an isometric contraction. Here, the sum of all element lengths (i.e. $\sum_{i=1}^N l_i = L_M$) is fixed.}
    \label{fig:model_isometric_contraction}
\end{figure}
 

\subsection{Stability of the zero solution} \label{sec:stability_zero_solution}

%Let us assume that $m_i = m_{mus}/(N-1)$, where $m_{mus}$ is the total muscle mass.
First, we rewrite the system \eqref{eq:odes_hill_only} as a system of first order ODEs, which we can compactly express as:
\begin{equation} \label{eq:odes_hill_only_first_order}
%    \dfrac{d\vec{\xi}}{dt}= \vec{g}\left( \vec{\xi} \, \right),
\dfrac{d}{dt} \begin{pmatrix}
    \vec{u} \\ \vec{v} 
\end{pmatrix} = \dfrac{N-1}{m_{mus}}\begin{bmatrix}
    \*0 & \*I \\ \*0 & \*0
\end{bmatrix} \begin{pmatrix}
    \vec{u} \\ \vec{v} 
\end{pmatrix} + \mathcal{F}(\vec{u}, \vec{v}),
\end{equation}
where $\vec{u} = (u_1, \dots, u_{N-1})^\top$ is the vector of displacements, $\vec{v} = (v_1, \dots, v_{N-1})^\top$ is the vector of velocities (not to be confused with strain rates, see Equation \eqref{eq:def_strain_rates_stability}), and the nonlinear term $\mathcal{F}(\vec{u}, \vec{v})$ is given by
\begin{equation} \label{eq:def_nonlinear_force_term}
    \mathcal{F}(\vec{u}, \vec{v}) = \begin{pmatrix}
        \vec{0} \\ \vec{F}(\vec{u}, \vec{v})
    \end{pmatrix}, \quad 
    \vec{F}(\vec{u},\vec{v}) = \begin{pmatrix}
        F(\lambda_2, \depsilon_2) - F(\lambda_1, \depsilon_1) \\
        \vdots \\
        F(\lambda_N, \depsilon_N) - F(\lambda_{N-1}, \depsilon_{N-1}),
    \end{pmatrix}
\end{equation}
with the force $F$ corresponding to Hill's force with maximal activation ($a=1$), that is
\begin{equation}
    F(\lambda, \depsilon) = F_0 \Big\{ F_A(\lambda)F_V(\depsilon) + F_P(\lambda) \Big\}.
\end{equation}

Notice that the zero solution, that is $(\vec{u}, \vec{v}) = (\vec{0}, \vec{0})$ is an equilibrium point of the system \eqref{eq:odes_hill_only_first_order}. From the definition of the segment stretches $\lambda_i$ in \eqref{eq:def_stretches_stability}, we observe that
\[
u_i = 0 \quad \Rightarrow \quad \lambda_i = \lambda_M, \quad \forall \ i=1,\dots,N-1.
\]
Furthermore, from the definition of the strain rates in \eqref{eq:def_strain_rates_stability} and the velocities in \eqref{eq:odes_hill_only_first_order}, we have
\[
v_i = 0 \quad \Rightarrow \quad \dot{u}_i = 0 \quad \Rightarrow \quad\depsilon_i = \dfrac{1}{\depsilon_0} \dfrac{d}{dt} \left( \dfrac{u_i - u_{i-1}}{l_s^{opt}} \right) = \dfrac{1}{\depsilon_0} \left( \dfrac{\dot{u}_i - \dot{u}_{i-1}}{l_s^{opt}} \right) = 0,
\]
for all $i=1,\dots,N-1$. Therefore, the segment forces that define $\vec{F}$ in \eqref{eq:def_nonlinear_force_term} cancel each other, so the right-hand side of \eqref{eq:odes_hill_only_first_order} vanishes. 

According to the theorem of Hartman-Grobman \cite{HartmanGrobman}, we may linearize \eqref{eq:odes_hill_only_first_order} around $(\vec{0}, \vec{0})$ to analyze the stability of this equilibrium point. Furthermore, because the changes in stretch are will be small relative to the time it takes the system to stabilize, we can assume that $\depsilon_i \approx 0$. Thus, it suffices to analyze the linear system:
\begin{equation}
    \dfrac{d}{dt} \begin{pmatrix}
        \vec{u} \\ \vec{v} 
    \end{pmatrix} = J(\vec{0}, \vec{0}) \begin{pmatrix}
        \vec{u} \\ \vec{v}
    \end{pmatrix},
\end{equation}
where the Jacobian $J(\vec{u}, \vec{v})$, for arbitrary $(\vec{u},\vec{v})$, is given by
\begin{equation}
    J(\vec{u}, \vec{v}) = \begin{bmatrix}
        \*0 & \frac{N-1}{m_{mus}} \*I_{N-1} \\
        \frac{\partial \vec{F}}{\partial \vec{u}} & \*0
    \end{bmatrix},
\end{equation}
with $\*I_{N-1} \in \R^{N-1 \times N-1}$ being the identity matrix and  $\frac{\partial \vec{F}}{\partial \vec{u}}$ the tridiagonal matrix of entries 
\begin{equation}
    \left( \dfrac{\partial \vec{F}}{\partial \vec{u}} \right)_{i,i} = -\frac{1}{l_s^{opt}} \left[ \pder{F}{\lambda}(\lambda_{i+1},0) + \pder{F}{\lambda}(\lambda_i, 0) \right]
\end{equation}
and
\begin{equation}
    \left( \dfrac{\partial \vec{F}}{\partial \vec{u}} \right)_{i+1,i} = \left( \dfrac{\partial \vec{F}}{\partial \vec{u}} \right)_{i,i+1} = 
    \frac{1}{l_s^{opt}} \pder{F}{\lambda}(\lambda_i,0).
\end{equation}
In particular, when $(\vec{u},\vec{v}) = (\vec{0},\vec{0})$, we have 
\begin{equation}
    J(\vec{0}, \vec{0}) = \left[ \begin{array}{cc}
        \*0 & \frac{N-1}{m_{mus}} \*I_{N-1} \\
        \frac{1}{l_s^{opt}}\frac{\partial F}{\partial \lambda}(\lambda_M,0) \, \*D_0 & \*0
    \end{array} \right],
\end{equation}
where $\*D_0 \in \R^{N-1 \times N-1}$ is the matrix
\begin{equation}
    \*D_0 = \left[ \begin{array}{ccccc}
        -2 & 1 & 0 & \cdots & 0 \\
        1 & -2 & 1 & \cdots & 0 \\
          & \ddots & \ddots & \ddots\\
        0 &\cdots & 0 & 1 & -2
    \end{array} \right].
\end{equation}
The latter is a matrix typically found in finite difference schemes for ODEs and PDEs (see, e.g., \cite{Strikwerda}). Its eigenvalues are:
\begin{equation}
    \nu_k = -4 \sin^2 \left( \dfrac{k\pi}{2N} \right), \quad k = 1, \dots, N-1.
\end{equation}
Therefore, to find the eigenvalues $\omega_k$ of $J(\vec{0},\vec{0})$, we may use the following identity:
\[
    \det \left(\omega \*I_{2(N-1)} - J(\vec{0}, \vec{0}) \right) = \det \left(\omega^2 \*I_{N-1} - \dfrac{N-1}{l_s^{opt} m_{mus}} \dfrac{\partial F}{\partial \lambda}(\lambda_M, 0) \*D_0 \right),
\]
which gives rise to two cases, depending on the sign of $\frac{\partial F}{\partial \lambda}(\lambda_M, 0)$.

First, if $\frac{\partial F}{\partial \lambda}(\lambda_M, 0) > 0$ (that is, the muscle is contracted on the \textit{ascending} limb of the FL relationship), then the eigenvalues of the Jacobian are:
\begin{equation}
    \omega_k = \pm 2 \dfrac{N-1}{l_s^{opt} m_{mus}} \frac{\partial F}{\partial \lambda}(\lambda_M, 0) \sin \left( \dfrac{k\pi}{2N} \right) i, \quad k = 1, \dots, N-1,
\end{equation}
with $i=\sqrt{-1}$. Although all the eigenvalues are purely complex, they are distinct, and therefore the system \eqref{eq:odes_hill_only_first_order} is stable according to \cite[Theorem 13.1]{HairerNorsettWanner}. 

In contrast, if $\frac{\partial F}{\partial \lambda}(\lambda_M, 0) < 0$ (that is, the muscle is contracted on the \textit{descending} limb of the FL relationship), then the eigenvalues are purely real:
\begin{equation}
    \omega_k = \pm 2 \dfrac{N-1}{l_s^{opt} m_{mus}} \frac{\partial F}{\partial \lambda}(\lambda_M, 0) \sin \left( \dfrac{k\pi}{2N} \right), \quad k = 1, \dots, N-1.
\end{equation}
Therefore, because of the presence of positive eigenvalues, the system \eqref{eq:odes_hill_only_first_order} is unstable. This is a mathematical characterization of the descending limb instability (DLI).

\subsection{A numerical example} \label{sec:stability_numerical_experiment}

Consider as in \cite{YeoEtAl2023NumericalInstability} a muscle of length $L_M = 0.3$ m with maximum isometric force $F_0 = 525 $ N. Without loss of generality, we set the maximum strain rate to $\depsilon_0 = 5$ s$^{-1}$. We also take $N=17$ masses and an initial condition $u_i = \eta_i$, $\dot{u}_i = 0$, for $i=1,\dots,N-1$, with $\eta_i$ being a random variable drawn from a uniform distribution on $[-0.01, 0.01]$.

To observe the DLI, we perform three isometric contractions in different parts of the FL curve:
\begin{enumerate}
    \item On the ascending limb at $\lambda_M = 0.85$,
    \item On the descending limb at $\lambda_M = 1.15$,
    \item On the descending limb but at a point where the derivative of the total FL curve is positive, say $\lambda_M  = 1.45$.
\end{enumerate}
We show these results in Figure \ref{fig:hill_only_unstable}. Here, we see that when $\lambda_M = 0.85$ or $\lambda_M = 1.45$, we have that $\frac{\partial F}{\partial \lambda}(\lambda_M, 0) > 0$ and therefore the system eventually returns to a static equilibrium where all the segments have the same length. However, when $\lambda_M = 1.15$, we have that $\frac{\partial F}{\partial \lambda}(\lambda_M, 0) < 0$ and a bifurcation is produced: muscle segments diverge to two different lengths that produce the same force.

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{05_no_bm_unstable.png}
    \caption{Stability of an isometric contraction according to the system of ODEs \eqref{eq:odes_hill_only}. The elements (as well as the muscle) are stretched initially at around 85\% (left), 115\% (middle), and 145\% (right) of the muscle's optimal length. At an initial stretch of 115\%, the descending limb instability causes the segments to bifurcate to two different lengths.}
    \label{fig:hill_only_unstable}
\end{figure}

\section{Stabilizing the model}

The model \eqref{eq:odes_hill_only} allows for an arbitrary number of contractile units. Therefore, it is perfectly reasonable to assume a large enough $N$ can reduce each contractile unit into the representation of a sarcomere. In this scenario, the DLI would tell us that sarcomeres may undergo sudden overstretching or ``popping'' when the muscle is isometrically contracted at a length beyond optimal. And while this \textit{is} a physiological phenomenon known as \textit{sarcomere popping} \cite{Morgan1990,MorganProske2004,MorganProske2006}, experiments on single myofibrils show a rather stable behaviour of sarcomeres, i.e. no ``popping'' on the scale of a myofibril \cite{JohnstonJinhaHerzog2016}.

Deriving an accurate, stable, and physiologically-informed muscle model is then an almost Sisyphean task. The properties of skeletal muscle tissue are so heterogeneous that the behaviour of a first-stretched-then-activated muscle fibre (which is how the active force curve is constructed) is completely different compared to one which is first activated and then stretched. At the sarcomere level, this active stretching typically yields FL curves that do not have a dip region, leading to forces that are above the maximum isometric force. This phenomenon is known as \textit{residual force enhancement} (RFE) and, at least mathematically, explains why sarcomeres are stable in both ascending and descending limbs of the active FL curve \cite{JoumaaLeonardHerzog2008}. 

History-dependent effects, such as RFE, are typically attributed to \textit{titin}, the largest protein in the human body and a component of the parallel elastic element in sarcomeres. Upon active stretch, titin binds to actin to increase its stiffness \cite{Nishikawa2020}, with a large enough increase that the total FL curve no longer has a dip region (if it had one), thus \textit{convexifying} the curve. In this way, it is no surprise that muscle models that do include titin as an activation-dependent elastic element are stable \cite{HeidlaufEtAl2016,HeidlaufEtAl2017,LemosEtAl2001,Millard2024,SampaioDeOliveiraUchida2025}. 

RFE has always been observed in single muscle fibres from humans and animals \cite{JoumaaLeonardHerzog2008, Pinnell2019,RassierPavlov2012}. However, RFE may not always be observed \textit{in vivo} at the whole muscle level \cite{Bakenecker2020,Chapman2018,Hinks2024}, yet the contractions are still stable. Could there be components different than titin that bring stability to a muscle fibre?

In mathematical terms, the DLI can be overcome by adding \textit{any} stiff-enough elastic element (not necessarily titin) to Hill's model \eqref{eq:Hill_force_stability}. Therefore, it is also not surprising that three-dimensional models are, more often than not, stable given the addition of a passive, base material contribution \cite{AlmonacidEtAl2022_SIAP_Paper}. Hence, we can draw inspiration from these models to add a hyperelastic component to the system \eqref{eq:odes_hill_only} and show that the resulting model is stable on both limbs of the active FL curve. Given that this is performed at the continuum level, we must first introduce a continuum version of the mass-enhanced model by taking the limit as the number of masses $N \to \infty$.

\subsection{The continuum limit of the mass-enhanced model}

Consider the model \eqref{eq:odes_hill_only} but with an additional mass at the right end that is pulled with a constant force $F_{ext}$. Furthermore, assume that $m_i = m_{mus}/N$ and the muscle is not pre-stretched, i.e. $\lambda_M = 1$. In addition, define $l_s^{opt} = L_{mus}^{opt}/N =: \Delta x$. After some algebraic manipulations, the system \eqref{eq:odes_hill_only} becomes:
\begin{subequations} \label{eq:continuum_model_1}
    \begin{align}
        \dfrac{m_{mus}}{L_{mus}^{opt}} \ddot{u}_1 &= \dfrac{F(\lambda_2, \depsilon_2) - F(\lambda_1, \depsilon_1)}{\Delta x}, \\
        \dfrac{m_{mus}}{L_{mus}^{opt}} \ddot{u}_2 &= \dfrac{F(\lambda_3,\depsilon_3) - F(\lambda_2,\depsilon_2)}{\Delta x}, \\
        &\hspace{0.6em} \vdots \notag \\
        \dfrac{m_{mus}}{L_{mus}^{opt}} \ddot{u}_{N} &= \dfrac{F_{ext} - F(\lambda_{N}, \depsilon_{N})}{\Delta x}.
    \end{align}
\end{subequations}
In particular, the segment stretches $\lambda_i$ and strain rates $\depsilon_i$ now read:
\begin{equation} \label{eq:continuum_model_2}
    \lambda_i = 1 + \dfrac{u_i-u_{i-1}}{\Delta x},
\end{equation}
and
\begin{equation} \label{eq:continuum_model_3}
    \depsilon_i = \dfrac{1}{\depsilon_0} \dfrac{d}{dt} \left( \dfrac{u_i-u_{i-1}}{\Delta x} \right).
\end{equation}

We are interested in studying the behaviour of the system \eqref{eq:continuum_model_1}-\eqref{eq:continuum_model_3} as $N \to \infty$, or equivalently, as $\Delta x \to 0$. This is the \textit{continuum limit}. In this case, equations \eqref{eq:continuum_model_2} and \eqref{eq:continuum_model_3} define the following the quantities:
\begin{equation}
    \lambda(x,t) := \lim_{\Delta x \to 0} \lambda_i = 1 + \pder{u}{x},
\end{equation}
and
\begin{equation}
    \depsilon(x,t) = \lim_{\Delta x \to 0} \depsilon_i = \dfrac{1}{\depsilon_0} \pder{}{t}\left(\pder{u}{x} \right) = \dfrac{1}{\depsilon_0} \pder{\lambda}{t}.
\end{equation}
That is, we have recovered the one-dimensional version of the stretch and strain rate variables that are commonly considered in solid mechanics. Moreover, we can make the following claim with respect to the system \eqref{eq:continuum_model_1}.

\begin{claim} \label{cl:hill_pde}
The system of ODEs \eqref{eq:continuum_model_1} corresponds to a first-order method of lines discretization of the partial differential equation (PDE):
\begin{equation} \label{eq:hill_pde_1}
    \rho_{0,L} \pder{^2 u(x,t)}{t^2}  = \pder{F(\lambda(x,t),\depsilon(x,t))}{x}, \quad 0 < x < L_{mus}^{opt}, \quad 0 < t < \infty,
\end{equation}
subject to boundary conditions
\begin{subequations} \label{eq:hill_pde_2}
    \begin{align}
        u(0,t) &= 0, \\
        F(\lambda(\cdot, t),\depsilon (\cdot, t))\Big|_{x=L_{mus}^{opt}} &= F_{ext}(t), \label{eq:Neumann_F_ext}
    \end{align}
\end{subequations}
and initial conditions
\begin{equation} \label{eq:hill_pde_3}
    u(x,0) = \pder{u}{t} = 0.
\end{equation}
Here, $F$ corresponds to Hill's force defined in \eqref{eq:Hill_force_stability} and $\rho_{0,L} := m_{mus}/L_{mus}^{opt}$ is a linear density.
\end{claim}

Note that the Neumann condition \eqref{eq:Neumann_F_ext} to a nonlinear type of boundary condition depending on $\frac{\partial u}{\partial x}$. Thus, the problem \eqref{eq:hill_pde_1}-\eqref{eq:hill_pde_3} is at least well-defined. Whether it is \textit{well-posed} (that is, given a smooth $F_{ext}$, the problem has a unique regular solution depending continuously on $F_{ext}$) is a different story and will not be discussed here. As it is known, this can only be done in limited scenarios (for instance, when $F$ is linear, see \cite{TruesdellNoll2004}), so a general result cannot be stated for arbitrary $F$ and $F_{ext}$.

\begin{proof}
    Consider a discretization $\{x_0, x_1, \dots, x_N\}$ with constant spacing $\Delta x := L_{mus}^{opt}/N$ of the interval $[0,L_{mus}^{opt}]$ where $x_0 = 0$ and $x_N = L_{mus}^{opt}$, then, define $u_i := u(x_i,t)$ for $t \geq 0$, $i=1,\dots,N$. Furthermore, consider a backwards first-order formula for the stretch and strain rates, that is,
    \[
        \lambda_i = \lambda(x_i,t) = 1 + \dfrac{u_i-u_{i-1}}{\Delta x},
    \]
    and
    \[
        \depsilon_i = \depsilon(x_i, t) = \dfrac{1}{\depsilon_0}\dfrac{d\lambda_i}{dt}.
    \]
    These are precisely \eqref{eq:continuum_model_2} and \eqref{eq:continuum_model_3}. Now, to discretize the gradient on the right-hand side of \eqref{eq:hill_pde_1}, consider a forwards first-order difference:
    \[
        \rho_{0,L} \dfrac{d^2 u_i}{dt^2} = \dfrac{F(\lambda_{i+1},\depsilon_{i+1}) - F(\lambda_i, \depsilon_i)}{\Delta x}, \quad i =1, \dots, N.
    \]
    Given that there is not an $x_{N+1}$ mass, the force required at this ``ghost'' node can be taken precisely as $F_{ext}$ according to the boundary condition \eqref{eq:Neumann_F_ext}. Hence, the previous expression is just \eqref{eq:continuum_model_1}.
\end{proof}

\subsection{Convexifying the FL relationship}

Let us introduce a base material component to Hill's force \eqref{eq:Hill_force_stability} assuming that it behaves as Neo-Hookean material:
\begin{equation} \label{eq:force_neohookean}
    F_{NH}(\lambda) = \left\{
        \begin{aligned}
            &F_0 \dfrac{\kappa}{\sigma_0} \left( \widehat{\mathcal{L}}_{\mu} \lambda +  \dfrac{\widehat{\mathcal{L}}_{\lambda} \log(\lambda) - \widehat{\mathcal{L}}_\mu}{\lambda}\right), \quad &\lambda \geq 1, \\
            &0, \quad &\text{otherwise}.
        \end{aligned}
    \right.
\end{equation}
Here, $\kappa$ is the bulk modulus of muscle, $\sigma_0$ is the maximum isometric stress, and the (non-dimensional) Lam\'{e} parameters are given by
\begin{equation}
    \widehat{\mathcal{L}}_{\lambda} = \dfrac{\nu}{(1-\nu)(1-2\nu)}, \quad \widehat{\mathcal{L}}_{\mu} = \dfrac{1}{2(1+\nu)},
\end{equation}
with $\nu$ being the Poisson's ratio of muscle tissue, which can be set to $\nu = 0.499$ owing to the (near-)incompressibility of muscle \cite{Kuthe2016}.

In principle, the PDE \eqref{eq:hill_pde_1} can be seen as a model for the one-dimensional deformation of a muscle fibre in which every point inside is subjected to Hill's force. Therefore, if we think of a fibre as a bundle of myofibrils, then we can consider the components that are in between to be part of the base material of a fibre. These components include (but are not limited to) the sarcoplasmic reticulum and the T-tubules. In this way, we consider the following expression for the muscle force in \eqref{eq:hill_pde_1}:
\begin{equation} \label{eq:force_hill_plus_bm}
    F(\lambda, \depsilon) = (1-\chi_{BM}) F_{Hill}(\lambda, \depsilon) + \chi_{BM} F_{NH}(\lambda),
\end{equation}
where $\chi_{BM}$ denotes the fraction of base material that could be present in a muscle fibre. Thus, the more base material we introduce in the model, the more we can convexify the FL curve. Luckily, $\chi_{BM}$ does not have to be large to bring stability to the system, as we will see in the experiment below.

\subsection{A stabilized mass-enhanced muscle model}

Following the result in Claim \ref{cl:hill_pde}, we can write a stabilized version of \eqref{eq:odes_hill_only} using the force expression \eqref{eq:force_hill_plus_bm}:
\begin{multline} \label{eq:odes_hill_stabilized}
    \quad m_{i-1} \ddot{u}_{i-1} =
    (1-\chi_{BM})\left[ F_{Hill}(\lambda_i, \depsilon_i) - F_{Hill}(\lambda_{i-1}, \depsilon_{i-1}) \right] \\ 
    + \chi_{BM}\left[ F_{BM}(\lambda_i) - F_{BM}(\lambda_{i-1}) \right], \quad i = 1,\dots,N-1, \quad 
\end{multline}
with the stretches $\lambda_i$ and strain rates $\depsilon_i$ as in \eqref{eq:def_stretches_stability} and \eqref{eq:def_strain_rates_stability}, respectively. Then, we can repeat the experiment from Section \ref{sec:stability_zero_solution} to test the stability of the zero solution. In particular, we take in equation \eqref{eq:force_hill_plus_bm} a bulk modulus $\kappa = 10^6 \ \text{Pa}$ and a maximum isometric stress $\sigma_0 = 200 \ \text{kPa}$ \cite{AlmonacidEtAl2022_SIAP_Paper}. Furthermore, we consider $\chi_{BM} = 0.0015$, that is, we assume that 99.85\% of the force that a muscle fibre produces is due to Hill's force and 0.15\% from a base material contribution. 

\begin{figure}
    \centering
    \includegraphics[width=0.45\textwidth]{03_forces_with_bm.png}
    \caption{Forces in the stabilized model \eqref{eq:odes_hill_stabilized}. When the base material component (yellow) is added to the active (blue) and passive (red) forces, the total force (black) is a monotonically increasing function.}
    \label{fig:forces_stabilized}
\end{figure}

First, we portray the resulting forces in Figure \ref{fig:forces_stabilized} where the total force \eqref{eq:force_hill_plus_bm} shows RFE for muscle lengths above optimal (i.e. $\lambda_M > 1$). Then, in Figure \ref{fig:hill_plus_nh_stable} we show the results for the same three isometric contractions as in Section \ref{sec:stability_numerical_experiment} which show (1): no difference for $\lambda_0 = 0.85$ since the Neo-Hookean term does not act for stretches below 1, (2): stabilization on the descending limb of the active FL curve, shown in the figure for $\lambda_0 = 1.15$, and (3): rapid stabilization due to a stiffer passive element. Therefore, it is clear that the base material component has a stabilizing effect in isometric contractions. 

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{06_with_bm_stable.png}
    \caption{Stability of an isometric contraction according to the system of ODEs \eqref{eq:odes_hill_stabilized}. As before, the elements (as well as the muscle) are stretched initially at around 85\% (left), 115\% (middle), and 145\% (right) of the muscle's optimal length. In all cases, the contractions are stable since the derivative of the total force (made of active, passive, and base material components) is always positive.}
    \label{fig:hill_plus_nh_stable}
\end{figure}

\section{Nondimensionalization of the continuum system and the influence of mass}

The elastic model \eqref{eq:hill_pde_1} with the force $F$ given by \eqref{eq:force_hill_plus_bm} can be used to explain the mass effects discussed in Chapter \ref{ch:mass_enhanced_model} in a succinct way. First, let
\begin{equation}
    \widehat{F}_{Hill} = \dfrac{F_{Hill}}{F_0}, \quad \widehat{F}_{NH} = \dfrac{F_{NH}}{F_0},
\end{equation}
denote the nondimensional versions of the Hill and Neo-Hookean force terms. Moreover, consider the following nondimensional variants of the  displacement, space, and time variables:
\begin{equation}
    \widehat{u} = \dfrac{u}{L_{mus}^{opt}}, \quad \widehat{x} = \dfrac{x}{L_{mus}^{opt}}, \quad \widehat{t} = \dfrac{t}{1/\depsilon_0}.
\end{equation}
Plugging these quantities into \eqref{eq:hill_pde_1} we obtain:
\begin{equation} \label{eq:nondim_1}
    \dfrac{\rho_{0,L} (L_{mus}^{opt})^2 \depsilon_0^2}{F_0} \, \pder{^2 \widehat{u}}{\widehat{t}^2} = (1-\chi_{BM}) \widehat{F}_{Hill} + \chi_{BM} \dfrac{\kappa}{\sigma_0} \widehat{F}_{BM}.
\end{equation}
All terms in the previous equation are nondimensional, but we can further rearrange the terms in the left-hand side to obtain a more physically meaningful number. 

Recall that $\rho_{0,L}$ is a \textit{linear} density (it has units of $\text{kg} \ \text{m}^{-1}$). We can convert this quantity into the more common \textit{volumetric} density $\rho_0$ through the cross-sectional area (CSA) of a muscle fibre, that is,
\begin{equation}
    \rho_{0,L} = \rho_0 \cdot CSA.
\end{equation}
Moreover, because the maximum isometric force $F_0$ can be written in terms of the maximum isometric stress as $F_0 = \sigma_0 \cdot CSA$, the number on the left-hand side of \eqref{eq:nondim_1} can be written as
\begin{equation}
    \dfrac{\rho_0 (L_{mus}^{opt})^2 \depsilon_0^2}{F_0} = \dfrac{\rho_0 (L_{mus}^{opt})^2 \depsilon_0}{\sigma_0 / \depsilon_0}.
\end{equation}
The nondimensional number in the previous expression can be viewed as a ratio between inertial forces (due to mass) and viscous forces. As such, we call this number the \textit{musculoskeletal Reynolds number} ($\text{Re}_{MSK}$), akin to the Reynolds number commonly found in fluid dynamics. In this way, we can rewrite \eqref{eq:nondim_1} as:
\begin{equation}
    \text{Re}_{MSK} \pder{^2 \widehat{u}}{\widehat{t}^2} = (1-\chi_{BM}) \widehat{F}_{Hill} + \chi_{BM} \dfrac{\kappa}{\sigma_0} \widehat{F}_{BM}.
\end{equation}

\begin{table}
    \centering
    \begin{tabular}{|c|c|c|} \hline
        $s$ & $\depsilon_0$ [s$^{-1}$] & $\text{Re}_{MSK}$ \\\hline
        1 & 5 & $1.1925 \cdot 10^{-5}$ \\\hline
        1 & 10 & $4.77 \cdot 10^{-5}$ \\\hline
        10 & 5 & $1.1925 \cdot 10^{-3}$  \\\hline
        10 & 10 & $4.77 \cdot 10^{-3}$  \\\hline
    \end{tabular}
    \caption{Variation in the musculoskeletal Reynolds number $\text{Re}_{MSK}$ when a scaling factor $s$ is introduced for two different maximum (unloaded) strain rates (5 $\text{s}^{-1}$ and 10 $\text{s}^{-1}$). Here, $\rho_0 = 1.060 \text{ kg} \ \text{m}^{-3}$, $\sigma_0 = 200 \ \text{kPa}$, $L_{mus}^{opt} = 0.3 \ \text{m}$.}
    \label{tab:re_msk}
\end{table}

Therefore, if the length of the muscle scales by a factor $s$, the rescaled musculoskeletal Reynolds number becomes:
\begin{equation}
    \text{Re}_{MSK} = s^2 \, \dfrac{\rho_0 (L_{mus}^{opt})^2 \depsilon_0}{\sigma_0 / \depsilon_0}.
\end{equation}
This explains why one can expect, in this one-dimensional context, that mass effects are larger for larger scales, longer muscles (such as the semitendinosus), and muscles that contain a higher proportion of faster fibres (i.e., larger $\depsilon_0$). See Table \ref{tab:re_msk} for some values of this nondimensional number. 


\chapter{First order is enough: time discretization alternatives for dynamic Neo-Hookean deformation} \label{ch:neohookean}

%Newmark methods, Rothe's vs. method of lines comparisons. Stiff solvers is (one of) the key mathematical concepts here.
%Github repository: one-dimensional-elasticity

%\medskip

As a prelude to the development of computational tools for the study of dynamic 3D skeletal muscle deformation, we now face the task of finding an appropriate time stepping scheme for this problem. This is an effort to extend the developments of Rahemi \cite{Hadi} and Dominguez \cite{Seba} regarding quasi-static models.  
To accomplish this, we study the performance of different time stepping schemes, from methods used in engineering finite element analysis to Matlab's built-in solvers. However, instead of applying these methods directly to the muscle problem, we study them in the context of one-dimensional Neo-Hookean deformation. This provides us with a simple (yet representative) model to efficiently test different numerical algorithms.

First, we discuss time stepping methods that are commonly used in dynamic analysis of structures, as well as their advantages and disadvantages. Next, we state the model problem and present some of these methods in two different contexts, depending on which variable in the continuous problem is discretized first: time or space. This is a particularly important consideration for nonlinear problems with (potentially) nonsmooth boundary conditions. Then, we present convergence studies for a linear problem and perform experiments of Neo-Hookean deformation. In addition to classic time stepping methods used in engineering, we also study an implicit-explicit (IMEX) method and also Matlab's built-in solvers for systems of ODEs. We finish the chapter with a discussion on the obtained results and what this means for the development of a 3D \textit{dynamic} finite element code for skeletal muscle tissue.

\section{Background}

We start with two discussions that will, hopefully, help the reader understand our choices and results for this chapter: what type of time stepping should we choose and what variable (space or time) should be discretized first.

\subsection{Time stepping schemes in elastodynamics}

The discretization of elastodynamic models is a well established research area in engineering. Tried-and-tested techniques are widely available in modern, commonly used finite element analysis software, such as Ansys Mechanical, Ansys LS-DYNA, COMSOL, and Abaqus. In particular, for linear elastodynamics, well-known time stepping schemes include Newmark-$\beta$ schemes \cite{Newmark}, Wilson-$\theta$ schemes \cite{Wilson}, HHT-$\alpha$ schemes \cite{HHTalpha}, WBZ-$\alpha$ schemes \cite{WBZ}, HP-$\theta_1$ methods \cite{HPtheta}, and more recently, structure-dependent schemes (i.e. numerical methods whose parameters depend on the material properties of the structure) such as those by Chang \cite{ChangSD}. In general, studies in mechanical engineering will claim that a good time stepping scheme for the linear problem must have the following characteristics (see, e.g. \cite{HughesBook, KadapaDettmerPeric2017, RossiEtAl2014}):
\begin{enumerate}
    \item Unconditional stability,
    \item Second-order accuracy,
    \item Being single-step, that is, only one set of implicit equations needs to be solved per time step and the only information needed to do this is from the immediately previous time step,
    \item Controllable numerical dissipation in the higher modes,
    \item Self-starting,
    \item Should not \textit{overshoot} the solution.
\end{enumerate}

\textit{Overshooting} is a phenomenon in which the numerical method ``overestimates'' the solution in the first steps due to the excitation of high-frequency modes (see Figure \ref{fig:overshoot}). This is commonly observed in stiff problems where either non-zero or non-smooth boundary conditions are used. Moreover, all the time schemes mentioned at the beginning of this section, are prone to suffer this problem \cite{MaxamTamma2022}. This means that overshooting is, albeit undesirable, a potentially manageable nuisance. %In the worst case scenario, the numerical algorithm will not be able to damp these oscillations


\begin{figure}
    \centering
    \hspace*{-4em}\includegraphics[width=1.19\textwidth]{figs/overshooting.eps}
    \caption{Example of overshooting in the velocity variable, which causes even higher oscillations in the acceleration.}
    \label{fig:overshoot}
\end{figure}

While numerical methods such as Newmark's or HHT-$\alpha$ do verify characteristics 1-6 above in the context of linear problems, it may not be the case for nonlinear problems. Indeed, at each time step, the nonlinear problem is linearized using strategies such as Newton's method. Thus, if iterative solvers are used to solve the (discretized) linear problem, then multiple linear systems are solved at each Newton iteration, and multiple Newton iterations are performed at each time step. Therefore, second-order accuracy might not be achieved, or if it does, the numerical methods might still exhibit overshooting and oscillations beyond the high-frequency regime \cite{ErlicherBonaventuraBursi2002}.

%In general, numerical methods for nonlinear elastodynamics continues to be an active research area (see, e.g. \cite{ChenEtAl2017Fabrication,JanzBetschFranke2019,LiEtAl2020LargeDefornationDynamics,PellecchiaCesarano2021Hysteretic} and the references therein).

\subsection{Time or space first? Rothe's method versus method of lines}

When it comes to numerical methods for spatio-temporal problems, at least two approaches arise depending on the order in which the variables (space and time) are discretized.

One alternative is to discretize the time variable first while keeping the space variable continuous. This is referred to as \textit{Rothe's method}. For second order parabolic and hyperbolic systems (the latter being the case for elastodynamics), this means that, at each time step, we are bound to solve an elliptic PDE in the space variable. For nonlinear PDEs, the linearization can be performed at a continuous level using, for instance, G\^{a}teaux derivatives. One of the advantages of this method is that, in the context of finite element methods, updates to the mesh can easily be perform since they do not alter the variational formulation of the elliptic problem. However, one major disadvantage is that it is harder to test different time stepping strategies since they involve modifying the structure of the variational formulation itself, which induces significant modifications to the computational solvers.

A different approach is to discretize the space variable first, then the time variable. This is known as the \textit{method of lines (MOL)} and it is how Newmark-type methods are introduced in the engineering literature \cite{HughesBook}. In this case, the parabolic or hyperbolic PDE is transformed into a system of ODEs. This is one of the major advantages of the MOL since it is relatively easy to test multiple time stepping schemes implemented as ODE solvers. However, this also means that the spatial mesh is fixed at all times, which is not amenable to a posteriori mesh refinements (especially at each time step).

%\subsection{Refactor or rewrite the code?}

%Aside from a mathematical choice, there is also a software engineering choice to be made. First, the development of a software to 

%\clearpage

%Based on these differences, and specially for nonlinear problems, the choice of Rothe's method or MOL can lead to completely different computational implementations, which is something that we have to take into account in this project, given the complexity of the computational tools\footnote{The original ``muscle code'' developed by Dominguez Rivera in \cite{Seba} consists of a single C++ file with around 10,000}. As we mentioned at the beginning of this chapter, the main goal is to find an appropriate time stepping scheme for the dynamic model of skeletal muscle deformation. The model (which will be the focus of Part II of this thesis) will consist of a three-field formulation very similar to that of Rahemi \cite{Hadi} and Dominguez Rivera \cite{Seba}. In particular, Dominguez Rivera developed a code which implements Rothe's method for the muscle model with a first order  

%Furthermore, we would like to develop our code by extending the work of Dominguez Rivera \cite{Seba}, while improving its efficiency and  

%Therefore, we begin this search having already a computational implementation of a convergent numerical scheme based on Rothe's method and a first order time discretization \cite{Paper1_WakelingEtAl2020}, which we would like to resue. Unfortunately, this particular discretization only works for quasi-static problems (e.g. \cite{Paper2_RyanEtAl2020}), and problems involving passive muscle \cite{KonnoEtAl2022_CP} or muscles with low levels of activation \cite{Cassidy}.

%\clearpage

\section{Model problem for nonlinear elasticity}

Consider a one-dimensional solid (which we may refer to as a ``rod'') of linear density $\rho_{0,L}$ and cross-sectional area $A_0$ that occupies the region $\Omega = [0,L]$. Furthermore, let $u = u(x,t)$ denote the displacement of a point $x$ at time $t$. We consider the following model for the deformation of this rod subject to a prescribed displacement $g = g(t)$ at one of its ends:
\begin{subequations} \label{eq:elasticity_1d}
    \begin{gather}
        \label{eq:elasticity_1d_1}\rho_0 u_{tt} = P_x \quad \text{in }\Omega \times (0,\infty), \\
	    u(x,0) = 0, \quad u_t(x,0) = 0 \quad \text{in } \Omega \times \{t=0\} \\
	    u(0,t) = 0, \quad u(L,t) = g(t) \quad \text{in } (0,\infty).
    \end{gather}
\end{subequations}
Here, $\rho_0 = \rho_{0,L} / A_0$ is a volumetric density and $P = P(\lambda)$ is a constitutive equation for the stress of the material depending on the stretch $\lambda := u_x + 1$. The equation above is very similar to \eqref{eq:hill_pde_1} but with a stress $P$ instead of a force $F$ to match the dimensions of the left-hand side of \eqref{eq:elasticity_1d_1}. 

\section{A first order time stepping scheme}

Let us first consider a first order scheme inspired by previous works on skeletal muscle modelling (e.g. \cite{Seba,Paper1_WakelingEtAl2020}). To keep the focus on the time discretization, all methods will feature a spatial discretization based on second-order Lagrange finite elements.

\subsection{Rothe's method and finite element formulation} \label{sec:rothe_first_order}

First, we convert the PDE \eqref{eq:elasticity_1d_1} into a system of first order PDEs. Then, we discretize the time derivatives using a first-order backwards formula. This yields the following semi-discrete problem for $n \geq 0$:
\begin{subequations} \label{eq:rothe_first_order}
    \begin{gather}
        \label{eq:disc_u} \frac{u^{n+1}-u^n}{\Delta t} = v^{n+1}, \\
	    \label{eq:disc_v} \rho_0 \left( \frac{v^{n+1}-v^n}{\Delta t} \right) = 
        P(\lambda^{n+1})_x,
    \end{gather}
\end{subequations}
where $\lambda^{n+1} = \partial_x u^{n+1} + 1$. Combining these two equations into a single one for $u^{n+1}$ yields:
\begin{equation} \label{eq:rothe_first_order_combined}
	\rho_0 u^{n+1} - \Delta t^2 P(\lambda^{n+1})_x = \rho_0 (u^n + \Delta t v^n), \quad n \geq 0.
\end{equation}
Then, we take steps to discretize the space variable as specified at the beginning of this section. Multiplying \eqref{eq:rothe_first_order_combined} by a test function $w \in H_0^1(\Omega)$ and integrating by part we obtain the nonlinear variational formulation: find $u^{n+1} \in  H^1(\Omega)$ such that $u^{n+1}(0) = 0$, $u^{n+1}(L) = g(t^{n+1})$, and
\begin{equation} \label{eq:rothe_first_order_VF}
	R(u^{n+1}, w) = 0 \quad \forall \ w \in H_0^1(\Omega),
\end{equation}
where $R:H^1(\Omega) \times H_0^1(\Omega) \to \R$ is the functional defined by
\begin{equation}
    R(u^{n+1},w) = \rho_0 \int_0^L u^{n+1} w + \Delta t^2 \int_0^L P(\lambda^{n+1}) w_x - \rho_0 \int_0^L (u^n + \Delta t v^n) w.
\end{equation}

\subsubsection*{Linearization of the semi-discrete problem}

We linearize the nonlinear problem \eqref{eq:rothe_first_order_VF} using Newton's method. The $k$-th iteration thus reads: find increments $du_k^{n+1}$ such that
\begin{equation} \label{eq:rothe_first_order_lin_1}
    \mathcal{D}R[u_k^{n+1}](du_k^{n+1}, w) = - R(u_k^{n+1}, w) \quad \forall \ w \in H_0^1(\Omega),
\end{equation}
where $\mathcal{D}R$ is the Gâteaux derivative of $R$ and can be computed as:
\begin{equation}
    \mathcal{D}R[u](du,w) = \lim_{\epsilon \to 0} \dfrac{d}{d\epsilon} R(u + \epsilon du, w).
\end{equation}
Therefore, the linear problem \eqref{eq:rothe_first_order_lin_1} becomes: find Newton increments $du_k^{n+1} \in H^1(\Omega)$ such that $du_0^{n+1} = 0$ on $x=0$, $du_0^{n+1} = g(t^{n+1}) - g(t^{n})$ on $x=L$, $du_k^{n+1} = 0$ on $x=0,L$ for k > 0, and:
\begin{multline} \label{eq:rothe_first_order_lin_2}
	\rho_0 \int_0^L du_k^{n+1} \, w + \Delta t^2 \int_0^L \der{P}{\lambda}(\lambda_k^{n+1}) \der{(du_k^{n+1})}{x} \der{w}{x} = \\
	-\rho_0 \int_0^L u_k^{n+1} w - \Delta t^2 \int_0^L P(\lambda_k^{n+1}) \der{w}{x} + \rho_0 \int_0^L (u^n+\Delta t v^n) w,
\end{multline}
for any $w \in H_0^1(\Omega)$, where $\lambda_k^{n+1} = \partial_x u_k^{n+1} + 1$. The linear problem \eqref{eq:rothe_first_order_lin_2} is solved for each $k \geq 0$ and the displacement is updated as $u_{k+1}^{n+1} = u_k^{n+1} + du_k^{n+1}$ until the following convergence criterion is satisfied:
\begin{equation} \label{eq:convergence_crit_1d}
    \| du_k^{n+1} \| \leq tol_u \quad \text{and} \quad \| R(u_k^{n+1}) \| \leq tol_R,
\end{equation}
where $\|\cdot\|$ is a discrete norm (e.g. the Euclidean norm) arising from the discretized versions (see below) of the Newton update $du_k^{n+1}$ and the right-hand side of \eqref{eq:rothe_first_order_lin_1}.

\subsubsection*{Finite element formulation}

For the linear problem \eqref{eq:rothe_first_order_lin_2}, we consider the following Galerkin scheme: find Newton increments $du_{h,k}^{n+1} \in V_h$ such that 
\begin{multline} \label{eq:rothe_first_order_lin_3}
	\rho_0 \int_0^L du_{h,k}^{n+1} \, w_h + \Delta t^2 \int_0^L \der{P}{\lambda}(\lambda_{h,k}^{n+1}) \der{(du_{h,k}^{n+1})}{x} \der{w_h}{x} = \\
	-\rho_0 \int_0^L u_{h,k}^{n+1} w - \Delta t^2 \int_0^L P(\lambda_{h,k}^{n+1}) \der{w_h}{x} + \rho_0 \int_0^L (u_h^n+\Delta t v_h^n) w_h,
\end{multline}
for any $w_h \in V_h$. Here, $V_h$ is the space of second order Lagrange finite elements:
\begin{equation} \label{eq:fespace_1d}
    V_h = \left\{ v_h \in \mathcal{C}(\overline{\Omega}) \ : \ v_h \big|_T \in \mathbb{P}_2(T) \quad \forall \ T \in \mathcal{T}_h \right\},
\end{equation}
where $\mathcal{C}(\overline{\Omega})$ is the space of continuous functions over $\overline{\Omega} = [0,L]$, $\mathbb{P}_2(T)$ is the space of quadratic polynomials over a segment $T \subset [0,L]$, and $\mathcal{T}_h$ is a triangulation of the interval $[0,L]$. Therefore, if $\{x_0,x_1,\dots,x_{N+1}\}$ is a discretization of the interval $[0,L]$ with $x_0 = 0$ and $x_{N+1}=L$, then, $\mathcal{T}_h = \left\{ [x_i,x_{i+1}] \right\}_{i=0}^N$.

\subsubsection*{Notation for the local problems}

First, let $T \in \mathcal{T}_h$ be an arbitrary interval of the triangulation $\mathcal{T}_h$ with endpoints $x_i$ and $x_{i+1}$, that is, $T = [x_i,x_{i+1}]$. Then, consider the linear transformation $\mathcal{F}:\widehat{T} \to T$ that maps elements from the ``reference'' interval $\widehat{T}=[0,1]$ to an arbitrary interval $T$:
\begin{equation}
    \mathcal{F}(\widehat{x}) := B\widehat{x} + b = x,
\end{equation}
where $B := x_{i+1}-x_i$, $b := x_i$. Therefore, given a function $u:T \to \R$, we can define $\widehat{u}:\widehat{T}\to\R$ as
\[
    \widehat{u} = u \circ \mathcal{F},
\]
from which we obtain the following identities that will help us move from an arbitrary interval $T$ to the reference interval $\widehat{T}$:
\begin{gather}
    \label{eq:du_hat_dx_hat_identity}\der{\widehat{u}}{\widehat{x}} = B \der{u}{x}, \\
    \int_T u \ dx  = B \int_{\widehat{T}} \widehat{u} \ d\widehat{x}, \\
    \int_T \der{u}{x} \der{w}{x} \ dx = B^{-1} \int_{\widehat{T}} \der{\widehat{u}}{\widehat{x}} \der{\widehat{w}}{\widehat{x}} \ d\widehat{x}.
\end{gather}

Furthermore, any element in $u \in \mathbb{P}_2(T)$ can be written as:
\begin{equation} \label{eq:fe_expansion_T}
    u(x) = \sum_{i=1}^3 p_i(x)u_i,
\end{equation}
where
\begin{subequations} \label{eq:lagrange_basis_T}
    \begin{align}
        &p_1(x) = \dfrac{(x-x_{i+1/2})(x-x_{i+1})}{(x_i-x_{i+1/2})(x_i-x_{i+1})},\\
        &p_2(x) = \dfrac{(x-x_i)(x-x_{i+1})}{(x_{i+1/2}-x_i)(x_{i+1/2}-x_{i+1})}, \\
        &p_3(x) = \dfrac{(x-x_i)(x-x_{i+1/2})}{(x_{i+1}-x_i)(x_{i+1}-x_{i+1/2}),}
    \end{align}
\end{subequations}
with $x_{i+1/2} = (x_i+x_{i+1})/2$. Equation \eqref{eq:fe_expansion_T} can be compactly written as
\begin{equation}
    u = [\*P][\*u],
\end{equation}
where
\[
[\*P] := (p_1 \quad p_2 \quad p_3)_{1\times 3}, \quad [\*u] = \begin{pmatrix}
    u_1 \\ u_2 \\ u_3
\end{pmatrix}_{3 \times 1}.
\]
Thus, the mapped expression $\widehat{u} = u \circ \mathcal{F}$ can be written as
\begin{equation}
    \widehat{u} = \sum_{i=1}^3 \widehat{p}_i(\widehat{x}) u_i = [\widehat{\*P}][\*u],
\end{equation}
where
\[
[\widehat{\*P}] := (\widehat{p}_1 \quad \widehat{p}_2 \quad \widehat{p}_3)_{1\times 3}
\]
and
\begin{subequations}
    \begin{align}
        &\widehat{p}_1(x) = (1-2\widehat{x})(1-\widehat{x}), \\
        &\widehat{p}_2(x) = 4\widehat{x}(1-\widehat{x}), \\
        &\widehat{p}_3(x) = \widehat{x}(2\widehat{x}-1).
    \end{align}
\end{subequations}
These shape functions are meant to interpolate the nodes $\widehat{a}_1 = 0$, $\widehat{a}_2 = 1/2$, and $\widehat{a}_3 = 1$, that is, $\widehat{p}_i(\widehat{a}_j) = \delta_{ij}$ for $i,j=1,2,3$, with $\delta_{ij}$ being the delta Kronecker.  In addition, for the derivative of $\widehat{u}$, we may write:
\begin{equation}
    \der{\widehat{u}}{\widehat{x}} = \sum_{i=1}^3 \der{\widehat{p}_i}{\widehat{x}}(\widehat{x}) u_i = [\widehat{\*D} \widehat{\*P}] [\*u],
\end{equation}
where
\[
    [\widehat{\*D} \widehat{\*P}]  = \left(  \der{\widehat{p}_1}{\widehat{x}} \quad \der{\widehat{p}_2}{\widehat{x}} \quad \der{\widehat{p}_3}{\widehat{x}} \right)_{1 \times 3},
\]
with an analogous expression for the derivative of $u$ using the identity \eqref{eq:du_hat_dx_hat_identity}. 

\subsubsection*{Local contributions and fully discrete system}

Restricted to an element $T = [x_i,x_{i+1}] \in \mathcal{T}_h$, we can write \eqref{eq:rothe_first_order_lin_3} as:
\begin{multline} \label{eq:rothe_first_order_lin_4}
	\rho_0 \int_T du_{h,k}^{n+1} \, w_h + \Delta t^2 \int_T \der{P}{\lambda}(\lambda_{h,k}^{n+1}) \der{(du_{h,k}^{n+1})}{x} \der{w_h}{x} = \\
	-\rho_0 \int_T u_{h,k}^{n+1} w - \Delta t^2 \int_T P(\lambda_{h,k}^{n+1}) \der{w_h}{x} + \rho_0 \int_T (u_h^n+\Delta t v_h^n) w_h,
\end{multline}
where each term can be fully computed following the ideas introduced above (we drop the $h$ subscript for better readability). First, the terms on the left-hand side of \eqref{eq:rothe_first_order_lin_4} (recall that $B=x_{i+1}-x_i$):
\begin{align}
    \rho_0 \int_T du_{k}^{n+1} \, w 
    \notag &= \rho_0 B \int_{\widehat{T}} \widehat{du_k^{n+1}} \widehat{w}  \\
    \notag &= \rho_0 B \int_{\widehat{T}} \ [\widehat{\*P}][\*d\*u_k^{n+1}] [\widehat{\*P}][\*w] \\
    \notag &= [\*w]^\top \left( \rho_0 B \int_{\widehat{T}} \ [\widehat{\*P}]^\top [\widehat{\*P}] \right) [\*d\*u_k^{n+1}] \\
    &=: [\*w]^\top \*M_T  \, [\*d\*u_k^{n+1}],
\end{align}
and
\begin{align}
    \int_T \der{P}{\lambda}(\lambda_{k}^{n+1}) &\der{(du_{k}^{n+1})}{x} \der{w}{x} \notag\\
    \notag &= B^{-1} \int_{\widehat{T}} \der{P}{\lambda}\left(\widehat{\lambda_{k}^{n+1}}\right) \der{(\widehat{du_{k}^{n+1}})}{x} \der{\widehat{w}}{x} \\
    \notag &=  B^{-1} \int_{\widehat{T}} \der{P}{\lambda}\left( B^{-1} [\widehat{\*D} \widehat{\*P}] [\*u_k^{n+1}] + 1 \right) [\widehat{\*D}\widehat{\*P}][\*d\*u_{k}^{n+1}][\widehat{\*D}\widehat{\*P}] [\*w] \\
    \notag &= [\*w]^\top  \left(  B^{-1} \int_{\widehat{T}}\der{P}{\lambda}\left( B^{-1} [\widehat{\*D} \widehat{\*P}] [\*u_k^{n+1}] + 1 \right) [\widehat{\*D}\widehat{\*P}]^\top [\widehat{\*D}\widehat{\*P}] \right) [\*d\*u_{k}^{n+1}] \\
    &=: [\*w]^\top \*K_T \, [\*d\*u_{k}^{n+1}].
\end{align}
The terms $\*M_T$ and $\*K_T$ are local contributions to the global mass and stiffness matrices $\*M$ and $\*K$, respectively. Following \cite{HughesBook}, we denote the assembly process by:
\begin{equation} \label{eq:rothe_first_order_M_K}
    \*M = \assembly_{T\in\mathcal{T}_h} \*M_T, \quad \*K = \assembly_{T \in \mathcal{T}_h} \*K_T.
\end{equation}
Next, we compute the terms on the right-hand side of \eqref{eq:rothe_first_order_lin_4}:
\begin{align}
    \rho_0 \int_T u_{k}^{n+1} w 
    \notag &= \rho_0 B \int_{\widehat{T}} [\widehat{\*P}] [\*u_k^{n+1}] [\widehat{\*P}][\*w] \\
    \notag &= [\*w]^\top \left( \rho_0 B \int_{\widehat{T}} \ [\widehat{\*P}]^\top [\widehat{\*P}] [\*u_k^{n+1}] \right) \\
    &=: [\*w]^\top \*F^{(1)}_T,
\end{align}
\begin{align}
    \Delta t^2 \int_T P(\lambda_{k}^{n+1}) \der{w}{x} 
    \notag &= \Delta t^2 \int_{\widehat{T}} P\left( B^{-1} [\widehat{\*D} \widehat{\*P}] [\*u_k^{n+1}] + 1 \right) [\widehat{\*D}\widehat{\*P}] [\*w] \\
    &= [\*w]^\top \left( \Delta t^2 \int_{\widehat{T}} P\left( B^{-1} [\widehat{\*D} \widehat{\*P}] [\*u_k^{n+1}] + 1 \right) [\widehat{\*D}\widehat{\*P}]^\top \right) \\
    &=: [\*w]^\top \*F^{(2)}_T,
\end{align}
and
\begin{align} \label{eq:rothe_first_order_lin_5}
    \rho_0 \int_T (u^n+\Delta t v^n) w 
    \notag &= \rho_0 B \int_{\widehat{T}} \ [\widehat{\*P}] \left([\*u^n] + \Delta t [\*v^n]\right) [\widehat{\*P}] [\*w] \\
    \notag &= [\*w]^\top \left(\rho_0 B \int_{\widehat{T}} \ [\widehat{\*P}]^\top [\widehat{\*P}] \left([\*u^n] + \Delta t [\*v^n]\right)  \right) \\
    &=: [\*w]^\top \*F^{(3)}_T.
\end{align}
These are contributions to the load vector $\*F$ which can be computed as
\begin{equation} \label{eq:rothe_first_order_F}
    \*F = \assembly_{T \in \mathcal{T}_h} \*F^{(1)}_T + \*F^{(2)}_T + \*F^{(3)}_T.
\end{equation}

In conclusion, the fully discrete system that arises from the Galerkin formulation 
\eqref{eq:rothe_first_order_lin_3} is:
\begin{equation} \label{eq:rothe_first_order_linear}
    (\*M + \Delta t^2 \*K) \*d\*u_k^{n+1} = \*F,
\end{equation}
with $\*M$, $\*K$, and $\*F$ as in \eqref{eq:rothe_first_order_M_K} and \eqref{eq:rothe_first_order_F}.

\subsection{Method of lines} \label{sec:mol_first_order}

In this case, we first discretize the problem in \textit{space}. To begin with, we construct a weak formulation for \eqref{eq:elasticity_1d_1} by multiplying the PDE by a test function $w \in H_0^1(\Omega)$ and integrate by parts in space:
\begin{equation}
	\rho_0 \int_0^L u_{tt} w + \int_0^L P(\lambda) w_x = 0.
\end{equation} 
Then, the Galerkin scheme reads: find $u_h \in V_h$ such that
\begin{equation} \label{eq:mol_first_order_galerkin}
	\rho_0 \int_0^L u_{h,tt} w_h + \int_0^L P(\lambda_h) w_{h,x} = 0 \quad \forall \, w_h \in V_h.
\end{equation} 
As before, we consider $V_h$ given by \eqref{eq:fespace_1d} and a discretization $\mathcal{T}_h$ of the interval $[0,L]$, i.e. $\mathcal{T}_h = \{ [x_i,x_{i+1}] \}_{i=0}^N$. In this case, for $T \in \mathcal{T}_h$, we can write
\begin{equation}
    u_h(x,t)\Big|_T = \sum_{i=1}^3 p_i(x)u_i(t),
\end{equation}
with $p_i$ the shape functions given in \eqref{eq:lagrange_basis_T}. After computing the local contributions as in \eqref{eq:rothe_first_order_lin_4}-\eqref{eq:rothe_first_order_lin_5}, the Galerkin scheme \eqref{eq:mol_first_order_galerkin}
reduces to the nonlinear system of equations:
\begin{equation} \label{eq:mol}
	\*M \ddot{\*U} + \*K(\*U) = \*0,
\end{equation}
where $\*U = \left( u_0(t), \dots, u_{2N+1}(t) \right)^\top$ and $\*M$ is again the mass matrix:
\begin{equation}
    \*M = \assembly_{T \in \mathcal{T}_h} \*M_T, \quad \*M_T = \rho_0 B \int_{\widehat{T}} \ [\widehat{\*P}]^\top [\widehat{\*P}],
\end{equation}
but now $\*K(\*U)$ is the stiffness \textit{vector}:
\begin{equation} \label{eq:mol_first_order_def_stiffness_vector}
    \*K = \assembly_{T \in \mathcal{T}_h} \*K(\*U)_T, \quad \*K(\*U)_T = \int_{\widehat{T}} P\left( B^{-1} [\widehat{\*D}\widehat{\*P}][\*u(t)] + 1 \right) [\widehat{\*D}\widehat{\*P}]^\top.
\end{equation}

At this juncture, we can use any appropriate ODE solver for the nonlinear system \eqref{eq:mol}. Hence, let us consider first the same first order scheme as in \eqref{eq:rothe_first_order}:
\begin{subequations} \label{eq:mol_first_order}
    \begin{gather}
        \dfrac{\*U^{n+1} - \*U^{n}}{\Delta t} = \*V^{n+1}, \\
	    \*M \left( \frac{\*V^{n+1} - \*V^n}{\Delta t} \right) + \*K(\*U^{n+1}) = \*0.
    \end{gather}
\end{subequations}
Combining these two equations yields:
 \begin{equation} \label{eq:mol_first_order_nonlinear}
	\*M \*U^{n+1} + \Delta t^2 \*K(\*U^{n+1}) = \*M(\*U^n + \Delta t \*V^n).	
 \end{equation}
The equation above is a nonlinear system of equations that can be rewritten as:
 \begin{eqnarray}
     \*R(\*U^{n+1}) := \*M \*U^{n+1} + \Delta t^2 \*K(\*U^{n+1}) - \*M(\*U^n + \Delta t \*V^n) = \*0.
 \end{eqnarray}
 Hence, a Taylor expansion reveals the Newton iteration to follow:
 \begin{equation}
     \*R(\*U^{n+1}_{k+1}) = \*R(\*U^{n+1}_k) + \pder{\*R}{\*U^{n+1}}(\*U_k^{n+1}) \Delta \*U_{k}^{n+1} + \dots = \*0,
 \end{equation}
 that is,
 \begin{equation}
     \pder{\*R}{\*U^{n+1}}(\*U_k^{n+1}) \Delta \*U_{k}^{n+1} = -\*R(\*U_k^{n+1}).
 \end{equation}
 Therefore, the Newton iteration for the nonlinear problem \eqref{eq:mol_first_order_nonlinear} reads: find $\Delta \*U_{k}^{n+1}$ such that:
 \begin{equation} \label{eq:mol_first_order_linear}
     \left[ \*M + \Delta t^2 \pder{\*K}{\*U}(\*U_k^{n+1}) \right] \Delta \*U_{k}^{n+1} = - \*M \*U_k^{n+1} - \Delta t^2 \*K(\*U_k^{n+1}) + \*M(\*U^n + \Delta t \*V^n).
 \end{equation}
Then, we can update the displacements $\*U_{k+1}^{n+1} = \*U_k^{n+1} + \Delta \*U_{k}^{n+1}$. The new (matrix) term $\pder{\*K}{\*U}$ can be computed from \eqref{eq:mol_first_order_def_stiffness_vector} as:
\begin{equation} \label{eq:jacobian_dK_dU}
    \pder{\*K}{\*U}(\*U_k^{n+1})  = \assembly_{T \in \mathcal{T}_h} B^{-1} \int_{\widehat{T}} \der{P}{\lambda} \left(B^{-1} [\widehat{\*D}\widehat{\*P}][\*u_k^{n+1}] + 1 \right) [\widehat{\*D}\widehat{\*P}]^\top[\widehat{\*D}\widehat{\*P}].
\end{equation}
In this case, the fully discrete linear system of equations \eqref{eq:mol_first_order_linear} completely coincides with \eqref{eq:rothe_first_order_linear}. However, the structure of the MOL allows for more vectorized operations, which can eventually reduce the computational time of solvers and reduce roundoff errors.

\section{Newmark schemes}

To introduce Newmark's method, let us consider the initial value problem:
\begin{subequations} \label{eq:generic_2nd_order_ODE}
\begin{gather}
    y'' = \varphi(t,y,y'), \quad 0 \leq t \leq T \\
    y(0) = y_0, \quad y'(0) = z_0,
\end{gather}
\end{subequations}
where $\varphi:[0,T] \times \R \times \R \to \R$ is a continuous function and $y_0,z_0 \in \R$. Introducing a time step size $\Delta t = T/N$ and time steps $t_n = n \Delta t$, $n=0,\dots,N$, we seek approximations $y_n \approx y(t_n)$ and $z_n \approx y'(t_n)$. For any smooth enough function $y = y(t)$, we have
\begin{subequations}
    \begin{align}
        &y(t_{n+1}) = y(t_n) + \Delta t y'(t_n) + \dfrac{\Delta t^2}{2} \left[ (1-2\beta)y''(t_n) + 2\beta y''(t_{n+1}) \right] + \mathcal{O}(\Delta t^3), \\
        &y'(t_{n+1}) = y'(t_n) + \Delta t \left[(1-\gamma)y''(t_n) + \gamma y''(t_{n+1}) \right] + \mathcal{O}(\Delta t^2),
    \end{align}
\end{subequations}
where $\beta,\gamma \in \R$. Hence, if $y$ satisfies \eqref{eq:generic_2nd_order_ODE}, then the equations above read:
\begin{subequations}
    \begin{align}
        &\begin{multlined}
            y(t_{n+1}) = y(t_n) + \Delta t y'(t_n) + \dfrac{\Delta t^2}{2} \left[ (1-2\beta) \varphi(t_n, y(t_n), y'(t_n)) \right. \qquad \qquad \\
            \left. + 2\beta \varphi(t_{n+1}, y(t_{n+1}), y'(t_{n+1})) \right] + \mathcal{O}(\Delta t^3), 
        \end{multlined}
         \\
        &\begin{multlined}
            y'(t_{n+1}) = y'(t_n) + \Delta t \left[(1-\gamma)\varphi(t_n, y(t_n), y'(t_n)) \right. \hspace*{9.5em}\\
            \left. + \gamma  \varphi(t_{n+1}, y(t_{n+1}), y'(t_{n+1})) \right] + \mathcal{O}(\Delta t^2). 
        \end{multlined}
    \end{align}
\end{subequations}
Therefore, Newmark's method consists on finding pairs $(y_n,z_n)$ such that
\begin{subequations} \label{eq:newmark}
    \begin{align}
        &y_{n+1} = y_n + \Delta t z_n + \dfrac{\Delta t^2}{2} \left[ (1-2\beta)\varphi_{n+1} + 2\beta \varphi_n \right], \\
        &z_{n+1} = z_n + \Delta t \left[(1-\gamma) \varphi_n + \gamma \varphi_{n+1} \right],
    \end{align}
\end{subequations}
where $\varphi_n = \varphi(t_n, y_n, z_n)$. In terms of accuracy, the scheme is first order if $\gamma \neq 1/2$ and second order if $\gamma = 1/2$. Furthermore, the scheme is unconditionally stable if $1/2 \leq \gamma \leq 2\beta$ (cf. \cite{HughesBook,raviartthomas}). In particular, we will consider $\beta=1/4$ and $\gamma=1/2$, which corresponds to the \textit{average acceleration} method\footnote{Some other well-known members of Newmark family of schemes are the \textit{linear acceleration} method ($\beta=1/6$, $\gamma=1/2$), the \textit{Fox-Goodwin (royal road)} method ($\beta=1/12$, $\gamma=1/2$), and the \textit{central differences} method ($\beta=0$, $\gamma=1/2$) \cite{HughesBook}}.

\subsection{Newmark in the context of Rothe's method} \label{sec:rothe_newmark}

Let us define the velocity $v = u_t$ and the acceleration $a = u_{tt}$, then discretize the nonlinear elasticity equation \eqref{eq:elasticity_1d_1} using the Newmark scheme \eqref{eq:newmark}:
\begin{subequations} \label{eq:rothe_newmark}
    \begin{align}
        \label{eq:newmark_2}&u^{n+1} = u^n + \Delta t v^n + \frac{\Delta t^2}{2} \left[ (1-2\beta) a^n + 2 \beta a^{n+1} \right], \\
        \label{eq:newmark_1}&v^{n+1} = v^n + \Delta t \left[ (1-\gamma) a^n + \gamma a^{n+1} \right], \\
	    \label{eq:newmark_3}& \rho_0 a^{n+1} = P(\lambda^{n+1})_x.
    \end{align}
\end{subequations}
Next, we define the following ``predictors'' which only require information from the previous time step:
\begin{subequations} \label{eq:rothe_newmark_predictors}
    \begin{align}
	    & \widetilde{u^{n+1}} = u^n + \Delta t v^n + \frac{\Delta t^2}{2} (1-2\beta) a^n, \\
        & \widetilde{v^{n+1}} = v^n + \Delta t (1-\gamma) a^n.
    \end{align}
\end{subequations}
Then, in the Rothe framework, a displacement-based method reads:
\begin{subequations}
    \begin{align}
        \label{eq:rothe_newmark_1}&\rho_0 u^{n+1} - \beta \Delta t^2  P(\lambda^{n+1})_x = \rho_0 \widetilde{u^{n+1}}, \\
	    &a^{n+1} = \frac{u^{n+1}-\widetilde{u^{n+1}}}{\beta \Delta t^2} \\
	    &v^{n+1} = v^n + \Delta t \left[ (1-\gamma) a^n + \gamma a^{n+1} \right].
    \end{align}
\end{subequations}
Multiplying \eqref{eq:rothe_newmark_1} by a test function $w \in H_0^1(\Omega)$ and integrating by parts yields the nonlinear weak problem: find $u^{n+1} \in  H^1(\Omega)$ such that $u^{n+1}(0) = 0$, $u^{n+1}(L) = g(t^{n+1})$, and
\begin{equation}
    \rho_0 \int_0^L u^{n+1}w + \beta \Delta t^2 \int_0^L P(\lambda^{n+1}) \der{w}{x} = \rho_0 \int_0^L \widetilde{u^{n+1}}w.
\end{equation}
Proceding as before, the Newton increment can be found by solving the problem: find $du_k^{n+1}$ such that
\begin{multline} 
	\rho_0 \int_0^L du_k^{n+1} \, w + \beta \Delta t^2 \int_0^L \der{P}{\lambda}(\lambda_k^{n+1}) \der{(du_k^{n+1})}{x} \der{w}{x} = \\
	-\rho_0 \int_0^L u_k^{n+1} w - \beta \Delta t^2 \int_0^L P(\lambda_k^{n+1})  \der{w}{x} + \rho_0 \int_0^L \widetilde{u^{n+1}} w.
\end{multline}

A fully discrete system can be obtained using the same steps as in Section \ref{sec:rothe_first_order}, so we omit further details.

\subsection{Newmark in the context of the MOL} \label{sec:mol_newmark}

Going back to the nonlinear system of ODEs \eqref{eq:mol}, Newmark's method translates into the following set of equations, where we define the velocity $\*V = \dot{\*U}$ and the acceleration $\*A = \ddot{\*U}$:
\vspace*{-1.2em}
\begin{subequations} \label{eq:mol_newmark}
    \begin{align}
        \label{eq:mol_newmark_1}&\*U^{n+1} = \*U^n + \Delta t \*V^n + \dfrac{\Delta t^2}{2} \left[ (1-2\beta) \*A^n + 2\beta \*A^{n+1} \right], \\
	    \label{eq:mol_newmark_2}&\*V^{n+1} = \*V^n + \Delta t \left[ (1-\gamma) \*A^n + \gamma \*A^{n+1} \right], \\
	    \label{eq:mol_newmark_3}&\*M \*A^{n+1} + \*K(\*U^{n+1}) = \*0.
    \end{align}
\end{subequations}
We note that this is typically how Newmark's method is introduced in the engineering literature (see, e.g., \cite{HughesBook}). To obtain a displacement-based method, we first define the predictors:
\vspace*{-1.2em}
\begin{subequations}
    \begin{align}
        \label{eq:pred_u}&\widetilde{\*U^{n+1}} = \*U^n + \Delta t \*V^n + \frac{\Delta t^2}{2} (1-2\beta) \*A^n, \\
        \label{eq:pred_v}&\widetilde{\*V^{n+1}} = \*V^n + \Delta t (1-\gamma) \*A^n.
    \end{align}
\end{subequations}
Thus, the expression for the displacements and velocities at time $t_{n+1}$, that is \eqref{eq:mol_newmark_1} and \eqref{eq:mol_newmark_2}, read:
\begin{subequations}
    \begin{align}
        &\*U^{n+1} = \widetilde{\*U^{n+1}} + \Delta t^2 \beta \*A^{n+1}, \\
        &\*V^{n+1} = \widetilde{\*V^{n+1}} + \Delta t \gamma \*A^{n+1}.
    \end{align}
\end{subequations}
Furthermore, using these newly defined predictors, the system \eqref{eq:mol_newmark} now reads:
\begin{subequations}
    \begin{align}
    \label{eq:mol_newmark_disp_1} & \*M \*U^{n+1} + \beta \Delta t^2 \*K(\*U^{n+1}) = \*M \widetilde{\*U^{n+1}}, \\
	& \*A^{n+1} = \dfrac{\*U^{n+1} - \widetilde{\*U^{n+1}}}{\Delta t^2}, \\
	& \*V^{n+1} = \*V^n + \Delta t \left[ (1-\gamma) \*A^n + \gamma \*A^{n+1} \right].
    \end{align}
\end{subequations}
Equation \eqref{eq:mol_newmark_disp_1} is a nonlinear system of equations whose linearization is:
\begin{equation}
	\left[ \*M + \beta \Delta t^2 \pder{\*K}{\*U}(\*U_k^{n+1}) \right] \Delta \*U_{k+1}^{n+1} = -\*M \*U_k^{n+1} - \beta \Delta t^2 \*K(\*U_k^{n+1}) + \*M \widetilde{\*U^{n+1}}.
\end{equation}

\section{HHT-$\alpha$ method} 

To remove the spurious oscillations that Newmark's method could cause, Hilbert, Hughes \& Taylor \cite{HHTalpha} proposed to introduce a lagging term in Newmark's equation \eqref{eq:mol_newmark_3}, which is controlled by a parameter $\alpha$:
\begin{subequations} \label{eq:mol_hht}
    \begin{align}
        &\*U^{n+1} = \*U^n + \Delta t \*V^n + \frac{\Delta t}{2} \left[ (1-2\beta) \*A^n + 2\beta \*A^{n+1} \right], \\
	    &\*V^{n+1} = \*V^n + \Delta t \left[ (1-\gamma) \*A^n + \gamma \*A^{n+1} \right], \\
	    &\*M \*A^{n+1} + (1+\alpha)\*K(\*U^{n+1}) - \alpha\*K(\*U^{n}) = \*0.
    \end{align}
\end{subequations}
To obtain an unconditionally stable, second order scheme, $\beta$ and $\gamma$ have to be taken as
\[
    \beta = \frac{(1-\alpha)^2}{4}, \quad \gamma = \frac{1-2\alpha}{2},
\]
and more importantly, $-1/3 \leq \alpha \leq 0$. The parameter $\alpha$ controls the dissipation in the scheme, with $\alpha=-1/3$ usually providing maximum dissipation and $\alpha=0$ being Newmark's average acceleration method.

\subsection{HHT-$\alpha$ in the context of Rothe's method} \label{sec:rothe_hht}

Similar to \eqref{eq:mol_hht}, the HHT-$\alpha$ method in Rothe's framework reads:
\begin{subequations} \label{eq:rothe_hht}
    \begin{align}
        &u^{n+1} = u^n + \Delta t v^n + \frac{\Delta t}{2} \left[ (1-2\beta) a^n + 2\beta a^{n+1} \right] \\
	    &v^{n+1} = v^n + \Delta t \left[ (1-\gamma) a^n + \gamma a^{n+1} \right] \\
	    & \rho_0 a^{n+1} = (1+\alpha) P(\lambda^{n+1})_x - \alpha P(\lambda^n)_x.
    \end{align}
\end{subequations}
Therefore, solving for $u^{n+1}$ first and using the same predictors as in \eqref{eq:rothe_newmark_predictors} we have
\begin{subequations}
    \begin{align}
        & \rho_0 u^{n+1} = (1+\alpha) \beta \Delta t^2 P(\lambda^{n+1})_x - \alpha \beta \Delta t^2 P(\lambda^n)_x + \rho_0 \widetilde{u^{n+1}}, \\
	    & a^{n+1} = \dfrac{u^{n+1} - \widetilde{u^{n+1}}}{\beta \Delta t^2}, \\
	    & v^{n+1} = v^n + \Delta t \left[ (1-\gamma) a^n + \gamma a^{n+1} \right].
    \end{align}
\end{subequations}
In particular, the linearization of the equation for $u^{n+1}$ reads: find $du_k^{n+1}$ such that:
\begin{multline} 
	\rho_0 \int_0^L du_k^{n+1} \, w + (1+\alpha)\beta \Delta t^2 \int_0^L \der{P}{\lambda}(\lambda_k^{n+1}) \der{(du_k^{n+1})}{x} \der{w}{x} = \\
	-\rho_0 \int_0^L u_k^{n+1} w - (1+\alpha)\beta \Delta t^2 \int_0^L P(\lambda_k^{n+1})  \der{w}{x} + \alpha \beta \Delta t^2 \int_0^L P(\lambda^n) \der{w}{x} + \rho_0 \int_0^L \widetilde{u^{n+1}} w.
\end{multline}

As in Newmark's method, a fully discrete system can follow from the steps shown in Section \ref{sec:rothe_first_order}.

\subsection{HHT-$\alpha$ in the context of the MOL} \label{sec:mol_hht}

After some algebraic manipulations, a displacement-based method for \eqref{eq:mol_hht} reads:
\begin{subequations}
    \begin{align}
        & \*M \*U^{n+1} + (1+\alpha)\beta \Delta t^2 \*K(\*U^{n+1}) = \alpha \beta \Delta t^2\*K(\*U^{n}) + \*M \widetilde{\*U^{n+1}}, \\
	& \*A^{n+1} = \dfrac{\*U^{n+1} - \widetilde{\*U^{n+1}}}{\Delta t^2}, \\
	& \*V^{n+1} = \*V^n + \Delta t \left[ (1-\gamma) \*A^n + \gamma \*A^{n+1} \right].
    \end{align}
\end{subequations}
Furthermore, the Newton increments $\Delta \*U^{n+1}_{k+1}$ can be computed as:
\begin{multline}
	\left[ \*M + (1+\alpha)\beta \Delta t^2 \pder{\*K}{\*U}(\*U_k^{n+1}) \right] \Delta \*U_{k+1}^{n+1} \\
    = -\*M \*U_k^{n+1} - (1+\alpha)\beta \Delta t^2 \*K(\*U_k^{n+1}) + \alpha \beta \Delta t^2 \*K(\*U^n) + \*M \widetilde{\*U^{n+1}}.
\end{multline}

\section{Convergence studies}

Since we will be interested in the different effects cause by the time discretization, as well as by the choice of Rothe's method vs. method of lines, let us first verify that each of our algorithms is converging in the way it is expected when applied to a linear problem with smooth boundary conditions. For simplicity, we consider the following names for these algorithms:
\begin{itemize}
    \item \textit{Rothe-First order}, for the scheme introduced in Section \ref{sec:rothe_first_order},
    \item \textit{MOL-First order}, for the scheme introduced in Section \ref{sec:mol_first_order},
    \item \textit{Rothe-Newmark}, for the scheme introduced in Section \ref{sec:rothe_newmark},
    \item \textit{MOL-Newmark}, for the scheme introduced in Section \ref{sec:mol_newmark},
    \item \textit{Rothe-HHT-$\alpha$}, for the scheme introduced in Section \ref{sec:rothe_hht},
    \item \textit{MOL-HHT-$\alpha$}, for the scheme introduced in Section \ref{sec:mol_hht}.
\end{itemize}

We first define the errors in time and space respectively by
\begin{equation}
    e_t = \max_{0 \leq i \leq N+1} |u_h(x_i,T) - u(x_i,T)|, \quad e_x = \| u_h(\cdot,T) - u(\cdot,T)\|_{L^2(\Omega)},
\end{equation}
where $u_h$ and $u$ are the computed approximation and exact solutions to the initial boundary value problem \eqref{eq:elasticity_1d}. Furthermore, we define the rates of convergence in time and space respectively by
\begin{equation}
    r_t = \dfrac{\log(e_t/e_t')}{\log(\Delta t / \Delta t')}, \quad r_x = \dfrac{\log(e_x/e_x')}{\log(\Delta x / \Delta x')},
\end{equation}
where $e_t$ and $e_t'$ ($e_x$ and $e_x'$) are the errors corresponding, respectively, to different time step (spatial mesh) sizes $\Delta t$ and $\Delta t'$ ($\Delta x$ and $\Delta x'$).

For this section, we consider the stress $P$ given by a linear relationship (i.e., linear elasticity):
\begin{equation}
    P(\lambda) = E(\lambda-1), \quad E = 3\kappa(1-2\nu),
\end{equation}
where $E$, $\kappa$, and $\nu$ are the Young's modulus, bulk modulus, and Poisson's ratio of the material, respectively. Thus, the initial boundary value problem \eqref{eq:elasticity_1d} reduces to:
\begin{subequations} \label{eq:elasticity_linear}
    \begin{gather}
        \rho_0 u_{tt} = E u_{xx} \quad \text{in }\Omega \times (0,T), \\
	    u(x,0) = 0, \quad u_t(x,0) = 0 \quad \text{in } \Omega \times \{t=0\} \\
	    u(0,t) = 0, \quad u(L,t) = g(t) \quad \text{in } (0,\infty),
    \end{gather}
\end{subequations}
where $T>0$ and $\Omega = (0,L)$. Therefore, with the problem being linear, we expect to see convergence in time of order $r_t=1$ for the first order time stepping scheme, and order $r_t=2$ for the Newmark and HHT-$\alpha$ schemes. Moreover, for all three time stepping schemes, we expect convergence in space of order $r_x = 3$ \cite{ErnGuermondBook}. 

Let us consider $\kappa = 1 \ \text{GPa}$, $\nu = 0.499$, $\rho_0 = 1060 \ \text{kg} \, \text{m}^{-3}$, $L = 500 \ \text{mm}$, $T = 500 \text{ms}$, and a boundary condition $g(t) = 0.1t^3$. In this case, while the exact solution to \eqref{eq:elasticity_linear} could be computed using Fourier series, we cannot reliably use this expression as any truncation of this series will lead to high oscillations at the ends of the interval (Gibbs phenomenon). Therefore, we decide to compute an ``exact'' solution by taking a sufficiently small $\Delta t$ or $\Delta x$. We emphasize that both the exact solution and its approximations will be computed using the same solver (i.e. an \textit{intrasolver} study). We avoid intersolver comparisons due to the fact that the chosen discretization in space is not the most robust for these parameters, as it can potentially cause the solver to ``lock'', i.e. there will be a point where errors will stop decreasing regardless of how small $\Delta x$ is taken \cite{BabushkaSuri1992}.

With this in mind, we first, fix the space mesh size to $\Delta x = L/8 = 62.5 \ \text{mm}$ and decrease the time step size from $10 \ \text{ms}$ to $0.1 \ \text{ms}$. In this case, for an exact solution computed with $\Delta t = 0.01 \ \text{ms}$, we see from the third column in Table \ref{tab:convergence_linear_elasticty_1d} that Rothe-First order and MOL-First order achieve a rate of convergence of 1, while the rest of the methods achieve a rate of convergence of 2, as expected. Next, we fix the time step size to $\Delta t = 10 \ \text{ms}$ and decrease the space mesh size from 125 mm to 7.8125 mm (or equivalently, increase the number of elements in the interval, from 4 to 64). In this case, for an exact solution computed with $\Delta x = 1.953125 \ \text{mm}$ (i.e. 256 elements), we observe from the sixth column in Table \ref{tab:convergence_linear_elasticty_1d} that all methods converge with a rate equal to 3, as expected.

\begin{table}
    \centering
    \begin{tabular}{|l|l|l|l|l|l|}
        \hline
        \multicolumn{6}{|c|}{Rothe-First order} \\\hline
        $\Delta t$ [s] & $e_t$ [m] & $r_t$ & $\Delta x$ [m] & $e_x$ [m] & $r_x$ \\\hline
        1.0e-02&3.5359e-05&-&1.2500e-01&1.1720e-06&-\\\hline
        5.0e-03&2.1775e-05&0.6994&6.2500e-02&1.4649e-07&3.0002\\\hline
        1.0e-03&5.3640e-06&0.8705&3.1250e-02&1.8315e-08&2.9997\\\hline
        5.0e-04&2.7656e-06&0.9557&1.5625e-02&2.2922e-09&2.9982\\\hline
        1.0e-04&5.2945e-07&1.0272&7.8125e-03&2.8785e-10&2.9933\\\hline\hline
        \multicolumn{6}{|c|}{Rothe-Newmark} \\\hline
        $\Delta t$ [s] & $e_t$ [m] & $r_t$ & $\Delta x$ [m] & $e_x$ [m] & $r_x$ \\\hline
        1.0e-02&1.0421e-06&-&1.2500e-01&1.3049e-06&-\\\hline
        5.0e-03&3.2229e-07&1.6931&6.2500e-02&1.5771e-07&3.0486\\\hline
        1.0e-03&1.3031e-08&1.9933&3.1250e-02&2.1257e-08&2.8912\\\hline
        5.0e-04&3.3822e-09&1.9459&1.5625e-02&2.7480e-09&2.9515\\\hline
        1.0e-04&1.8095e-10&1.8193&7.8125e-03&3.6347e-10&2.9185\\\hline\hline
        \multicolumn{6}{|c|}{Rothe-HHT $\alpha$} \\\hline
        $\Delta t$ [s] & $e_t$ [m] & $r_t$ & $\Delta x$ [m] & $e_x$ [m] & $r_x$ \\\hline
        1.0e-02&1.4903e-06&-&1.2500e-01&1.2667e-06&-\\\hline
        5.0e-03&4.8636e-07&1.6155&6.2500e-02&1.6072e-07&2.9784\\\hline
        1.0e-03&1.8973e-08&2.0156&3.1250e-02&1.9412e-08&3.0496\\\hline
        5.0e-04&4.9797e-09&1.9298&1.5625e-02&2.3875e-09&3.0233\\\hline
        1.0e-04&2.1426e-10&1.9547&7.8125e-03&2.9832e-10&3.0006\\\hline\hline
        \multicolumn{6}{|c|}{MOL-First order} \\\hline
        $\Delta t$ [s] & $e_t$ [m] & $r_t$ & $\Delta x$ [m] & $e_x$ [m] & $r_x$ \\\hline
        1.0e-02&3.5527e-05&-&1.2500e-01&5.8379e-07&-\\\hline
        5.0e-03&2.1637e-05&0.7155&6.2500e-02&7.2962e-08&3.0002\\\hline
        1.0e-03&5.3383e-06&0.8696&3.1250e-02&9.1223e-09&2.9997\\\hline
        5.0e-04&2.7535e-06&0.9551&1.5625e-02&1.1417e-09&2.9982\\\hline
        1.0e-04&5.2758e-07&1.0267&7.8125e-03&1.4337e-10&2.9933\\\hline\hline
        \multicolumn{6}{|c|}{MOL-Newmark} \\\hline
        $\Delta t$ [s] & $e_t$ [m] & $r_t$ & $\Delta x$ [m] & $e_x$ [m] & $r_x$ \\\hline
        1.0e-02&9.4285e-07&-&1.2500e-01&6.2004e-07&-\\\hline
        5.0e-03&3.3843e-07&1.4782&6.2500e-02&7.8989e-08&2.9726\\\hline
        1.0e-03&1.5963e-08&1.8976&3.1250e-02&1.0243e-08&2.9470\\\hline
        5.0e-04&3.9708e-09&2.0073&1.5625e-02&1.3705e-09&2.9019\\\hline
        1.0e-04&1.3462e-10&2.1028&7.8125e-03&1.9272e-10&2.8301\\\hline\hline
        \multicolumn{6}{|c|}{MOL-HHT $\alpha$} \\\hline
        $\Delta t$ [s] & $e_t$ [m] & $r_t$ & $\Delta x$ [m] & $e_x$ [m] & $r_x$ \\\hline
        1.0e-02&1.4745e-06&-&1.2500e-01&6.1040e-07&-\\\hline
        5.0e-03&4.4467e-07&1.7294&6.2500e-02&7.5935e-08&3.0069\\\hline
        1.0e-03&2.4003e-08&1.8138&3.1250e-02&9.4335e-09&3.0089\\\hline
        5.0e-04&6.0257e-09&1.9940&1.5625e-02&1.1774e-09&3.0022\\\hline
        1.0e-04&2.5532e-10&1.9642&7.8125e-03&1.4774e-10&2.9944\\\hline
    \end{tabular} 
    \caption{Error behaviour for each of the proposed methods. Left three columns: convergence in time ($L^\infty$ norm) with fixed space mesh size ($\Delta x = L/8 = 62.5 \ \text{mm}$). Right three columns: convergence in space ($L^2$ norm) with fixed time step size $\Delta t = 10^{-5}$ s. \label{tab:convergence_linear_elasticty_1d}}
\end{table}

\section{Neo-Hookean experiments, overshooting, and velocity approximations}

Consider for the 1D elasticity model \eqref{eq:elasticity_1d} a stress $P = P(\lambda)$  given by a Neo-Hookean relationship:
\begin{equation} \label{eq:neohookean_stress_1d}
    P(\lambda) = \mathcal{L}_\lambda \lambda + \dfrac{\mathcal{L}_\lambda \log \lambda - \mathcal{L}_\mu}{\lambda},
\end{equation}
where similar to \eqref{eq:force_neohookean}, $\mathcal{L}_\lambda$ and $\mathcal{L}_\mu$ are the Lam\'e parameters of the material:
\begin{equation}
    \mathcal{L}_{\lambda} = \dfrac{\kappa\nu}{(1-\nu)(1-2\nu)}, \quad \mathcal{L}_{\mu} = \dfrac{\kappa}{2(1+\nu)},
\end{equation}
$\kappa$ is the bulk modulus, and $\nu$ the Poisson ratio. Furthermore, consider a rod with $\rho_0 = 1060$ \si{kg.m^{-3}}, $\kappa = 1$ \si{GPa}, $\nu = 0.4$, $L = 100$ \si{mm}, and a simulation end time $T = 2$ s. Our experiment consists in lengthening the rod from an initial length $L$ to a length $(1+A)L$, where $A=0.1$ (i.e. 10\% strain), using three different strain profiles:
\begin{enumerate}
    \item a function which transitions smoothly from $\varepsilon_1(0) = 0$ to $\varepsilon_1(T) = A$ with zero initial and end strain rate (i.e. $\dot{\varepsilon}_1(0) = \dot{\varepsilon}_1(T) = 0$), as well as a maximum strain rate of $\varepsilon_0 = 0.2$ \si{s^{-1}}:
    \begin{equation} \label{eq:smooth_pull}
        \varepsilon_1(t) = A \, \phi\left(\dfrac{t}{T}\right),
    \end{equation}
    where
    \[
        \phi(t) = \dfrac{\psi(t)}{\psi(t) + \psi(1-t)}, \quad \psi(t) = \left\{ \begin{aligned}
        &e^{-1/(c_0 t)}, \ &t > 0, \\
        &0, \ &t \leq 0,
        \end{aligned}\right. 
    \]
    and $c_0 = 2|A|/(\varepsilon_0 T)$.
    \item a profile in which the rod is held fixed until $t_1 = 0.1$ s, then linearly lengthened until a strain $A$ is reached at $t_2 = 0.6$ s, then held fixed until $t = T$:
    \begin{equation} \label{eq:lin_pull}
        \varepsilon_2(t) = \left\{
            \begin{aligned}
                &0 \quad &\text{if } 0 \leq t < t_1, \\
                &A \frac{t-t_1}{t_2-t_1} \quad &\text{if } t_1 \leq t \leq t_2, \\
                &A \quad &\text{if } t_2 < t \leq T;
            \end{aligned}
        \right.
    \end{equation}
    \item a sinusoidal profile with $f = 1$ \si{Hz}:
    \begin{equation} \label{eq:sin_pull}
        \varepsilon_3(t) = A \sin(2\pi f t), \quad 0 \leq t \leq T.
    \end{equation}
\end{enumerate}
Therefore, the boundary condition for the elasticity model \eqref{eq:elasticity_1d} is $u(L,t) = L \varepsilon_k(t)$, $k =1,2,3$. First, we discretize the PDE \eqref{eq:elasticity_1d_1} using the six methods mentioned in the previous section with $\Delta x = L/8$, $\Delta t = 10^{-4}$ s, and tolerances for the nonlinear solver set to $tol_u = 10^{-6}$ in displacement and $tol_R = 10^{-8}$ in the residual (see \eqref{eq:convergence_crit_1d}). 

Because of the nonzero initial velocity when using \eqref{eq:sin_pull} and the discontinuous velocity in \eqref{eq:lin_pull}, an elastic wave is expected to be generated (similar to the findings in the dynamical study by Tam \cite{Cassidy}). This is also a situation where overshooting can happen, so it will be of interest to study how numerical methods deal with this issue.

\subsection*{Smooth dynamics}

First, we show in Figure \ref{fig:smooth_pull} the results when the rod is lengthened using the smooth profile \eqref{eq:smooth_pull}. Here, because the boundary conditions are $C^\infty$ and the lengthening starts with zero velocity and acceleration, all methods compute the same displacement and velocity, both appearing to be smooth.

\subsection*{Nonsmooth dynamics}

Next, in Figure \ref{fig:lin_pull_disp} and \ref{fig:sin_pull_disp} we show the results for the case when the boundary condition is the linear profile \eqref{eq:lin_pull} and the sinusoidal profile \eqref{eq:sin_pull}, respectively. In these cases, we observe a small wave that propagates through the rod and that is dissipated by the first order and HHT-$\alpha$ methods, in both Rothe and MOL implementations. These waves are caused by the sudden change in velocity at $t = 0.1$ s and $t = 0.6$ s for the linear boundary condition, and because of the nonzero initial velocity for the sinusoidal profile. Newmark's method, as suspected, did not dissipate this wave. 

While not much of a difference is observed in terms of displacements, the picture changes completely when we look at the velocities that these methods compute. First, we show in Figure \ref{fig:lin_pull_vel} the velocities for the linear boundary condition \eqref{eq:lin_pull}. In this case, the velocity is a step function, and therefore we would like our numerical methods to dissipate the wave that it generates as soon as possible. In general, we observe that MOL implementations dissipate this wave more quickly than Rothe implementations. However, the velocities computed by MOL-Newmark, as well as by Rothe-Newmark and Rothe-HHT-$\alpha$ are simply unusable. A closer look at the velocity jump in the bottom half of Figure \ref{fig:lin_pull_vel} reveals high frequency oscillations that are well dissipated by Rothe-First order, MOL-First order, and MOL-HHT-$\alpha$ methods. 

Similarly, when using the sinusoidal profile \eqref{eq:sin_pull} as a boundary condition, we observe in Figure \ref{fig:sin_pull_vel} some overshooting at the beginning of the simulation in all methods, but this is quickly fixed by the first order methods and the MOL-HHT-$\alpha$ method. 

\begin{figure}
    \centering
    \includegraphics[width=0.99\textwidth]{nh_smooth_disp.eps}
    \includegraphics[width=0.99\textwidth]{nh_smooth_vel.eps}
    \caption{Strains (top half) and strain rates (bottom half) for the lengthening experiment using the $C^\infty$ boundary condition \eqref{eq:smooth_pull} at four different locations: $x = 0.25L$, $x=0.5L$, $x=0.9L$, and $x=L$.
    \label{fig:smooth_pull}}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.99\textwidth]{nh_linear_disp_1.eps}
    \includegraphics[width=0.99\textwidth]{nh_linear_disp_2.eps}
    \caption{Strains over $t \in [0,2]$ (top half) and a zoomed version to $t \in [0,0.2]$ (bottom half) at four different locations: $x = 0.25L$, $x=0.5L$, $x=0.9L$, and $x=L$. Lengthening experiment performed using the linear profile \eqref{eq:lin_pull}.
    \label{fig:lin_pull_disp}}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.99\textwidth]{nh_sin_disp_1.eps}
    \includegraphics[width=0.99\textwidth]{nh_sin_disp_2.eps}
    \caption{Strains over $t \in [0,1]$ (top half) and a zoomed version to $t \in [0,0.25]$ (bottom half) at four different locations: $x = 0.25L$, $x=0.5L$, $x=0.9L$, and $x=L$. Lengthening experiment performed using the sinusoidal profile \eqref{eq:sin_pull}.
    \label{fig:sin_pull_disp}}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.99\textwidth]{nh_linear_vel_1.eps}
    \includegraphics[width=0.99\textwidth]{nh_linear_vel_2.eps}
    \caption{Strain rates over $t \in [0,2]$ (top half) and a zoomed version to $t \in [0.58,0.65]$ where the (prescribed) strain rate jumps from 0.2 \si{s^{-1}} to 0 \si{s^{-1}} (bottom half)  at four different locations: $x = 0.25L$, $x=0.5L$, $x=0.9L$, and $x=L$. Lengthening experiment performed using the linear profile \eqref{eq:lin_pull}.
    \label{fig:lin_pull_vel}}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.99\textwidth]{nh_sin_vel_1.eps}
    \includegraphics[width=0.99\textwidth]{nh_sin_vel_2.eps}
    \caption{Strain rates over $t \in [0,1]$ (top half) and a zoomed version to $t \in [0,0.25]$ showcasing the nonzero velocity at the beginning (bottom half) at four different locations: $x = 0.25L$, $x=0.5L$, $x=0.9L$, and $x=L$. Lengthening experiment performed using the sinusoidal profile \eqref{eq:lin_pull}.
    \label{fig:sin_pull_vel}}
\end{figure}


\subsection*{An IMEX scheme}

We can also test an implicit-explicit (IMEX) scheme for the nonlinear system of equations \eqref{eq:mol}. Observe from the definition of $\*K(\*U)$ in \eqref{eq:mol_first_order_def_stiffness_vector} that:
\begin{multline}
    \quad \*K(\*U)_T = \mathcal{L}_\mu \underbrace{\left( B^{-1} \int_{\widehat{T}} [\widehat{\*D} \widehat{\*P}]^\top [\widehat{\*D} \widehat{\*P}] \right)}_{=: \widetilde{\*K}_T} [\*u(t)] \\
    + \underbrace{\int_{\widehat{T}} \dfrac{\mathcal{L}_\lambda \log \left( B^{-1}[\widehat{\*D} \widehat{\*P}] [\*u(t)] + 1 \right) - \mathcal{L}_\mu}{\mathcal{L}_\lambda} [\widehat{\*D} \widehat{\*P}]^\top}_{=: \widetilde{\*F_1}(\*U)_T} + \mathcal{L}_\mu \underbrace{\int_{\widehat{T}} [\widehat{\*D} \widehat{\*P}]^\top}_{=: \widetilde{\*F_2}_T}. \quad
\end{multline}
Thus, we can write:
\begin{equation}
    \*K(\*U) = \mathcal{L}_\mu \widetilde{\*K} \*U + \widetilde{\*F_1}(\*U) + \mathcal{L}_\mu \widetilde{\*F_2},
\end{equation}
where 
\begin{equation}
    \widetilde{\*K} = \assembly_{T \in \mathcal{T}_h} \widetilde{\*K}_T, \quad \widetilde{\*F_1}(\*U) = \assembly_{T \in \mathcal{T}_h} \widetilde{\*F_1}(\*U)_T, \quad \widetilde{\*F_2} = \assembly_{T \in \mathcal{T}_h} \widetilde{\*F_2}_T.
\end{equation}
Therefore, the MOL system \eqref{eq:mol} can be written as:
\[
	\*M \ddot{\*U} + \mathcal{L}_\mu \widetilde{\*K} \*U + \widetilde{\*F_1}(\*U) + \mathcal{L}_\mu\widetilde{\*F_2} = \*0.
\]
Defining once again $\*V:=\dot{\*U}$ we can propose the following scheme:
\begin{subequations} \label{eq:TS-mol-imex}
    \begin{align}
        &\dfrac{\*U^{n+1} - \*U^n}{\Delta t} = \*V^{n+1} \\
	    \label{eq:TS-mol-imex-b} &\*M \left( \dfrac{\*V^{n+1} - \*V^n}{\Delta t} \right) + \mathcal{L}_\mu \widetilde{\*K} \*U^{n+1} = -\widetilde{\*F_1}(\*U^n) - \mathcal{L}_\mu \widetilde{\*F_2}.
    \end{align}
\end{subequations}
This means that we treat the linear term \textit{implicitly} and the nonlinear term \textit{explicitly}. In this way, writing Equation \eqref{eq:TS-mol-imex-b} in terms of displacements, we obtain:
\begin{equation}
	\left( \*M + \mu \Delta t^2 \widetilde{\*K} \right)\*U^{n+1} = \*M(\*U^n + \Delta t \*V^n) - \Delta t^2 \*F_1(\*U^n) - \mu \Delta t^2 \*F_2.
\end{equation}
No nonlinear solver is needed. However, numerical experiments for the linear boundary condition \eqref{eq:lin_pull} show that this method does not compute better velocities than any of the previously presented methods (see Figure \ref{fig:lin_pull_imex}). Furthermore, this method behave more like an explicit method, since the largest time step size that was allowed was $\Delta t = 5 \cdot 10^{-6}$ s (compare this to the rest of the experiments in which $\Delta t  = 10^{-4}$ s, of course with larger time step sizes being possible). This also shows that the stiffness in this problem comes from the nonlinear part of \eqref{eq:neohookean_stress_1d}, rather than from the linear part.

\begin{figure}
    \centering
    \includegraphics[width=0.99\textwidth]{nh_imex.eps}
    \caption{Strain (left) and strain rate (right) profiles at four different locations ($x = 0.25L$, $x=0.5L$, $x=0.9L$, and $x=L$) for the lengthening experiment using the linear profile \eqref{eq:lin_pull} and an IMEX time stepping scheme ($\Delta x = L/64$, $\Delta t = 0.5 \cdot 10^{-6}$).
    \label{fig:lin_pull_imex}}
\end{figure}

\subsection*{Matlab's built-in solvers}

Once the MOL system \eqref{eq:mol} is constructed, many time-stepping schemes for ODE
systems can be tested, including built-in Matlab solvers. For this set of
experiments, we consider the sinusoidal pull \eqref{eq:sin_pull} and no time step restrictions, thus letting Matlab choose the best time step for the given tolerances
(\texttt{RelTol} = $10^{-2}$, \texttt{AbsTol} = $10^{-4}$). The MOL equations are solved as a square system of 2 $\times$ (DOF-2) equations (DOF$=2N-1$). 

We show in Table \ref{tab:mol_matlab_solvers} a summary of the performance of 
each Matlab solver. As expected, most of the non-stiff
solvers did not work (they would achieve $\lambda = \partial_x u + 1 \leq 0$ at
some iteration), with the exception being \texttt{ode113}. From Matlab's 
website:
\begin{itemize}
	\item \texttt{ode113} is a variable-step, variable-order (VSVO) 
	Adams-Bashforth-Moulton PECE (Predict-Evaluate-Correct-Evaluate) solver of orders 1 to 13. 
	The highest order used appears to be 12, however, 
	a formula of order 13 is used to form the error estimate 
	and the function does local extrapolation to advance 
	the integration at order 13.
	\item \texttt{ode113} may be more efficient than ode45 at stringent 
	tolerances or if the ODE function is particularly expensive 
	to evaluate. \texttt{ode113} is a multistep solver -- it normally 
	needs the solutions at several preceding time points to 
	compute the current solution
\end{itemize}

The solver \texttt{ode23tb} gave the best results. Not only it took
the shortest time to compute a solution but also allowed for the largest time step of all Matlab solvers. However,
the relatively crude tolerance chosen to run these experiments might have
played a fundamental role. In fact, when \texttt{RelTol} was reduced to $10^{-4}$ 
and \texttt{AbsTol} to $10^{-6}$, 
the CPU time of \texttt{ode23tb} went from 37.5\% of ode15s to 492\% using an
average time step of $3.68 \cdot 10^{-6}$ s. From Matlab's website:
\begin{itemize}
	\item \texttt{ode23tb} is an implementation of TR-BDF2, an implicit 
	Runge-Kutta formula with a trapezoidal rule (TR) step as its 
	first stage and a backward differentiation formula 
	of order two (BDF2) as its second stage. By construction, 
	the same iteration matrix is used in evaluating both stages.
\end{itemize}

We show, in particular, the velocities and the time step sizes for the solvers that finished their computation (according to Table \ref{tab:mol_matlab_solvers}) in Figure \ref{fig:sin_pull_matlab}. Here, we observe that only \texttt{ode23s} and \texttt{ode23tb} computed velocities somewhat similar to those in Figure \ref{fig:sin_pull_vel}, but overshooting was still a problem in these solvers. Moreover, the time step size chosen by these solvers was in line with the one considered for Figure \ref{fig:sin_pull_vel}.

\begin{table}
	\centering
	\begin{tabular}{|c|c|c|c|}\hline
		Solver & Finished? & Avg. $\Delta t$ [s] & CPU Time [s] \\\hline
		ode45 & No & - & -  \\\hline
		ode23 & No & - & -  \\\hline
		ode113 & Yes & $1.46 \cdot 10^{-6}$ & 724  \\\hline
		ode78 & No & - & -   \\\hline
		ode89 & No & - & -   \\\hline
		ode15s & No & - & -  \\\hline
		ode23s & Yes & $5.69 \cdot 10^{-5}$ & 2,262 \\\hline
		ode23t & Yes & $6.21 \cdot 10^{-7}$ & 1,301 \\\hline
		ode23tb & Yes & $4.25 \cdot 10^{-5}$ & 29  \\\hline
	\end{tabular}
	\caption{Performance of Matlab's adaptive solvers for the MOL system \eqref{eq:mol} and the lengthening experiment using the sinusoidal profile \eqref{eq:sin_pull} as boundary condition ($\Delta x = L/64$). For \texttt{ode23s}, the Jacobian was (numerically) computed at each time step by the solver. \label{tab:mol_matlab_solvers}}
\end{table}

\begin{figure}
    \centering
    \includegraphics[width=0.99\textwidth]{nh_ode113.eps}
    \includegraphics[width=0.99\textwidth]{nh_ode23s.eps}
    \includegraphics[width=0.99\textwidth]{nh_ode23t.eps}
    \includegraphics[width=0.99\textwidth]{nh_ode23tb.eps}
    \caption{Strain rates (left column) and time step sizes (right column) for the Matlab solvers that finished solving the lengthening experiment (see Table \ref{tab:mol_matlab_solvers}).
    \label{fig:sin_pull_matlab}}
\end{figure}

\section{Discussion}

If studying Neo-Hookean dynamics was our ultimate goal, the conclusion would be that any of the six methods mentioned at the beginning of the previous section can be used as a time stepping scheme in a 1D or 3D elastic model. This primarily because the stress $P$ only depends on the stretch $\lambda$, and therefore, only on the displacement field. However, since our main goal is to find a time stepping scheme suitable for skeletal muscle dynamics, our methods need to compute ``good'' displacements \textbf{and} velocities since, in this case, the stress will depend on both stretch and strain rates as a \textbf{multiplicative} term. By ``good'' we consider, for now, displacements and velocities free of unrealistic, high-frequency oscillations, and if they are present, they must get dissipated quickly. Thus, only three methods can become candidates for a 3D code: Rothe-First order, MOL-First order, and MOL-HHT-$\alpha$. 

Furthermore, from the experiments performed with the IMEX scheme \eqref{eq:TS-mol-imex}, as well as with Matlab's built in solvers, we expect that problems of this flavour will require rather small time step sizes. This does not contradict the unconditional stability of the fully implicit schemes presented here. While larger time step sizes are allowed for a linear problem, taking one that is too large in a nonlinear problem can lead to a loss of convergence in the nonlinear solver. 

At this juncture, choosing which method to use becomes a software engineering decision. On the one hand, choosing the Rothe-First order method would allow us to reuse some of the computational developments by Dominguez \cite{Seba} and implement them in a fully dynamic code. Thus, that code will need only needs to be \textit{refactored} for our purposes. On the other hand, moving forward with a MOL approach would require us to almost completely \textit{rewrite} the code developed in \cite{Seba}. Therefore, we decide to discretize the 3D dynamic model using Rothe-First order method \eqref{eq:rothe_first_order}.

\section{Conclusion}

We studied the performance of several time stepping schemes for one-dimensional nonlinear elasticity, and in particular, for Neo-Hookean deformation. The first set of methods (first order method, Newmark's method, and the HHT-$\alpha$ method, both in Rothe's and MOL frameworks) gave mixed results for nonsmooth boundary conditions. Only the Rothe-First order, MOL-First order, and MOL-HHT-$\alpha$ methods dealt successfully with overshooting. Next, we tested an IMEX scheme which performed poorly compared to the previous methods. In fact, this method only ran with a very small time step size. Finally, we tested some of Matlab's built-in solvers to assess the time step size they require to return a solution with rather large tolerances. We found that almost all the solvers designed for non-stiff problems, as well as some stiff ones, did not finish their computation. Indeed, only the \texttt{ode113} and \texttt{ode23tb} computed results comparable to those from the MOL-Newmark method (i.e. without dissipation of high-frequency oscillations).



\part{Three-dimensional elastodynamics}

\chapter{A Lagrangian framework for a model of skeletal muscle tissue} \label{ch:lagrangian_formulation}

In this Chapter, we focus on the development of the theoretical background for a 3D solver of dynamic skeletal muscle deformation, which we shall call \textit{Flexodeal}. Some parts of this Chapter have been published in:

\medskip
\noindent \bibentry{AlmonacidEtAl2022_SIAP_Paper}
\medskip

First, we introduce some concepts of continuum mechanics that are required to understand problems of large deformation of transversely isotropic materials. Then, we describe a series of models for the different components of the muscle-tendon unit (MTU) that have been previously introduced. Next, we rewrite the dynamic model introduced by Dominguez \cite{Seba} in a different frame of reference to obtain a more compact formulation with fully computable terms. Finally, we discretize the continuous problem using a first-order fully-implicit time stepping scheme and introduce a new nonlinear formulation, to then provide details on its linearization. 


\section{Elements of continuum mechanics}

This section provides a review of concepts in continuum mechanics that will be used throughout this work. Most of the content has been extracted from \cite{BonetGillWood2021Book,HolzapfelBook}.

\subsection{Kinematics} \label{sec:kinematics}

Let $\B_0 \subset \R^3$ denote the \textit{reference} configuration of a deformable body with a smooth boundary $\partial \B_0$. For each time $t > 0$, we consider an invertible motion $\bphi(\cdot, t):\B_0 \to \R^3$ that maps \textit{material} coordinates $\*X \in \B_0$ into \textit{spatial} coordinates $\*x := \bphi(\*X, \cdot)$, that is,
\begin{equation}
\*x = \bphi(\*X,t), \quad \*X = \bphi^{-1}(\*x,t).
\end{equation}
Then, we denote the set on which the spatial coordinates live as $\B^t := \bm{\varphi}(\B_0, t)$, which we call the \textit{current} configuration of the body with reference configuration $\B_0$. Note that, at time $t=0$, we have the consistency condition $\*x = \*X$.

We assume that the boundary $\partial \B_0$ is divided as $\partial \B_0 = \Gamma_{D,0} \cup \Gamma_{N,0}$, with $\Gamma_{N,0} \cap \Gamma_{D,0} = \emptyset$. The first part, $\Gamma_{D,0}$, corresponds to the part of the boundary for which displacements are set (e.g. a clamped face or a face that moves with a prescribed displacement). We refer to this part of the boundary as the ``Dirichlet'' boundary. In turn, $\Gamma_N$, is the part of the boundary where tractions are set (e.g. faces where a predefined traction is set or traction-free faces). We refer to this part of the boundary as the ``Neumann'' boundary. Thus, it is natural to think that the motion $\bphi$ extends to the boundary of $\B_0$ and maps the Dirichlet and Neumann parts in the reference configuration to the current configuration (at time $t>0$) as $\Gamma_D^t := \bphi(\Gamma_{D,0}, t)$ and $\Gamma_N^t := \bphi(\Gamma_{N,0}, t)$. Normally, we will not write the superscript $(\cdot)^t$.

We now define the material and spatial displacements fields $\*U$ and $\*u$ respectively as
\begin{equation}\label{eq:displacements}
\*U(\*X,t) := \*x - \*X = \bphi(\*X,t) - \*X, \quad \*u(\*x,t) := \*x - \*X = \*x - \bphi^{-1}(\*x,t), \quad t \geq 0.
\end{equation}
Note that, magnitude-wise, these displacement fields coincide (i.e. $|\*U|=|\*u|$). They are just observed in different reference frames. We refer to a system described in $\*X \in \B_0$ coordinates as the material or \textit{Lagrangian} description, whereas to one described in $\*x \in \B$ coordinates as the spatial or \textit{Eulerian} description.

In addition, we define the material velocity field $\*V$ and the spatial velocity field $\*v$ as
\begin{equation}\label{eq:velocities}
\*V(\*X,t) := \pder{\bphi(\*X,t)}{t}, \quad \*v(\*x,t) = \*V\big(\bphi^{-1}(\*x,t), t\big).
\end{equation}

\begin{remark} \label{re:velocity_def}
We can relate the material velocity and displacement fields using \eqref{eq:displacements}:
\begin{equation} \label{eq:vel_disp_0}
\*V(\*X,t) = \pder{\bphi(\*X,t)}{t} = \pder{}{t}\Big( \*U(\*X,t) + \*X \Big) = \pder{\*U(\*x,t)}{t}.
\end{equation}
With an additional step, we can also relate the spatial velocity and displacement fields using \eqref{eq:displacements} and \eqref{eq:velocities}:
\begin{multline} \label{eq:vel_disp}
\qquad \*v(\*x,t) = \*V(\bphi^{-1}(\*x,t),t) = \*V(\*X,t) = \pder{\bphi(\*X,t)}{t} \\
= \pder{}{t} \Big( \bphi(\*X,t) - \*X \Big) = \pder{}{t} \Big(\*x - \bphi^{-1}(\*x,t) \Big) = \pder{\*u(\*x,t)}{t}. \qquad 
\end{multline}
Therefore, it is consistent to define the material velocity using expression  \eqref{eq:vel_disp_0} and the spatial velocity using \eqref{eq:vel_disp}.
\end{remark}

\subsection{Material and spatial derivatives}

Because material coordinates $\*X$ and spatial coordinates $\*x$ are related through the motion $\bphi$, we can take derivatives of displacement and velocity fields with respect to any of these two variables. We call a smooth scalar field $\mathcal{F} = \mathcal{F}(\cdot,t)$ a \textit{material field} if it depends on material coordinates. Similarly, we call a smooth scalar field $f(\cdot,t)$ a \textit{spatial field} if it depends on spatial coordinates. Whenever possible, we will write material and spatial fields using uppercase and lowercase letters respectively.

First, the \textit{material time derivative of a material field} is given by
\begin{equation}
\dot{\F}(\*X,t) \equiv \Dder{\F(\*X,t)}{t} := \pder{\F(\*X,t)}{t} \bigg|_{\*X},
\end{equation}
that is, the partial derivative of $\F$ with respect to $t$ while holding $\*X$ constant (as usual). In particular, $\*V = \dot{\*U}$ and we may define the \textit{material acceleration field} as $\*A := \dot{\*V} = \ddot{\*U}$.

Next, we denote the \textit{material gradient} and \textit{material divergence of a material field} respectively as
\begin{equation}
\nabla_0 \F(\*X,t) := \pder{\F(\*X,t)}{\*X}, \quad \Divs{\FF(\*X,t)} = \pder{\F_i(\*X,t)}{X_i},
\end{equation}
where $\*F(\*X,t)$ is a smooth material vector field\footnote{The Einstein summation convention will be used throughout this document.}.

Similarly, we denote the \textit{spatial time derivative of a spatial field} $f$ by $\pder{f(\*x,t)}{t}$. We also define its \textit{spatial gradient} and \textit{spatial divergence} by
\begin{equation}
\nabla f(\*x,t) := \pder{f(\*x,t)}{\*x}, \quad \divs{\*f(\*x,t)} = \pder{f_i(\*x,t)}{x_i}.
\end{equation}

With these definitions in mind, we can now write an expression for the \textit{material derivative of a spatial field} $f(\*x,t)$. To do this, we first map $f$ to the material description using the motion $\bphi$, then we take the material time derivative of this field, and then map back the result to the spatial description. Symbolically, we can write this as
\begin{equation} \label{eq:material_derivative_def}
\dot{f}(\*x,t) \equiv \Dder{f(\*x,t)}{t} = \left. \pder{f\big( \bphi(\*X,t), t \big)}{t} \right|_{\*X = \bphi^{-1}(\*x,t)}.
\end{equation} 
However, we will make more frequent use of the following expression, which can be derived from \eqref{eq:material_derivative_def} using the chain rule:
\begin{equation} \label{eq:material_derivative}
\dot{f}(\*x,t) \equiv \Dder{f(\*x,t)}{t} = \pder{f(\*x,t)}{t} + \nabla f(\*x,t) \cdot \*v.
\end{equation}
In the case of a vector field $\*f(\*x,t)$, the previous expression takes the form
\begin{equation} \label{eq:material_derivative_vector}
\dot{\*f}(\*x,t) \equiv \Dder{\*f(\*x,t)}{t} = \pder{\*f(\*x,t)}{t} + \big(\nabla \*f(\*x,t) \big) \, \*v(\*x,t) = \pder{f_i}{t}+\pder{f_i}{x_j}v_j.
\end{equation}
In both \eqref{eq:material_derivative} and \eqref{eq:material_derivative_vector}, the terms $\nabla f \cdot \*v$ and $(\nabla \*f) \*v$ are usually referred to as \textit{convective} terms because they appear multiplied by the spatial velocity $\*v(\*x,t)$.

\subsection{Deformation gradient}

The primary measure of deformation in nonlinear continuum mechanics is given by the \textit{deformation gradient tensor} $\*F$, which is defined as
\begin{equation} \label{eq:def_F}
\*F(\*X,t) := \pder{\bphi(\*X,t)}{\*X} = \nabla_0 \*x(\*X,t), \quad \*F^{-1}(\*x,t) = \pder{\bphi^{-1}(\*x,t)}{\*x} = \nabla \*X(\*x,t).
\end{equation}
Moreover, we define the volume ratio $J$ as
\begin{equation}
J(\*X,t) := \det \*F(\*X,t).
\end{equation}
Note that as long as the motion $\bphi$ is invertible, $\det \*F \neq 0$. Also, because volume elements cannot have negative volumes, we cannot have $\det \*F < 0$. Hence, we will always have $\det \*F > 0$. 

Sometimes we refer to the volume ratio $J$ as the \textit{Jacobian determinant} because it provides a way to map infinitesimal elements in the reference configuration to the current configuration. Indeed, given infinitesimal elements $dV$, $dS$ in the interior and boundary of the reference configuration $\B^0$ respectively; and $dv$, $ds$ in the interior and boundary of the current configuration $\B^t$, we have 
\begin{equation} \label{eq:differentials}
dv = J(\*X,t) \, dV, \quad \*n \, ds = J \*F^{-T} \*N \, dS, 
\end{equation}
where $\*n$, $\*N$ denote the normal vectors on the surface of the current and reference configurations, respectively. The last equality in this equation is the well-known \textit{Nanson's formula}.

Instead of referring to the deformation gradient by its definition \eqref{eq:def_F}, we will often use its expression in terms of the displacement gradient, i.e.,
\begin{equation} \label{eq:real_def_of_F}
\*F(\*X,t) = \*I + \nabla_0 \*U(\*X,t) , \quad \*F^{-1}(\*x,t) = \*I - \nabla \*u(\*x,t),
\end{equation}
where $\*I$ is the standard second-order identity tensor. In addition, the deformation gradient can be used to establish the following relationships between the material gradient and material divergence, and the spatial gradient and spatial divergence of smooth scalar, vector and tensor fields $\phi$, $\*w$, and $\*A$, respectively:
\begin{align}
\nabla \phi &= \*F^{-T} \, \nabla_0 \phi = F^{-1}_{Aa} \pder{\phi}{X_A} \\
\label{eq:transform_2}\nabla \*w &= \nabla_0 \*w \, \*F^{-1} = \pder{w_a}{X_A} F^{-1}_{Ab}, \\
\label{eq:transform_3}\divt{\*A} &= \nabla_0 \*A : \*F^{-T} = \pder{A_{ab}}{X_B} F^{-1}_{Bb},
\end{align}
where the tensorial divergence is given by $\divt{\*A} := \pder{A_{ab}}{x_b}$.

\subsection{Strain and rate of deformation tensors}

Now that we have defined the deformation tensor $\*F$, we can describe velocity gradients. The \textit{material velocity gradient} is given by
\begin{equation}
\dot{\*F} = \pder{}{t} \left( \pder{\bphi(\*X,t)}{\*X} \right) = \pder{}{\*X} \left( \pder{\bphi(\*X,t)}{t} \right) = \pder{\*V(\*X,t)}{\*X} \quad \text{or} \quad \dot{F}_{aA} = \pder{V_a}{X_A}.
\end{equation}
In turn, the \textit{spatial velocity gradient} is given by
\begin{equation}
\*l(\*x,t) = \pder{\*v(\*x,t)}{\*x}.
\end{equation}
We may relate these two quantities using the expression
\begin{equation} \label{eq:def_l_spatial_velocity_gradient}
\*l = \dot{\*F} \*F^{-1}.
\end{equation}
Furthermore, we can additively decompose the spatial velocity gradient into its symmetric and skew-symmetric parts:
\begin{equation}
\*l(\*x,t) = \*d(\*x,t) + \*w(\*x,t),
\end{equation}
where
\begin{equation}
\*d = \dfrac{1}{2}(\*l + \*l^\T)
\end{equation}
is the \textit{rate of deformation tensor} (also called \textit{rate of strain tensor}), and
\begin{equation}
\*w = \dfrac{1}{2}(\*l - \*l^\T)
\end{equation}
is the \textit{rate of rotation tensor} or \textit{vorticity tensor}. %Note that the spatial tensors $\*l, \*d, \*w$ are viewed as covariant second-order tensors.

\subsection{Stretch and strain rate}

First, we define the \textit{left} and \textit{right Cauchy-Green tensors} respectively as
\begin{equation}
    \*C = \*F^\T \*F \quad \text{or} \quad C_{AB} = F_{aA} F_{aB},
\end{equation}
and
\begin{equation}
    \*b = \*F \*F^\T \quad \text{or} \quad b_{ab} = F_{aA} F_{bA}.
\end{equation}
They represent strain measures in \textit{material} and \textit{spatial} coordinates, respectively. 

The quantity that characterizes how a material line element changes in length from the reference to the current configuration is the \textit{stretch ratio} (or simply called the \textit{stretch}):
\begin{equation} \label{eq:def_lambda}
\lambda(\*X,t) := |\*F(\*X,t) \*a_0| = \sqrt{\*a_0^\T \*C \*a_0},
\end{equation}
where $\*a_0$ is a unit vector describing the initial orientation of the material line element (which can be imagined as a \textit{fibre} in the reference configuration). Furthermore, we define the \textit{strain rate} as the time derivative of this quantity, normalized by a factor $\depsilon_0$ representing the maximum strain rate at which a material element can deform:
\begin{equation} \label{eq:def_epsilon}
\depsilon(\*X,t) := \dfrac{1}{\depsilon_0} \dot{\lambda}(\*X,t) = \dfrac{1}{\depsilon_0} \dfrac{(\*F(\*X,t)  \*a_0)^\T \, \*d(\*x,t)  \, \*F(\*X,t)  \*a_0}{\lambda(\*X,t)}
\end{equation}
where the last equality arises from taking an implicit time derivative in \eqref{eq:def_lambda} and the fact that $\dot{\*C} = 2\*F^\T \*d \*F$. 

\subsection{Stress tensors}

Consider surface elements $ds$ with normal $\*n$ in the current configuration and $dS$ with normal $\*N$ in the reference configuration. Then, by Cauchy's stress theorem, for each pair of spatial and material tractions $\*t$ and $\*T$, respectively, there exists tensors $\bsigma$ and $\*P$ such that $\*t \, ds = \*T \, dS$ and
\begin{equation}
    \*t(\*x,t,\*n) = \bsigma(\*x,t) \*n \quad \text{and} \quad  \*T(\*X,t,\*N) = \*P(\*X,t)\*N.
\end{equation}
Here, $\bsigma$ is called the \textit{Cauchy stress tensor}, while $\*P$ is called the \textit{first Piola-Kirchhoff tensor} (PK1). Notice that $\bsigma$ describe the stresses in the body in the \textit{current} configuration, while $\*P$ describes them in the \textit{reference} configuration. Both measures of stress are related through the so-called \textit{Piola transformation}:
\begin{equation} \label{eq:def_PK1}
    \*P = J \bsigma \*F^{-\T}.
\end{equation}
From this expression, it can be seen that, although $\bsigma$ is a symmetric tensor, in general, $\*P$ is not.

Other stress tensors that will be used in this document are the (spatial) \textit{Kirchhoff stress tensor} defined as
\begin{equation}
    \btau = J \bsigma,
\end{equation}
and the (material) \textit{second Piola-Kirchhoff stress tensor} (PK2), which can be obtained as a pull back operation on $\btau$, that is
\begin{equation} \label{eq:def_PK2}
    \*S = \*F^{-1} \btau \*F^{-\T}.
\end{equation}
Thus, $\*S$ is a symmetric tensor. Moreover, this last equation gives us an important relationship that will be used in this work:
\begin{equation} \label{eq:push_forward_tau}
\btau = \*F \*S \*F^{\T}.
\end{equation}
Finally, the PK1 and PK2 tensors are related according to
\begin{equation}
\*P = \*F \*S.
\end{equation}

\subsection{Volumetric-isochoric decomposition}

In the case of compressible materials (even by very small amounts, as it is the case in skeletal muscle), it is customary to split the deformation tensor into volume-\textit{changing} (volumetric) and volume-\textit{preserving} (isochoric) parts, i.e.
\begin{equation} \label{eq:mult_decomp}
\*F = J^{1/3} \*I \, \bar{\*F} = J^{1/3} \bar{\*F}, \quad \bar{\*F} := J^{-1/3} \*F.
\end{equation}
We call $\bar{\*F}$ the \textbf{modified deformation gradient}. This yields modified versions of the right and left Cauchy-Green tensors:
\begin{equation}
\bar{\*C} = \bar{\*F}^\T \bar{\*F} = J^{-2/3} \*C, \quad \bar{\*b} = \bar{\*F} \bar{\*F}^\T = J^{-2/3} \*b.
\end{equation}
In particular, the derivative of $\bar{\*C}$ with respect to $\*C$ is given by
\begin{equation} \label{eq:der_cbar_c}
\pder{\bar{\*C}}{\*C} = J^{-2/3} \left( \mathbb{I} - \dfrac{1}{3}\*C \otimes \*C^{-1} \right) = J^{-2/3} \P^\T,
\end{equation}
where $\P^\T$ is the transpose of the fourth-order \textbf{material projection tensor} $\P$, where 
\begin{equation} \label{eq:def_projection_material}
\P := \mathbb{I} - \dfrac{1}{3}\*C^{-1} \otimes \*C,
\end{equation}
and $\mathbb{I}_{ABCD} := \frac{1}{2} \left( \delta_{AC} \delta_{BD} + \delta_{AB} \delta_{BC} \right)$ is the fourth-order symmetric identity tensor.

Moreover, the multiplicative decomposition \eqref{eq:mult_decomp} also yields a \textbf{modified stretch} $\bar{\lambda}$:
\begin{equation} \label{eq:def_lambda_bar}
\bar{\lambda} := \sqrt{\*a_0^\T \bar{\*C} \*a_0} = J^{-1/3} \lambda,
\end{equation}
and a \textbf{modified strain rate}:
\begin{equation} \label{eq:def_strain_rate_bar}
\bar{\depsilon} := \dfrac{1}{\depsilon_0} \dot{\bar{\lambda}} = \dfrac{1}{\depsilon_0} \dfrac{(\bar{\*F}\*a_0)^\T (\p : \*d) (\bar{\*F} \*a_0)}{\bar{\lambda}},
\end{equation}
where $\p$ is the fourth-order \textbf{spatial projection tensor} (also known as \textbf{deviatoric tensor}):
\begin{equation} \label{eq:def_projection_spatial}
\p := \mathbb{I} - \dfrac{1}{3} \*I \otimes \*I.
\end{equation}
The original strain rate $\depsilon$ and the modified one $\bar{\depsilon}$ are related by the expression:
\begin{equation}
    \depsilon = J^{-1/3} \left[ \bar{\depsilon} + \dfrac{1}{3} \dfrac{\mathrm{tr}(\*d)}{\depsilon_0} \bar{\lambda} \right],
\end{equation}
which arises as a byproduct when deriving the expression for $\bar{\depsilon}$ in \eqref{eq:def_strain_rate_bar} using \eqref{eq:def_epsilon} and \eqref{eq:def_lambda_bar}.



\subsection{Constitutive equations for the PK2 and Kirchhoff stresses} \label{sec:cons_eqs_PK2_kirchhoff_general}

Considering a perfectly elastic material in isothermal conditions, the Clausius-Planck inequality requires that the internal dissipation $\mathcal{D}_{int}$ vanishes, that is,
\begin{equation} \label{eq:D_int}
\mathcal{D}_{int} = w_{int} - \dot{\Psi} = 0,
\end{equation}
where the internal power is given by $w_{int} = \*S : \dot{\*C}/2$. To compute the time derivative of the strain-energy, we use \eqref{eq:der_cbar_c} and the fact that $\dot{J} = J \*C^{-1} : \dot{\*C}/2$:
\begin{equation} \label{eq:psi_dot}
\begin{aligned}
\dot{\Psi} &=  \der{\Psi_{vol}(J)}{J} \dot{J} + \pder{\Psi_{iso}(\bar{\*C})}{\bar{\*C}} : \dot{\bar{\*C}} \\
&= J \der{\Psi_{vol}(J)}{J} \*C^{-1} : \dfrac{\dot{\*C}}{2} + \pder{\Psi_{iso}(\bar{\*C})}{\bar{\*C}} : 2 J^{-2/3} \P^\T : \dfrac{\dot{\*C}}{2}.
\end{aligned}
\end{equation}
Inserting this equation back into \eqref{eq:D_int}, we obtain
\[
\mathcal{D}_{int} = \left( \*S - J \der{\Psi_{vol}(J)}{J} \*C^{-1} - J^{-2/3} \P : 2 \pder{\Psi_{iso}(\bar{\*C})}{\bar{\*C}} \right) : \dfrac{\dot{\*C}}{2} = 0.
\]
Therefore, the PK2 stress tensor can be described as
\begin{equation} \label{eq:def_S}
\*S = \*S_{vol} + \*S_{iso}.
\end{equation}
The volumetric part, $\*S_{vol}$, is defined as:
\begin{equation}
\*S_{vol} = p J \*C^{-1},
\end{equation}
where $p$ is the \textbf{hydrostatic pressure}:
\begin{equation}
    p := \der{\Psi_{vol}(J)}{J}.
\end{equation}
In turn, the isochoric part, $\*S_{iso}$, is given by
\begin{equation} \label{eq:def_S_iso}
\*S_{iso} = J^{-2/3} \P : \bar{\*S},
\end{equation}
where $\bar{\*S}$ is the \textbf{fictitious PK2 stress tensor}:
\begin{equation} \label{eq:def_S_bar}
    \bar{\*S} := 2 \pder{\Psi_{iso}(\bar{\*C})}{\bar{\*C}},
\end{equation}
and $\P$ is the projection tensor defined in \eqref{eq:def_projection_material}.

Pushing forward the equation describing $\*S$ (i.e., \eqref{eq:def_S}) according to \eqref{eq:push_forward_tau}, we obtain that the Kirchhoff stress $\btau$ can be described as
\begin{equation} \label{eq:def_tau}
\btau = \btau_{vol} + \btau_{iso},
\end{equation}
where the volumetric part, $\btau_{vol}$, is given by
\begin{equation}
\btau_{vol} = pJ \*I,
\end{equation}
and the isochoric part, $\btau_{iso}$ is given by
\begin{equation} \label{eq:def_tau_iso}
\btau_{iso} = \bar{\*F} (\P : \bar{\*S}) \bar{\*F}^\T = \p : \bar{\btau}, \quad
\end{equation}
where $\bar{\btau}$ is the \textbf{fictitious Kirchhoff stress tensor}:
\begin{equation} \label{eq:def_tau_bar}
    \bar{\btau} = \bar{\*F} \bar{\*S} \bar{\*F}^\T,
\end{equation} 
and $\p$ is the projection tensor defined in \eqref{eq:def_projection_spatial}.

\subsection{Elasticity tensors}

Linearization techniques such as Newton's method require the computation of fourth-order \textbf{elasticity tensors}. In the material description, this is given by
\begin{equation}
\C = 2\pder{\*S(\*C)}{\*C} \quad \text{or} \quad C_{ABCD} = 2\pder{S_{AB}}{C_{CD}}.
\end{equation}
In the spatial description, the elasticity tensor $\c$ can be obtained by a push-forward of the material tensor $\C$, that is,
\begin{equation} \label{eq:def_c_spatial}
\c = J^{-1} \bchi_*(\C) \quad \text{or} \quad c_{abcd} = J^{-1} F_{aA} F_{bB} F_{cC} F_{dD} C_{ABCD}.
\end{equation}

In particular, for the decomposition of the PK2 tensor in \eqref{eq:def_S}, $\C$ can be written as
\begin{equation} \label{eq:def_C}
\C = \C_{vol} + \C_{iso}.
\end{equation}
First, the volumetric part, $\C_{vol}$, is given by
\begin{equation}
\C_{vol} = J \left( p + J \der{^2\Psi_{vol}(J)}{J^2} \right) \*C^{-1} \otimes \*C^{-1} - 2Jp \, \*C^{-1} \odot \*C^{-1},
\end{equation}
where
\begin{equation}
-\left( \*C^{-1} \odot \*C^{-1} \right)_{ABCD} = -\dfrac{1}{2} \left( C_{AC}^{-1} C_{BD}^{-1} + C^{-1}_{AD} C^{-1}_{BC} \right).
\end{equation}
In turn, the isochoric part, $\C_{iso}$, can be computed as (see \cite[Example 6.8]{HolzapfelBook}):
\begin{equation}
\C_{iso} = \P \, \bar{\C} \, \P^\T + \dfrac{2}{3} \left(J^{-2/3} \bar{\*S} : \*C \right) \tilde{\P} - \dfrac{2}{3} \left( \*C^{-1} \otimes \*S_{iso} + \*S_{iso} \otimes \*C^{-1} \right),
\end{equation}
where the \textbf{fictitious elasticity tensor} $\bar{\C}$ in the material description is given by
\begin{equation} \label{eq:def_C_bar}
    \bar{\C} = 2 J^{-4/3} \pder{\bar{\*S}}{\bar{\*C}},
\end{equation}
and the \textbf{modified projection tensor} $\tilde{\P}$ is:
\begin{equation}
    \tilde{\P} = \*C^{-1} \otimes \*C^{-1} - \dfrac{1}{3} \*C^{-1} \odot \*C^{-1}.
\end{equation}
In the spatial description, the picture is similar and fortunately, the expressions are much simpler:
\begin{equation} \label{eq:def_c}
\c = \c_{vol} + \c_{iso},
\end{equation}
where the volumetric and isochoric parts are respectively given by:
\begin{equation}
J \c_{vol} = pJ(\*I \otimes \*I - 2p\mathbb{I}) + J^2 \der{^2 \Psi_{vol}(J)}{J^2} \*I \otimes \*I,
\end{equation}
and
\begin{equation} \label{eq:Jc_iso}
J\c_{iso} = \p \, \bar{\c} \, \p + \dfrac{2}{3} \mathrm{tr}(\bar{\btau}) \p - \dfrac{2}{3} \left( \*I \otimes \btau_{iso} + \btau_{iso} \otimes \*I \right).
\end{equation}
Note that we have multiplied these tensors by $J$ as, ultimately, the weak formulations will require us compute $J\c$. In the previous expression, $\p$ is the spatial projection tensor defined in \eqref{eq:def_projection_spatial} and $\bar{\c}$ is the \textbf{fictitious elasticity tensor} in the spatial description defined as push-forward of $\bar{\C}$:
\begin{equation} \label{eq:def_c_bar}
\bar{\c} = \bchi_*(\bar{\C}) \quad \text{or} \quad \bar{c}_{abcd} = F_{aA} F_{bB} F_{cC} F_{dD} \bar{C}_{ABCD} = \bar{F}_{aA} \bar{F}_{bB} \bar{F}_{cC} \bar{F}_{dD} \, J^{4/3} \bar{C}_{ABCD},
\end{equation}
where $\bar{C}_{ABCD}$ is computed according to \eqref{eq:def_C_bar}. Note that the term $\p \, \bar{\c} \, \p$ can be seen component wise as 
\begin{equation}
    (\p \, \bar{\c} \, \p)_{klmn} = p_{klab} \, \bar{c}_{abcd} \, p_{cdmn}.
\end{equation}

\section{Constitutive laws for the skeletal muscle tissue}

In general, we will refer to a material as being \textit{hyperelastic} if there exists a function $\Psi = \Psi(\*F)$ such that
\begin{equation}
    \*P = \pder{\Psi(\*F)}{\*F},
\end{equation}
where $\*P$ is the PK1 tensor defined in \eqref{eq:def_PK1}. Here $\Psi$ is called the \textit{strain-energy function} and provides a constitutive model for the material.

%\subsubsection{Strain-energy function for compressible, transversely isotropic materials}

In transversely isotropic materials (i.e., materials that are reinforced by only \text{one} family of fibres and that have a \text{single} preferred direction of deformation), the following strain-energy function can be established \cite{HolzapfelBook,Weiss1996}:
\begin{equation} \label{eq:decomp_psi}
\Psi = \Psi(\*C,\*a_0 \otimes \*a_0) = \Psi_{vol}(J) + \Psi_{iso}(\I_1, \I_2, \I_4, \I_5).
\end{equation}
Here, $\Psi_{vol}$ and $\Psi_{iso}$ respectively describe the volumetric and isochoric response of the material and $\I_1, \dots, \I_5$ are the invariants ($\I_4$ and $\I_5$ are actually \textit{pseudo-invariants} \cite{HolzapfelBook}) of the modified right Cauchy-Green tensor:
\begin{equation}
    \begin{gathered}
\I_1 = \mathrm{tr} \, \bar{\*C}, \quad \I_2 = \dfrac{1}{2}\left[ (\mathrm{tr} \, \bar{\*C})^2 - \mathrm{tr} \, (\bar{\*C^2}) \right], \quad \I_3 = \det \bar{\*C} \equiv 1, \\[0.5em]
\I_4 = \*a_0^\T \bar{\*C} \*a_0 = \bar{\lambda}^2, \quad \I_5 = \*a_0^\T \bar{\*C}^2 \*a_0.
    \end{gathered}
\end{equation}
Furthermore, their derivatives are given by:
\begin{equation} \label{eq:derivatives_invariants}
    \pder{\I_1}{\bar{\*C}} = \*I, \quad \pder{\I_2}{\bar{\*C}} = \I_1 \*I - \bar{\*C}, \quad \pder{\I_4}{\bar{\*C}} = \*a_0 \otimes \*a_0, \quad \pder{\I_5}{\bar{\*C}} = \*a_0 \otimes \bar{\*C}\*a_0 + \bar{\*C}\*a_0 \otimes \*a_0.
\end{equation}

We now focus on postulating expressions for $\Psi_{vol}$ and $\Psi_{iso}$ in \eqref{eq:decomp_psi}, following \cite{Seba,Hadi}. First, we consider the following expression for the volumetric part of the SEF $\Psi$:
\begin{equation} 
    \Psi_{vol}(J) = \dfrac{\kappa}{4} \left( J^2 - 2\ln J - 1 \right),
\end{equation}
where $\kappa$ is the bulk modulus of the material. In the case of skeletal muscle, the bulk modulus may appear as a single constant or as a weighted combination of bulk moduli of the different tissue components (such as intramuscular fat, ECM, and cellular material; a precise definition will be given in the subsections below).

Next, we assume that the isochoric component of $\Psi$ takes the form:
\begin{equation}
    \Psi_{iso} = (1-\chi_{fat}) \left( \Psi_{fibre} + \Psi_{bm} \right) + \chi_{fat} \Psi_{fat},
\end{equation}
where $\chi_{fat}$ is the fraction of intramuscular fat present in muscle tissue. In terms of stresses these SEFs induce, from Section \ref{sec:cons_eqs_PK2_kirchhoff_general} (and in particular from the definition of the isochoric Kirchhoff stress in \eqref{eq:def_tau_iso}), we notice that an expression for $\btau_{iso}$ can be found by computing first the fictitious PK2 stress $\bar{\*S}$ \eqref{eq:def_S_bar}, and then the fictitious Kirchhoff stress $\bar{\btau}$ by pushing-forward $\bar{\*S}$ (see Equation \ref{eq:def_tau_bar}). This will be the main idea of the following subsections.

\subsection{Muscle fibres in a 3D continuum}

{\color{red}Let us assume that there exists a SEF $\Psi_{fibre}$ given implicitly by the equation}
\begin{equation} \label{eq:ode_fibre_sef}
    2 \I_4 \pder{\Psi_{fibre}}{\I_4} = \sigma_{Hill}(\bar{\lambda}, \bar{\depsilon}),
\end{equation}
where $\sigma_{Hill}$ is Hill's muscle model written in terms of the maximum isometric stress $\sigma_{0,mus}$:
\begin{equation} \label{eq:def_hill_stress_sigma}
    \sigma_{Hill}(\bar{\lambda}, \bar{\depsilon}) = \sigma_{0,mus} \left( a(\*X,t) \widehat{\sigma}_A(\bar{\lambda}) \widehat{\sigma}_V(\bar{\depsilon}) + \widehat{\sigma}_P(\bar{\lambda}) \right).
\end{equation}
In this expression, the active stress-stretch relationship $\sigma_A$, the stress-strain rate relationship $\sigma_V$, and the passive stress-stretch relationship $\sigma_P$ can be taken exactly as the active force-length $F_V$, force-velocity $F_V$, and passive force-length $F_P$ relationships in \eqref{eq:Hill_force}, respectively (all these quantities are dimensionless, see Appendix \ref{app:force_relationships}). Furthermore, we now allow the activation function to also vary in space.

Following Equation \eqref{eq:def_S_bar}, the corresponding fictitious PK2 stress $\bar{\*S}_{fibre}$ can be computed as:
\begin{equation}
    \bar{\*S}_{fibre} = 2 \pder{\Psi_{fibre}}{\bar{\*C}} = 2 \pder{\Psi_{fibre}}{\I_4} \pder{\I_4}{\*C}.
\end{equation}
Thus, using \eqref{eq:ode_fibre_sef} together with \eqref{eq:derivatives_invariants}, the expression for $\bar{\*S}_{fibre}$ reads:
\begin{equation} \label{eq:def_S_fibre}
    \bar{\*S}_{fibre} = \dfrac{1}{\bar{\lambda}^2} \sigma_{0,mus} \left( a(\*X,t) \widehat{\sigma}_A(\bar{\lambda}) \widehat{\sigma}_V(\bar{\depsilon}) + \widehat{\sigma}_P(\bar{\lambda}) \right) \*a_0(\*X) \otimes \*a_0(\*X)
\end{equation}
where $\*a_0$ is the initial orientation vector of a fibre crossing through the point $\*X$. Moreover, according to \eqref{eq:def_tau_bar}, we obtain that:
\begin{equation}
    \bar{\btau}_{fibre} = \dfrac{1}{\bar{\lambda}^2} \sigma_{0,mus} \left( a(\*X,t) \widehat{\sigma}_A(\bar{\lambda}) \widehat{\sigma}_V(\bar{\depsilon}) + \widehat{\sigma}_P(\bar{\lambda}) \right) \bar{\*a} \otimes \bar{\*a},
\end{equation}
where $\bar{\*a} := \bar{\*F}\*a_0$.

\subsection{Base material}

The base material component can be modelled using the following Yeoh SEF \cite{Paper3_RossEtAl2021, Paper2_RyanEtAl2020, Paper1_WakelingEtAl2020}:
\begin{equation}\label{eq:def_Psi_bm}
    \Psi_{bm}(\I_1) = s_{bm} \sigma_{0,bm} \sum_{k=1}^3 c_k (\I_1 - 3)^k,
\end{equation}
where $s_{bm}$ is a scaling factor, $\sigma_{0,bm}$ a normalizing constant stress, and $c_k > 0$ computed to fit experimental data \cite{Hadi}.

Similarly to the computation of $\bar{\*S}_{fibre}$ and $\bar{\btau}_{fibre}$, the fictitious PK2 and Kirchhoff stresses are:
\begin{equation}
    \bar{\*S}_{bm} = s_{bm} \sigma_{0,bm} \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \*I,
\end{equation}
and
\begin{equation}
    \bar{\btau}_{bm} = s_{bm} \sigma_{0,bm} \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \bar{\*b}.
\end{equation}

Alternatively, we could consider the base material as a combination of ECM and cellular material contributions \cite{KonnoNigamWakeling2021_ECM}:
\begin{equation}
    \Psi_{bm}(\I_1) = \alpha \Psi_{ecm}(\I_1) + (1-\alpha) \Psi_{cell}(\I_1),
\end{equation}
where $\alpha > 0$ is the fraction of ECM content in muscle,
\begin{equation}\label{eq:def_Psi_ecm}
    \Psi_{ecm}(\I_1) = s_{ecm} \sum_{k=1}^3 c_k (\I_1 - 3)^k,
\end{equation}
and
\begin{equation}\label{eq:def_Psi_cell}
    \Psi_{cell}(\I_1) = s_{cell} \sum_{k=1}^3 c_k (\I_1 - 3)^k.
\end{equation}
In this case, the fictitious stress tensors for each one of these SEFs are given by:
\begin{gather}
    \bar{\*S}_{ecm} = s_{ecm} \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \*I, \\
    \bar{\btau}_{ecm} = s_{ecm} \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \bar{\*b},
\end{gather}
and
\begin{gather}
    \bar{\*S}_{cell} = s_{cell} \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \*I, \\
    \bar{\btau}_{cell} = s_{cell} \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \bar{\*b}.
\end{gather}

The constants $\sigma_{0,base}$, $s_{base}$, $s_{ecm}$, $s_{cell}$, as well as $c_k$ (which are local to each SEF), are given in Table \ref{tab:constants_base_material_muscle}. Note that the bulk modulus $\kappa$ used to define the volumetric component $\Psi_{vol}$ of the SEF $\Psi$ now takes the form
\begin{equation} \label{eq:def_kappa_ecm_cell}
    \kappa = \alpha \kappa_{ecm} + (1-\alpha) \kappa_{cell},
\end{equation}
where $\kappa_{ecm}$ and $\kappa_{cell}$ are the bulk moduli for ECM and cellular material, respectively.

\begin{table}
    \centering
    \begin{tabular}{|c|c|c|c|c|c|}\hline
        & Value in $\Psi_{bm}$ \eqref{eq:def_Psi_bm} & & Value in $\Psi_{ecm}$ \eqref{eq:def_Psi_ecm} & & Value in $\Psi_{cell}$ \eqref{eq:def_Psi_cell} \\\hline
        $\sigma_{0,bm}$ & 200000 \si{Pa} & - & - & - & - \\\hline
        $s_{bm}$ & 1 & $s_{ecm}$ & 200 \si{Pa} & $s_{cell}$ & 1 \si{Pa} \\\hline
        $c_1$ & 0.1990559575103343 & $c_1$ & 1988.76435209844 & $c_1$ & 3703.32723408173 \\\hline
        $c_2$ & 0.3662334826469149 & $c_2$ & 4917.02551347748 & $c_2$ & -707.76064007684 \\\hline
        $c_3$ & 0.0 & $c_3$ & -591.533166457473 & $c_3$ & 123.247643527575 \\\hline
    \end{tabular}
    \caption{Constants in the SEFs defining the base material component of muscle tissue.
    \label{tab:constants_base_material_muscle}}
\end{table}

\subsection{Intramuscular fat}

Following \cite{KonnoEtAl2022_CP}, we consider the following SEF to model intramuscular fat:
\begin{equation} \label{eq:def_Psi_fat}
    \Psi_{fat}(\I_1) = s_{fat} \sum_{k=1}^3 c_k (\I_1 - 3)^k,
\end{equation}
where $s_{fat}$ is a scaling factor and the constants $c_k$ are computed so that the expression above fits the data by Alkhouli et al. \cite{Alkhouli2013}. The values for these constants are listed in Table \ref{tab:constants_fat}. Thus, the expressions for the fictitious stress tensors become:
\begin{equation}
    \bar{\*S}_{fat} = s_{fat} \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \*I, 
\end{equation}
and
\begin{equation}
    \bar{\btau}_{fat} = s_{fat} \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \bar{\*b}.
\end{equation}

\begin{table}
    \centering
    \begin{tabular}{|c|c|}\hline
        & Value in $\Psi_{fat}$ \eqref{eq:def_Psi_fat} \\\hline
        $s_{fat}$ & 1 \si{Pa} \\\hline
        $c_1$ & 323.91 \\\hline
        $c_2$ & 5163.1 \\\hline
        $c_3$ & -3872.9 \\\hline
    \end{tabular}
    \caption{Constants in the SEF defining intramuscular fat. \label{tab:constants_fat}}
\end{table}

\section{Extending the SEF to the muscle-tendon unit} \label{sec:extension_sef_mtu}

From the expressions in the previous section, we can (at least, formally) construct the following SEF for muscle tissue:
\begin{equation}
    \Psi_{muscle}(\I_1, \I_4; \dot{\I}_4) = \Psi_{fibre}(\I_4; \dot{\I}_4) + \Psi_{bm}(\I_1).
\end{equation}
This also provides the additive structure for the respective stress tensors, for example:
\begin{equation}
    \bar{\btau}_{muscle} = \bar{\btau}_{fibre} + \bar{\btau}_{bm}.
\end{equation}

Furthermore, intramuscular fat can be added to the SEF for muscle via homogenization \cite[Model M4]{RahemiNigamWakeling2015}, resulting in the following SEF:
\begin{equation}
    \Psi_{muscle} = (1-\alpha) \left( \Psi_{fibre} + \Psi_{bm} \right) + \alpha \Psi_{fat},
\end{equation}
where $\alpha > 0$ is the fraction of intramuscular fat present in muscle tissue. In addition, the bulk modulus for $\Psi_{vol}$ takes the form
\begin{equation} \label{eq:def_kappa_bm_fat}
    \kappa = (1-\alpha) \kappa_{bm} + \alpha \kappa_{fat},
\end{equation}
where $\kappa_{bm}$ and $\kappa_{fat}$ are the bulk moduli for the base material and fat components. In particular, $\kappa_{bm}$ can be taken as a single constant or as the homogenized version in Equation \eqref{eq:def_kappa_ecm_cell}.

The previous expressions are applicable only to geometries made entirely of muscle tissue, without internal or external tendons. To create a SEF for the whole muscle-tendon unit, let us consider a partition of the geometry of interest into three parts $\B_0 = \B_0^M \cup \B_0^A z \cup \B_0^T$, where $\B_0^M$, $\B_0^A$, and $\B_0^T$ represent the parts of $\B_0$ made of muscle tissue, aponeurosis, and tendon. Thus, a SEF for the MTU reads:
\begin{equation}
    \Psi_{MTU}(\*X,t) = \Psi_{muscle}(\*X,t) \bchi_M(\*X) + \Psi_{apo}(\*X,t) \bchi_A(\*X) + \Psi_{ten}(\*X,t) \bchi_T(\*X),
\end{equation}
where $\bchi_M(\*X)$, $\bchi_A(\*X)$, and $\bchi_T(\*X)$ are indicator functions on $\B_0^M$, $\B_0^A$, and $\B_0^T$, respectively. Here, following \cite{Paper1_WakelingEtAl2020}, we consider the following SEF for the tendon and aponeurosis components:
\begin{equation}
    \Psi_{tis} = \Psi_{vol,tis}(J) + \Psi_{iso,tis}(\I_1,\I_4), \quad tis \in \{apo,ten\}.
\end{equation}
Similar to muscle tissue, the volumetric part is given by
\begin{equation}
    \Psi_{vol,tis} = \dfrac{\kappa_{tis}}{4} \left( J^2 - 2\ln J - 1 \right), \quad tis \in \{apo,ten\},
\end{equation}
where $\kappa_{apo}$ and $\kappa_{tendon}$ are the bulk moduli for aponeurosis and tendon, respectively. On the other hand, the isochoric component is given by:
\begin{equation}
    \Psi_{iso,tis} = \Psi_{tis,fibre}(\I_4) + \Psi_{tis,bm}(\I_4), \quad tis \in \{apo,ten\},
\end{equation}
as tendon and aponeurosis are also transversally-isotropic materials.

Assuming that $\Psi_{tis,fibre}$ satisfies:
\begin{equation}
    2 \I_4 \pder{\Psi_{tis,fibre}}{\I_4} = \sigma_{0,tis} \sigma_{tis}(\bar{\lambda})
\end{equation}
for a given stress-stretch relationship $\sigma_{tis}$, we obtain the following stress tensors:
\begin{align}
    \bar{\*S}_{tis,fibre} &= \dfrac{1}{\bar{\lambda}^2} \sigma_{0,tis} \sigma_{tis}(\bar{\lambda}) \, \*a_0 \otimes \*a_0, \\
    \bar{\btau}_{tis,fibre} &= \dfrac{1}{\bar{\lambda}^2} \sigma_{0,tis} \sigma_{tis}(\bar{\lambda}) \, \bar{\*a} \otimes \bar{\*a}.
\end{align}
Moreover, assuming that $\Psi_{tis,bm}$ is given by a Yeoh SEF:
\begin{equation} \label{eq:def_Psi_tis_bm}
    \Psi_{tis,bm} = s_{tis} \sigma_{0,tis} \sum_{k=1}^3 c_k (\I_1 - 3)^k,
\end{equation}
we obtain the following stress tensors:
\begin{align}
    \bar{\*S}_{tis, bm} = 2 s_{tis} \sigma_{0,tis}  \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \*I, \\
    \bar{\btau}_{tis,bm} = 2 s_{tis} \sigma_{0,tis}  \left( 3c_3(\I_1-3)^2 + 2c_2 (\I_1-3) + c_1 \right) \bar{\*b}.
\end{align}
Following \cite{Seba} we assume that the constants $c_1$, $c_2$, and $c_3$ are identical for tendon and aponeurosis. These have been fitted in \cite{Seba} from wild turkey gastrocnemii data \cite{Azizi2009} and are listed in Table \ref{tab:constants_ten_apo}.

\begin{table}
    \centering
    \begin{tabular}{|c|c|}\hline
        & Value in $\Psi_{tis}$ \eqref{eq:def_Psi_tis_bm} \\\hline
        $s_{tis}$ & 1 \\\hline
        $\sigma_{0,tis}$ & 200,000 \si{Pa} \\\hline
        $c_1$ & 4.6896264975 \\\hline
        $c_2$ & -3.45514101975 \\\hline
        $c_3$ & $4.8492055395 \cdot 10^2$ \\\hline
    \end{tabular}
    \caption{Constants in the SEF defining tendon and aponeurosis. \label{tab:constants_ten_apo}}
\end{table}

%Furthermore, the bulk modulus $\kappa$ takes the form
%\begin{equation}
%    \kappa(\*X) = \kappa_{muscle} \bchi_M(\*X) + \kappa_{apo} \bchi_A(\*X) + \kappa_{ten} \bchi_T(\*X),
%\end{equation}
%where $\kappa_{apo}$ and $\kappa_{tendon}$ are the bulk moduli for aponeurosis and tendon, respectively. In turn, $\kappa_{muscle}$ can be taken either as a single constant, or as a combination of the homogenized versions \eqref{eq:def_kappa_ecm_cell} and \eqref{eq:def_kappa_bm_fat}, that is
%\begin{equation}
%    \kappa_{muscle} = (1-\alpha) \left[ \beta \kappa_{ecm} + (1-\beta) \kappa_{cell} \right] + \alpha \kappa_{fat}.
%\end{equation}

%\subsection{Tendon and aponeurosis}

%Similar to muscle tissue, tendon and aponeurosis are made of dense fibrous connective tissues. However, 

%\begin{itemize}
%    \item SAME PROPERTIES (for tendon and aponeurosis) \cite{BlemkerDelp2005,BolReese2008}
%    \item DIFFERENT PROPERTIES \cite{Hadi}.
%    \item SAME STRUCTURE, PARAMETERS CAN VARY \cite{Seba}
%\end{itemize}

\section{Lagrangian formulation of the elastodynamic problem}

Let $\B_0 \subset \R^3$ be a geometrical representation of the underformed muscle-tendon unit (MTU), potentially containing a combination of muscle, aponeurosis, and tendon, as described in \ref{sec:extension_sef_mtu}. The boundary of this body, $\partial \B_0$, can be subdivided into two parts: $\partial \B_0 = \Gamma_{0,D} \cup \Gamma_{0,N}$, with $\Gamma_{0,D} \cap \Gamma_{0,N} = \emptyset$. They represent respectively the Dirichlet and Neumann parts of the boundary in the reference configuration. Let also $\B_t$ denote the deformed MTU at time $t > 0$.

The elastodynamic deformation of the MTU can be modelled using a system of PDEs in which, given an initial displacement $\*U_0 \in \*H^1(\B_0)$, an initial velocity $\*V_0 \in \*H^1(\B_0)$, an initial pressure $p_0 \in L^2(\B_0)$, a body force $\*f_0(\cdot, t) \in \*L^2(\B_0)$, a prescribed traction $\*T(\cdot,t) \in \*H^{-1/2}(\Gamma_{N,0})$, and a prescribed displacement $\*U_D(\cdot, t) \in \*H^{1/2}(\Gamma_{D,0})$, we want to find large (material) displacements $\*U(\cdot,t) \in \*H^1(\B_0)$, a (material) velocity $\*V \in \*H^1(\B_0)$, a (material) internal pressure $p(\cdot,t) \in L^2(\B_0)$, and a (material) dilation $D(\cdot, t) \in L^2(\B_0)$ such that

\begin{subequations} \label{eq:LF_main_system}
    \begin{align}
        \label{eq:LF_main_system_1}\pder{\*U}{t} &= \*V  \quad \text{in } \B_0 \times (0,\infty),\\
        \label{eq:LF_main_system_2}\rho_0 \pder{\*V}{t} - \Divt{\*P(\*U,\*V,p,D)} &= \*f_0 \quad \text{in } \B_0 \times (0,\infty), \\
        \label{eq:LF_main_system_3}J(\*U) - D &= 0 \quad \text{in } \B_0 \times (0,\infty), \\
        \label{eq:LF_main_system_4}p-\Psi'_{vol}(D) &= 0 \quad \text {in } \B_0 \times (0,\infty), \\
        \*U &= \*U_D \quad \text{on } \Gamma_{D,0} \times (0,\infty), \\
        \label{eq:bc_traction_0}\*P(\*U,\*V,p,D) \*N &= \*T \quad \text{on }\Gamma_{N,0} \times (0,\infty), \\
        \*U = \*U_0, \quad \*V=\*V_0, \quad p=p_0, \quad D &= D_0 \quad \text{in } \B_0 \times \{t=0\}.
    \end{align}
\end{subequations}
Here, the first expression corresponds to the definition of the material velocity (see Remark \ref{re:velocity_def}), whereas the second equation is just Cauchy's first equation of motion written in the Lagrangian description (see \cite[Section 4.3]{HolzapfelBook}). In addition, $\rho_0$ denotes the \textit{reference density} of the MTU, and although it might depend on space coordinates $\*X$, it does not depend on time.

The set of equations \eqref{eq:LF_main_system} corresponds to a dynamic extension of the Euler-Lagrange equations that arise from the stationarity of the potential:
\begin{equation} \label{eq:potential_qs}
    \Pi(\*U,p,D) = \int_{\B_0} \Psi_{vol}(D) + p(J(\*U) - D) + \Psi_{iso}(\bar{\*C}) - \int_{\B_0} \*f_0 \cdot \*U.
\end{equation}
Therefore, we refer to \eqref{eq:LF_main_system} as the \textit{dynamic} system. In turn, if we neglect the effect of the velocity on the system (i.e. $\*V \equiv 0$) as in \eqref{eq:potential_qs}, then we refer to \eqref{eq:LF_main_system} as the \textit{quasi-static} system.

We also note that the system \eqref{eq:LF_main_system_1}-\eqref{eq:LF_main_system_4} is equivalent to the Eulerian formulation developed by Dominguez \cite{Seba}:
\begin{subequations} \label{eq:EF_main}
    \begin{align}
    \label{eq:EF_1}\pder{\*u}{t} &= \*v  \quad \text{in } \B_t,\\
    \label{eq:EF_2}\pder{(\rho \*v)}{t} + \divt{(\rho \*v \otimes \*v)} - \divt{\bsigma(\*u,\*v,p,D)} &= \*f \quad \text{in } \B_t, \\
    \label{eq:EF_3}J(\*u)-D &= 0 \quad \text{in } \B_t, \\
    \label{eq:EF_4}p-\Psi'_{vol}(D) &= 0 \quad \text {in } \B_t,
    \end{align}
\end{subequations}
where the density in the current configuration $\rho$ is given by
\begin{equation}
    \rho = \dfrac{\rho_0}{J(\*u)},
\end{equation}
and the body force $\*f$ is:
\begin{equation}
    \*f(\*x,t) = J(\*U)^{-1} \, \*f_0(\bm{\varphi}^{-1}(\*x,t),t).
\end{equation}
However, we have chosen to work with the Lagrangian formulation \eqref{eq:LF_main_system} because it leads to a simpler variational formulation, which consequently leads to a (significantly) simpler linearization of the problem (see below).

\section{A first order, fully implicit time discretization}

Based on the Neo-Hookean experiments we performed in Chapter \ref{ch:neohookean}, we discretize \eqref{eq:LF_main_system} using Rothe's method with a first-order time stepping scheme. Hence, consider a time step size $\Delta t = T/N$ and time steps $t_n = n \Delta t$, with $n=0,\dots,N$ and $T > 0$ the simulation end time. For each $n \geq 0$, we seek approximations $\*U^{n+1}(\*X) \approx \*U(\*X,t^{n+1})$, $\*V^{n+1}(\*X) \approx \*V(\*X,t^{n+1})$, $p^{n+1}(\*X) \approx p(\*X,t^{n+1})$, $D^{n+1}(\*X) \approx D(\*X,t^{n+1})$ such that:
\begin{subequations}
    \begin{align}
    \dfrac{\*U^{n+1} - \*U^n}{\Delta t} &= \*V^{n+1} \quad \text{in } \B_0, \\
    \rho_0 \dfrac{\*V^{n+1} - \*V^n}{\Delta t} - \Divt{\*P(\*U^{n+1}, \*V^{n+1}, p^{n+1}, D^{n+1})} &= \*f_0^{n+1} \quad \text{in } \B_0, \\
    J(\*U^{n+1}) - D^{n+1} &= 0 \quad \text{in } \B_0, \\
    p^{n+1}-\Psi'_{vol}(D^{n+1}) &= 0 \quad \text {in } \B_0, \\
    \label{eq:bc0_1} \*U^{n+1} &= \*U_D^{n+1} \quad \text{on } \Gamma_{D,0}, \\
    \label{eq:bc0_2} \*P(\*U^{n+1},\*V^n,p^{n+1},D^{n+1}) \*N &= \*T^{n+1} \quad \text{on }\Gamma_{N,0}.
    \end{align}
\end{subequations}
Combining the first two equations above we obtain the following displacement-pressure-dilation system: for each $n \geq 0$, find $\*U^{n+1}$, $p^{n+1}$, and $D^{n+1}$ such that:
\begin{subequations}\label{eq:LF_time}
    \begin{align}
    \label{eq:LF_time_1}\rho_0 \*U^{n+1} - \Delta t^2 \, \Divt{\*P(\*U^{n+1}, \*V^{n+1}, p^{n+1}, D^{n+1})} &= \rho_0 \*U^n + \Delta t \, \rho_0 \*V^n + \Delta t^2 \*f_0^{n+1}, \\
    \label{eq:LF_time_2}D^{n+1}-J(\*u^{n+1}) &= 0 , \\
    \label{eq:LF_time_3}p^{n+1}-\Psi'_{vol}(D^{n+1}) &= 0,
    \end{align}
\end{subequations}
with boundary conditions \eqref{eq:bc0_1} and \eqref{eq:bc0_2}. 

To construct the nonlinear variational formulation for this problem, consider test functions $\delta \*U \in \*H^1_0(\B_0)$, $\delta p \in L^2(\B_0)$, and $\delta D \in L^2(\B_0)$. Multiplying \eqref{eq:LF_time_1} by $\delta \*U$ and integrating by parts, we obtain
\begin{multline} \label{eq:weak0_1}
    \int_{\B_0} \rho_0 \*U^{n+1} \cdot \delta \*U + \Delta t^2 \int_{\B_0} \*P(\*U^{n+1},\*V^{n+1}) : \nabla_0(\delta \*U)  \\
    = \int_{\B_0} \rho_0 \*U^n \cdot \delta\*U + \Delta t \int_{\B_0} \rho_0 \*V^n \cdot \delta\*U + \Delta t^2 \int_{\B_0} \*f_0^{n+1} \cdot \delta\*U + \Delta t^2 \int_{\Gamma_{N,0}} \*T^{n+1} \cdot \delta \*U.
\end{multline}
Furthermore, we can use \eqref{eq:def_PK1} to rewrite the second term in the previous expression as:
\begin{multline*}
    \int_{\B_0} \*P(\*U^{n+1},\*V^{n+1}, p^{n+1}, D^{n+1}) : \nabla_0(\delta \*U) \\
    \begin{aligned}
        &= \int_{\B_0}  J(\*U^{n+1}) \, \bsigma(\*U^{n+1},\*V^n, p^{n+1}, D^{n+1}) : \nabla_0(\delta\*U) \*F(\*U^{n+1})^{-1} \\
        &= \int_{\B_0}  \btau(\*U^{n+1},\*V^n, p^{n+1}, D^{n+1}) : \nabla_0(\delta\*U) \*F(\*U^{n+1})^{-1}.
    \end{aligned}
\end{multline*}
Thus, we can rewrite \eqref{eq:weak0_1} as
\begin{multline} \label{eq:weak0_2}
\int_{\B_0} \rho_0 \*U^{n+1} \cdot \delta \*U + \Delta t^2 \int_{\B_0} \btau(\*U^{n+1},\*V^{n+1}) : \nabla_0(\delta\*U) \*F(\*U^{n+1})^{-1}  \\
= \int_{\B_0} \rho_0 \*U^n \cdot \delta\*U + \Delta t \int_{\B_0} \rho_0 \*V^n \cdot \delta\*U + \Delta t^2 \int_{\B_0} \*f_0^{n+1} \cdot \delta\*U + \Delta t^2 \int_{\Gamma_{N,0}} \*T^{n+1} \cdot \delta \*U. 
\end{multline}

Similarly, for equations \eqref{eq:LF_time_2} and \eqref{eq:LF_time_3}, we multiply them respectively by test functions $\delta p \in L^(\B_0)$ and $\delta D \in L^2(\B_0)$ and integrate:
\begin{equation} \label{eq:weak_3}
    \int_{\B_0} \Big\{  J(\*U^{n+1}) - D^{n+1}  \Big\} \cdot \delta p = 0,
    \end{equation}
and
\begin{equation} \label{eq:weak_4}
    \int_{\B_0} \Big\{ \psi'_{vol}(D^{n+1}) - p^{n+1} \Big\} \cdot \delta D = 0.
\end{equation}

Finally, multiplying \eqref{eq:weak0_2} by $\Delta t^{-2}$ and adding it to \eqref{eq:weak_3} and \eqref{eq:weak_4}, we obtain the following nonlinear formulation of the semi-discrete problem \eqref{eq:LF_time}: find $\*U^{n+1} \in \*H^1(\B_0)$, $p^{n+1} \in L^2(\B_0)$, and $D^{n+1} \in L^2(\B_0)$ such that
\begin{equation} \label{eq:LF_weak}
    R(\*U^{n+1},p^{n+1},D^{n+1} ; \delta\*U, \delta p, \delta D) = 0,
\end{equation}
for any $\delta\*U \in \*H_0^1(\B_0)$, $\delta p \in L^2(\B_0)$, and $\delta D \in L^2(\B_0)$, where
\begin{align} \label{eq:def_R_LF}
    \notag R(\*U^{n+1},&p^{n+1},D^{n+1} ; \delta\*U, \delta p, \delta D) := \\
    \notag &\Delta t^{-2} \int_{\B_0} \rho_0 \*U^{n+1} \cdot \delta\*U + \int_{\B_0} \btau(\*U^{n+1},\*V^{n+1}, p^{n+1}, D^{n+1}) : \nabla_0(\delta\*U) \*F(\*U^{n+1})^{-1} \\
    \notag &+ \int_{\B_0} \Big\{ J(\*U^{n+1}) - D^{n+1} \Big\} \cdot \delta p + \int_{\B_0} \Big\{ \psi'_{vol}(D^{n+1}) - p^{n+1} \Big\} \cdot \delta D \\
    \notag &- \Delta t^{-1} \int_{\B_0} \rho_0 \*V^n \cdot \delta\*U - \Delta t^{-2} \int_{\B_0} \rho_0 \*U^n \cdot \delta \*U - \int_{\Gamma_{N,0}} \*T^{n+1} \cdot \delta\*U \\
    &- \int_{\B_0} \*f_0^{n+1} \cdot \delta \*U.
\end{align}

We may also refer to \eqref{eq:LF_weak} as the (semi-discretized) \textit{principle of virtual work} \cite{HolzapfelBook}. In particular, we may split $R$ into three components:
\begin{equation}
    R = R_{ine} + R_{int} - R_{ext}.
\end{equation}
The (semi-discrete) work due to inertial, internal, and external forces are respectively given by:
\begin{align}
    \notag R_{ine}(\*U^{n+1} ; \delta\*U) &= \Delta t^{-2} \int_{\B_0} \rho_0 \*U^{n+1} \cdot \delta\*U \\
    \notag &- \Delta t^{-2} \int_{\B_0} \rho_0 \*U^n \cdot \delta\*U \\
    \label{eq:def_Rine}&- \Delta t^{-1} \int_{\B_0} \rho_0 \*V^n \cdot \delta\*U, \\
    \notag R_{int}(\*U^{n+1}, p^{n+1}, D^{n+1} ; \delta\*U, \delta p, \delta D) &= \int_{\B_0} \btau^{n+1} : \nabla_0(\delta\*U) \*F(\*U^{n+1})^{-1} \\
    \notag &+ \int_{\B_0} \Big\{ J(\*U^{n+1}) - D^{n+1} \Big\} \cdot \delta p \\
    \label{eq:def_Rint}&+ \int_{\B_0} \Big\{ \psi'_{vol}(D^{n+1}) - p^{n+1} \Big\} \cdot \delta D, \\
    \label{eq:def_Rext}R_{ext}(\delta \*U) &=  \int_{\Gamma_{N,0}} \*T^{n+1} \cdot \delta\*U + \int_{\B_0} \*f_0^{n+1}  \cdot \delta\*U,
\end{align}
where we have written $\btau^{n+1} = \btau(\*U^{n+1},\*V^{n+1}, p^{n+1}, D^{n+1})$.

\begin{remark}
    Using this notation, the quasi-static problem reads: find $\*U^{n+1} \in \*H^1(\B_0)$, $p^{n+1} \in L^2(\B_0)$, and $D^{n+1} \in L^2(\B_0)$ such that
    \begin{equation}
        R_{int}(\*U^{n+1}, p^{n+1}, D^{n+1} ; \delta\*U, \delta p, \delta D) = R_{ext}(\delta \*U),
    \end{equation} 
    for all virtual displacements $\delta\*U \in \*H_0^1(\B_0)$, virtual pressures $\delta p \in L^2(\B_0)$, and virtual dilations $\delta D \in L^2(\B_0)$. Recall that, in this case, the equations do not involve
\end{remark}

Before jumping into the linearization of the nonlinear problem \eqref{eq:LF_weak}, let us see how this formulation differs from the one introduced in \cite{Seba}.

\begin{remark}
    Consider the variational formulation for the Eulerian system \eqref{eq:EF_main} as in \cite[Equation 6.22]{Seba} pulled back to the reference configuration: find $\*U^{n+1} \in \*H^1(\B_0)$, $p^{n+1} \in L^2(\B_0)$, and $D^{n+1} \in L^2(\B_0)$ such that
    \begin{equation} \label{eq:EF_weak}
        \widetilde{R}(\*U^{n+1},p^{n+1},D^{n+1} ; \delta\*U, \delta p, \delta D) = 0,
    \end{equation}
    for any $\delta\*U \in \*H_0^1(\B_0)$, $\delta p \in L^2(\B_0)$, and $\delta D \in L^2(\B_0)$, where
    \begin{align} \label{eq:def_R_EF}
        \notag \widetilde{R}(\*U^{n+1},&p^{n+1},D^{n+1} ; \delta\*U, \delta p, \delta D) := \\
        \notag &\Delta t^{-2} \int_{\B_0} \rho_0 \*U^{n+1} \cdot \delta \*U + \int_{\B_0} \btau(\*U^{n+1},\*V^n, p^{n+1}, D^{n+1}) : \nabla^S_0(\delta\*U) \, \*F(\*U^{n+1})^{-1} \\
        \notag &+ \int_{\B_0} \Big\{  J(\*U^{n+1}) - D^{n+1} \Big\} \cdot \delta p + \int_{\B_0} \Big\{ \psi'_{vol}(D^{n+1}) - p^{n+1} \Big\} \cdot \delta D  \\
        \notag &- \Delta t^{-1} \int_{\B_0} \rho_0 \dfrac{J(\*U^{n+1})}{J(\*U^{n})} \*V^n \cdot \delta\*U \\
        \notag &-\int_{\B_0} \left(\rho_0 \dfrac{J(\*U^{n+1})}{J(\*U^{n})} \*V^n \otimes \*V^n\right) : \nabla^S_0(\delta \*U) \, \*F(\*U^{n+1})^{-1} \\
        \notag &+ \int_{\Gamma_{N,0}}  \left(\rho_0 \dfrac{J(\*U^{n+1})}{J(\*U^{n})} \*V^n \otimes \*V^n \right) \*F(\*U^{n+1})^{-T} \*N \cdot \delta \*U \\
        &- \Delta t^{-2} \int_{\B_0} \rho_0 \*U^n \cdot \delta \*U - \int_{\Gamma_{N,0}} \*T^{n+1} \cdot \delta\*U - \int_{\B_0} \*f_0^{n+1} \cdot \delta \*U.
    \end{align}
    Given that the Eulerian and the Lagrangian formulations model the exact same biological system but in difference frames of reference, it is clear that the nonlinear weak formulations \eqref{eq:LF_weak} and \eqref{eq:EF_weak} are approximating the same problem. However, the linearization for these problems involves the computation of derivatives with respect to $\*U^{n+1}$, $p^{n+1}$, and $D^{n+1}$ for the first four terms in \eqref{eq:def_R_LF}, as opposed to the first seven in \eqref{eq:def_R_EF}. Furthermore, the weak problem \eqref{eq:LF_weak} represents a departure from \eqref{eq:EF_weak} since we are now treating the velocity implicitly in the Kirchhoff stress $\btau$, as opposed to the explicit treatment in \eqref{eq:def_R_EF}.
\end{remark}

\section{Linearization}

We now derive in detail the linearization of the nonlinear formulation \eqref{eq:LF_weak}. First, we give general details of Newton iteration. Then, we compute each one of the block corresponding to the tangent operator. Finally, we focus on the computation of the fibre contribution to the fourth-order tensor $J\c$ since the expression that is typically not reported in the literature.

\subsection{Newton's method}

Given $\*U^n$, $\*V^n$, $\*U^{n+1}_k$, $p^{n+1}_k$, and $D^{n+1}_k$, we want to find updates $\*d \*U_k$, $d p_k$, and $d D_k$ such that:
\begin{multline} \label{eq:newton}
    \quad \bm{\mathcal{D}}R(\*U^{n+1}_k, p^{n+1}_k, D^{n+1}_k) \Big(d \*U_k, d p_k, d D_k ; \delta \*U, \delta p, \delta D \Big) \\
    = - R(\*U^{n+1}_k, p^{n+1}_k, D^{n+1}_k ; \delta \*U, \delta p, \delta D), \quad
\end{multline}
for all virtual increments $(\delta \*U, \delta p, \delta D)$, then update the solution as
\begin{equation} \label{eq:update_theory}
\*U^{n+1}_k = \*U^{n+1}_k + \*d \*U_k, \quad 
p^{n+1}_k = p^{n+1}_k + d p_k, \quad 
D^{n+1}_k = D^{n+1}_k + d D_k,
\end{equation}
until a convergence criterion is satisfied. Here, $\bm{\mathcal{D}} R$ denotes the G\^{a}teaux derivative of the operator $R$ ($\bm{\mathcal{D}} R$ also known as the \textbf{tangent operator}). At the current time step, we set the initial solution as the converged one from the previous time step, i.e.,
\begin{equation}
\*U_0^{n+1} = \*U^n,
\end{equation}
with analogous expressions for the pressure and dilation. Therefore, the solution can be updated as:
\begin{equation} \label{eq:update_practice}
\*U^{n+1}_{k+1} = \*U^{n+1}_k + \*d\*U_k = \*U^{n+1}_{k-1} + \*d\*U_{k-1} + \*d \*U_k = \dots = \*U_0^{n+1} + \Delta \*U_k = \*U^n + \Delta \*U_k,
\end{equation}
where we have defined the object:
\begin{equation}
\Delta \*U_k = \sum_{l = 0}^k \*d \*U_k.
\end{equation}

\begin{remark}
Computationally speaking, at the beginning of every time step, one would set the object $\Delta \*U_k$ to zero and then start updating recursively this quantity with each Newton step $\*d \*U_k$. Then, once convergence has been achieved, we can obtain the converged solution for the current time step as in the last equality of \eqref{eq:update_practice}. This approach turns out to be less prone to numerical (round off) errors than updating the solution directly as in \eqref{eq:update_theory}.
\end{remark}

\begin{remark}[Boundary conditions for the linearized system]
    Consistent with the variational problem \eqref{eq:LF_weak}, the linearized problem \eqref{eq:newton} requires boundary conditions for the displacements $\*d \*U_k$ at each iteration $k$ (at least in principle). To determine this, let us assume that for the time step $t_{n+1}$, the method converges in $K+1$ iterations. Thus, we can set $\*U^{n+1} := \*U_{K+1}^{n+1}$ and therefore, according to \eqref{eq:update_practice},
    \[
    \Delta \*U_K = \*d\*U_0 + \*d\*U_1 + \dots + \*d\*U_K = \*U^{n+1} - \*U^n.
    \]
    However, the displacements $\*U^{n+1}$ and $\*U^n$ are known along the Dirichlet part of the boundary. This suggests that, on $\Gamma_{0,D}$, we can set
    \begin{equation}
    \begin{aligned}
    \*d\*U_0 &= \*U^{n+1} - \*U^n, \\
    \*d\*U_1 &= \*0,  \\
    &\hspace{0.6em}\vdots \\
    \*d\*U_K &= \*0,
    \end{aligned}
    \end{equation}
    that is, the incremental displacement $\*U^{n+1}-\*U^n$ is only implemented at the first Newton iteration and zero Dirichlet boundary conditions can be assumed for the rest.
\end{remark}

\subsection{Construction of the block-matrix system}

We begin populating the elements forming the tangent operator $\bm{\mathcal{D}} R$ by linearizing each term in \eqref{eq:LF_weak}. First, for the inertial contribution, only the first term in \eqref{eq:def_Rine} depends on the current displacement, so the linearization of this term yields:
\begin{equation}
    \*K_{ine}^{\delta \*U, \*d \*U} := \der{}{\epsilon}R_{ine}(\*U_k^{n+1} + \epsilon \*d\*U_k ; \delta\*U) \Big|_{\epsilon = 0} = \Delta t^{-2} \int_{\B_0} \rho_0 \, \*d\*U_k \cdot \delta \*U.
\end{equation}

Next, for the internal contribution, the linearization of the first term in \eqref{eq:def_Rint} is discussed in general terms in \cite[Chapter 8]{HolzapfelBook}. This yields the term:
\begin{equation} \label{eq:def_K_int_11}
    \*K_{int}^{\delta \*U, \*d \*U} = \int_{\B_0} \nabla (\delta \*U) : J\c^{n+1}_k : \nabla(\*d\*U_k) + \int_{\B_0} \nabla(\delta \*U) : \nabla (\*d\*U_k) \btau^{n+1},
\end{equation}
where $\c^{n+1}_k = \c(\*U^{n+1}_k, \*V^{n+1}_k, p^{n+1}_k, D^{n+1}_k)$ is the fourth-order elasticity tensor defined in \eqref{eq:def_c_spatial}. The computation of this tensor will be the main focus of Section \ref{sec:elasticity_tensors}.

The rest of the contributions with respect to virtual displacements are easier to compute. Following \eqref{eq:def_tau}, we use the decomposition 
\begin{equation}
    \btau = \btau_{vol}(J) + \btau_{iso}(\*U,\*V),
\end{equation}
as the pressure only appears in the volumetric part of the Kirchhoff stress and there is no dependence on the approximate dilation $D$:
\begin{equation}
\begin{aligned}
\*K^{\delta \*U, dp} &= \der{}{\epsilon} R_{int}(\*U^{n+1}_k, p^{n+1}_k + \epsilon dp_k, D^{n+1}_k; \delta\*U) \Big|_{\epsilon=0} \\
&= \int_{\B_0} dp_k J \, \*I : \nabla(\delta\*U) \\
&= \int_{\B_0} dp_k J \, \*I : \Big\{ \nabla_0(\delta\*U) \*F(\*U^{n+1}_k)^{-1} \Big\}
\end{aligned},
\end{equation}
and $\*K^{\delta\*U, dD} = 0$. Next, for the contributions with respect to virtual pressures, we have
\begin{equation}
\begin{aligned}
\*K^{\delta p, \*d\*U} &= \der{}{\epsilon} R_{int}(\*U^{n+1}_k + \epsilon \*d\*U_k, p^{n+1}_k, D^{n+1}_k ; \delta p) \Big|_{\epsilon=0} \\
&= \int_{\B_0} \delta p J \, \*I : \nabla (\*d\*U_k) \\
&= \int_{\B_0} \delta p J \, \*I : \Big\{ \nabla_0 (\*d\*U_k) \*F(\*U^{n+1}_k)^{-1} \Big\},
\end{aligned}
\end{equation}
$\*K^{\delta p, dp} = 0$, and
\begin{equation}
\begin{aligned}
\*K^{\delta p, dD} &= \der{}{\epsilon}R_{int}(\*U^{n+1}_k, p^{n+1}_k, D^{n+1}_k + \epsilon dD_k ; \delta p) \Big|_{\epsilon=0} \\
&= - \int_{\B_0} dD \, \delta p.
\end{aligned}
\end{equation}
Finally, for the contributions with respect to virtual dilations, we have $\*K^{\delta D, \*d\*U} = 0$, 
\begin{equation}
\begin{aligned}
\*K^{\delta D, dp} &= \der{}{\epsilon} R_{int}(\*U^{n+1}_k, p^{n+1}_k + \epsilon dp_k, D^{n+1}_k; \delta D) \Big|_{\epsilon=0}  \\
&= -\int_{\B_0}  dp \, \delta D,
\end{aligned}
\end{equation}
and
\begin{equation}
\begin{aligned}
\*K^{\delta D, dD} &= \der{}{\epsilon}R_{int}(\*U^{n+1}_k, p^{n+1}_k, D^{n+1}_k + \epsilon dD_k ; \delta D) \Big|_{\epsilon=0} \\
&= \int_{\B_0} \Psi_{vol}''(D^{n+1}_k) \, dD \, \delta D.
\end{aligned}
\end{equation}

Therefore, the problem \eqref{eq:newton} can be (at least formally) written in matrix form as:
\begin{equation} \label{eq:LF_linear_system}
    \left[\begin{matrix}
    \*K_{ine}^{\delta \*U, \*d\*U} + \*K_{int}^{\delta \*U, \*d\*U} & \*K^{\delta \*U, dp} & \*0 \\
    \*K^{\delta p, \*d\*U} & \*0 & \*K^{\delta p, dD} \\
    \*0 & \*K^{\delta D, dp} & \*K^{\delta D, dD}
    \end{matrix}\right] 
    \left( \begin{matrix}
      d\*U_k \\ dp_k \\ dD_k
    \end{matrix}\right) = -
    \left(\begin{matrix}
      R_{ine}(\*U^{n+1}_k) + R_{int}(\*U^{n+1}_k) \\
      R_{int}(p^{n+1}_k)\\
      R_{int}(D^{n+1}_k)
    \end{matrix}\right).
\end{equation}

\subsection{Fourth-order elasticity tensors} \label{sec:elasticity_tensors}

To compute the fourth-order elastcity tensor $\c^{n+1}$, we first need to find the material tensor $\bar{\C}$ (see Equations \eqref{eq:def_c}, \eqref{eq:Jc_iso}, and \eqref{eq:def_c_bar}). Furthermore, each contribution to isochoric SEF $\Psi_{iso}$ yields a different contribution to the elasticity tensor $\bar{\C}$. For example, if we assume the material contains muscle fibres \eqref{eq:ode_fibre_sef}, base material \eqref{eq:def_Psi_bm}, and intramuscular fat \eqref{eq:def_Psi_fat}, that is:
\begin{equation}
    \Psi_{iso} = (1-\alpha)(\Psi_{fibre} + \Psi_{bm}) + \alpha \Psi_{fat},
\end{equation}
then
\begin{equation}
    \bar{\C} = (1-\alpha)(\bar{\C}_{fibre} + \bar{\C}_{bm}) + \alpha \bar{\C}_{fat},
\end{equation}
with analogous expressions if ECM, cell, tendon, or aponeurosis tissues are included.

The derivation of all parts that make the $\bar{\C}$ tensor follows the same structure, so we will only focus on the fibre contribution. First, according to \eqref{eq:def_C_bar}, we have
\begin{equation}
    J^{4/3} \bar{\C}_{fibre}^{n+1} = 2 \pder{\bar{\*S}_{fibre}^{n+1}}{\bar{\*C}^{n+1}} = 2 \pder{\bar{\*S}_{fibre}^{n+1}}{\I_4^{n+1}} \otimes \pder{\I_4^{n+1}}{\bar{\*C}^{n+1}},
\end{equation}
which, from \eqref{eq:derivatives_invariants} and the particular expression for $\bar{\*S}_{fibre}$ in \eqref{eq:def_S_fibre}, we obtain
\begin{align}
    \notag J^{4/3} \bar{\C}_{fibre}^{n+1} &= 2 \pder{}{\I_4^{n+1}} \left[ \dfrac{1}{\I_4^{n+1}} \sigma_{Hill}(\I_4^{n+1})\right] \*a_0 \otimes \*a_0 \otimes \*a_0 \otimes \*a_0 \\
    &= 2 \left[ -\dfrac{1}{\left(\I_4^{n+1}\right)^2} \sigma_{Hill}(\I_4^{n+1}) + \dfrac{1}{\I_4^{n+1}} \pder{\sigma_{Hill}(\I_4^{n+1})}{\I_4^{n+1}} \right] \*a_0 \otimes \*a_0 \otimes \*a_0 \otimes \*a_0
\end{align}
At this juncture, we emphasize that these expressions are meant to be evaluated at the current Newton iteration $k$ (see \eqref{eq:def_K_int_11}). Thus, using the expression for Hill's fibre stress \eqref{eq:def_hill_stress_sigma}, we obtain
\begin{align}
    \notag \pder{\sigma_{Hill}(\I_4^{n+1})}{\I_4^{n+1}} &= \pder{\sigma_{Hill}(\bar{\lambda}^{n+1}_k, \bar{\depsilon}^{n+1}_k)}{\bar{\lambda}^{n+1}_k} \pder{\bar{\lambda}^{n+1}_k}{\I_4^{n+1}} +  \pder{\sigma_{Hill}(\bar{\lambda}^{n+1}_k, \bar{\depsilon}^{n+1}_k)}{\bar{\depsilon}^{n+1}_k} \pder{\bar{\depsilon}^{n+1}_k}{\bar{\lambda}^{n+1}_k} \pder{\bar{\lambda}^{n+1}_k}{\I_4^{n+1}} \\
    \notag &= \sigma_{0,mus} \left[ a^{n+1} \der{\sigma_L(\bar{\lambda}^{n+1}_k)}{\bar{\lambda}^{n+1}_k} \sigma_V(\bar{\depsilon}^{n+1}_k) + \der{\sigma_P(\bar{\lambda}^{n+1}_k)}{\bar{\lambda}^{n+1}_k} \right] \dfrac{1}{2\bar{\lambda}^{n+1}_k} \\
    &\hspace{9em}+ \sigma_{0,mus} a^{n+1} \sigma_L(\bar{\lambda}^{n+1}_k) \der{\sigma_{V}(\bar{\depsilon}^{n+1}_k)}{\bar{\depsilon}^{n+1}_k} \pder{\bar{\depsilon}^{n+1}_k}{\bar{\lambda}^{n+1}_k} \dfrac{1}{2\bar{\lambda}^{n+1}_k}.
\end{align}

In particular, following the definition of the modified strain rate $\bar{\depsilon}$ in \eqref{eq:def_strain_rate_bar} we consider:
\begin{equation}
    \bar{\depsilon}^{n+1}_k = \dfrac{1}{\depsilon_0} \dfrac{(\bar{\*F}_k^{n+1}\*a_0)^\T (\p : \*d^{n+1}_k) (\bar{\*F}_k^{n+1} \*a_0)}{\bar{\lambda}^{n+1}_k},
\end{equation}
where, according to \eqref{eq:def_l_spatial_velocity_gradient},
\begin{equation}
    \*d_k^{n+1} = \mathrm{symm} \left( \dfrac{\*F_k^{n+1} - \*F^n}{\Delta t} \left(\*F_k^{n+1}\right)^{-1} \right).
\end{equation}
However, for the term $\pder{\bar{\depsilon}^{n+1}_k}{\bar{\lambda}^{n+1}_k}$ (and only for this term), we approximate $\bar{\depsilon}^{n+1}_k$ as:
\begin{equation}
    \bar{\depsilon}^{n+1}_k \approx \dfrac{\bar{\lambda}^{n+1}_k - \bar{\lambda}^n}{\Delta t},
\end{equation}
and thus we set:
\begin{equation}
    \pder{\bar{\depsilon}^{n+1}_k}{\bar{\lambda}^{n+1}_k} = \dfrac{1}{\Delta t}.
\end{equation}

Therefore, the full expression for $J^{4/3} \bar{\C}_{fibre}^{n+1}$ reads:
\begin{equation}
    \notag J^{4/3} \bar{\C}_{fibre}^{n+1} = \mathfrak{C}\left(\bar{\lambda}^{n+1}_k, \bar{\depsilon}^{n+1}_k \right) \, \*a_0 \otimes \*a_0 \otimes \*a_0 \otimes \*a_0,
\end{equation}
where
\begin{align}
    \mathfrak{C}\left(\bar{\lambda}^{n+1}_k, \bar{\depsilon}^{n+1}_k \right) = &- \dfrac{2}{\left( \bar{\lambda}^{n+1}_k \right)^4} \, \sigma_{0,mus} a^{n+1} \sigma_L(\bar{\lambda}^{n+1}_k) \sigma_V(\bar{\depsilon}^{n+1}_k) \\
    \notag &+ \dfrac{1}{\left( \bar{\lambda}^{n+1}_k \right)^3} \, \sigma_{0,mus} a^{n+1} \der{\sigma_L}{\bar{\lambda}} \left( \bar{\lambda}^{n+1}_k \right) \sigma_V(\bar{\depsilon}^{n+1}_k) \\
    \notag &+ \dfrac{1}{\left( \bar{\lambda}^{n+1}_k \right)^3} \, \sigma_{0,mus} a^{n+1} \sigma_L(\bar{\lambda}^{n+1}_k) \der{\sigma_V}{\bar{\depsilon}} \left( \bar{\depsilon}^{n+1}_k \right) \dfrac{1}{\Delta t} \\
    \notag &- \dfrac{2}{\left( \bar{\lambda}^{n+1}_k \right)^4} \, \sigma_{0,mus} \sigma_P(\bar{\lambda}^{n+1}_k) \\
    &+ \dfrac{1}{\left( \bar{\lambda}^{n+1}_k \right)^3} \, \sigma_{0,mus} \der{\sigma_P}{\bar{\lambda}} \left( \bar{\lambda}^{n+1}_k  \right)
\end{align}
In this way,
\begin{equation}
    \bar{\c}_{fibre}^{n+1} = \mathfrak{C}\left(\bar{\lambda}^{n+1}_k, \bar{\depsilon}^{n+1}_k \right) \, \bar{\*a} \otimes \bar{\*a} \otimes \bar{\*a} \otimes \bar{\*a},
\end{equation}
where $\bar{\*a} = \bar{\*F} \*a_0$.

\begin{remark}
    If the simulation is quasi-static, then Hill's stress does not depend on the fibre strain rate, and therefore
    \begin{equation}
        \bar{\c}_{fibre}^{n+1} = \widetilde{\mathfrak{C}} \left(\bar{\lambda}^{n+1}_k \right) \, \bar{\*a} \otimes \bar{\*a} \otimes \bar{\*a} \otimes \bar{\*a},
    \end{equation}
    where
    \begin{align}
        \notag \widetilde{\mathfrak{C}} \left(\bar{\lambda}^{n+1}_k \right) = &-\dfrac{2\sigma_{0,mus}}{(\bar{\lambda}^{n+1})^4} \, \left[ a^{n+1} \widehat{\sigma}_A(\bar{\lambda}^{n+1})  + \widehat{\sigma}_P(\bar{\lambda}^{n+1}) \right] \\
        &+ \dfrac{\sigma_{0,mus}}{(\bar\lambda^{n+1})^3} \Bigg[ a^{n+1} \der{\widehat{\sigma}_A(\bar\lambda^{n+1})}{\bar\lambda^{n+1}} + \der{\sigma_P(\bar{\lambda}^{n+1})}{\bar{\lambda}^{n+1}} \Bigg]
    \end{align}
\end{remark}

Following the same procedure, we obtain the contributions to $\bar{\c}$ from the base material components:
\begin{align}
    \bar{\c}_{bm}^{n+1} &= 4 s_{bm} \sigma_{0,bm} \left( 6 c_3 (\I_1-3) + 2c_2 \right) \, \*I \otimes \*I \\
    \bar{\c}_{ecm}^{n+1} &= 4 s_{ecm} \left( 6 c_3 (\I_1-3) + 2c_2 \right) \, \*I \otimes \*I \\
    \bar{\c}_{cel}^{n+1} &= 4 s_{cell} \left( 6 c_3 (\I_1-3) + 2c_2 \right) \, \*I \otimes \*I
\end{align}
(with the constants defined in Table \ref{tab:constants_base_material_muscle}) and from the intramuscular fat:
\begin{equation}
    \bar{\c}_{fat}^{n+1} = 4 s_{fat} \left( 6 c_3 (\I_1-3) + 2c_2 \right) \, \*I \otimes \*I,
\end{equation}
with the constants in this case defined in Table \ref{tab:constants_fat}.

\section{Finite element approximation}

Let $\mathcal{T}_h$ be an unstructured mesh made of hexahedra $T \in \mathcal{T}_h$, each with diameter $h_T$. Furthermore, define the mesh size $h := \max_{T \in \mathcal{T}_h} h_T$ and let $P_k(T)$ be the space of polynomials of degree $\leq k$ over $T \in \mathcal{T}_h$, with $\*P_k(T) := P_k(T) \times P_k(T) \times P_k(T)$. Then, for $k \geq 0$, we consider the following finite element spaces:
\begin{align}
    \*Q_{k+1} &= \left\{ \*W \in \mathcal{C}(\B_0) \ : \ \*W \Big|_T \in \*P_{k+1}(T) \quad \forall \ T \in \mathcal{T}_h \right\} \\
    P_k &= \left\{ q \in L^2(\B_0) \ : \ q \Big|_T \in P_k(T) \quad \forall \ T \in \mathcal{T}_h \right\}.
\end{align}
In this way, the triplet displacement-pressure-dilation is approximated using the $\*Q_{k+1} \times P_k \times P_k$ element. For $k=1$, this implies that the displacements are approximated using quadratic 27-node Lagrange $\*Q_2$ elements, while pressures and dilations are approximated with discontinuous elements $P_1$ (based on monomials, 4 degrees of freedom per element). We omit details of the discretization of the linear system \eqref{eq:LF_linear_system} as this will be solved using the C++ finite element library \textit{deal.II} \cite{dealii}. This will be the focus of the next chapter.


\chapter{Flexodeal: a new finite-element tool for studying musculoskeletal dynamics}

\begin{enumerate}
    \item Implementation details
    \item Convergence
    \item Nonlinear Solvers
    \item Different muscle architectures (e.g. bi-pennate)
\end{enumerate}

\chapter{Gearing in muscle tissues: a first-of-its-kind computational study}

From paper w/ James. Add different pennations. Cedar access?



\chapter{Conclusions and future work}


%   BACK MATTER  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   References and appendices. Appendices come after the bibliography and
%   should be in the order that they are referred to in the text.
%
%   If you include figures, etc. in an appendix, be sure to use
%
%       \caption[]{...}
%
%   to make sure they are not listed in the List of Figures.
%

\backmatter%
    \addtoToC{Bibliography}
    \bibliographystyle{siam}
    \bibliography{references}

\begin{appendices} % optional

\chapter{Force relationships} \label{app:force_relationships}

Describe in detail force-length and force-velocity relationships in use.
Github repository: force-relationships

\chapter{Strain energies}

Include all strain energies: base material, ecm, cellular material, fat, aponeurosis/tendon.

\end{appendices}
\end{document}
